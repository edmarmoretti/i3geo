if(!Array.prototype.map)Array.prototype.map=function(f,o){var n=this.length;var result=new Array(n);for(var i=0;i<n;i++){if(i in this){result[i]=f.call(o,this[i],i,this)}}return result};if(!Array.prototype.filter)Array.prototype.filter=function(f,o){var n=this.length;var result=new Array();for(var i=0;i<n;i++){if(i in this){var v=this[i];if(f.call(o,v,i,this))result.push(v)}}return result};if(!Array.prototype.forEach)Array.prototype.forEach=function(f,o){var n=this.length>>>0;for(var i=0;i<n;i++){if(i in this)f.call(o,this[i],i,this)}};if(!Array.prototype.reduce)Array.prototype.reduce=function(f,v){var len=this.length;if(!len&&(arguments.length==1)){throw new Error("reduce: empty array, no initial value")}var i=0;if(arguments.length<2){while(true){if(i in this){v=this[i++];break}if(++i>=len){throw new Error("reduce: no values, no initial value")}}}for(;i<len;i++){if(i in this){v=f(v,this[i],i,this)}}return v};var pv={};pv.version={major:3,minor:3};pv.identity=function(x){return x};pv.index=function(){return this.index};pv.child=function(){return this.childIndex};pv.parent=function(){return this.parent.index};pv.extend=Object.create?function(f){return Object.create(f.prototype||f)}:function(f){function g(){}g.prototype=f.prototype||f;return new g()};pv.parse=function(js){var re=new RegExp("function\\s*(\\b\\w+)?\\s*\\([^)]*\\)\\s*","mg"),m,d,i=0,s="";while(m=re.exec(js)){var j=m.index+m[0].length;if(js.charAt(j)!='{'){s+=js.substring(i,j)+"{return ";i=j;for(var p=0;p>=0&&j<js.length;j++){var c=js.charAt(j);switch(c){case'"':case'\'':{while(++j<js.length&&(d=js.charAt(j))!=c){if(d=='\\')j++}break}case'[':case'(':p++;break;case']':case')':p--;break;case';':case',':if(p==0)p--;break}}s+=pv.parse(js.substring(i,--j))+";}";i=j}re.lastIndex=j}s+=js.substring(i);return s};pv.css=function(e,p){return window.getComputedStyle?window.getComputedStyle(e,null).getPropertyValue(p):e.currentStyle[p]};pv.error=function(e){(typeof console==="undefined"||!console.error)?alert(e):console.error(e)};pv.listen=function(target,type,listener){if(type==='load'||type==='onload'){return pv.listenForPageLoad(pv.listener(listener))}listener=pv.listener(listener);target.addEventListener?target.addEventListener(type,listener,false):target.attachEvent('on'+type,listener);return listener};pv.unlisten=function(target,type,listener){if(listener.$listener){listener=listener.$listener}target.removeEventListener?target.removeEventListener(type,listener,false):target.detachEvent('on'+type,listener)};pv.listener=function(f){return f.$listener||(f.$listener=function(e){try{if(e.pageX==null&&e.clientX!=null){var eventDoc=(e.target&&e.target.ownerDocument)||document;var doc=eventDoc.documentElement;var body=eventDoc.body;e.pageX=(e.clientX*1)+(doc&&doc.scrollLeft||body&&body.scrollLeft||0)-(doc&&doc.clientLeft||body&&body.clientLeft||0);e.pageY=(e.clientY*1)+(doc&&doc.scrollTop||body&&body.scrollTop||0)-(doc&&doc.clientTop||body&&body.clientTop||0)}pv.event=e;return f.call(this,e)}catch(ex){pv.error(ex)}finally{delete pv.event}})};pv.ancestor=function(a,e){while(e){if(e==a)return true;e=e.parentNode}return false};pv.getWindow=function(elem){return(elem!=null&&elem==elem.window)?elem:elem.nodeType===9?elem.defaultView||elem.parentWindow:false};pv.elementOffset=function(elem){var docElem,body,win,clientTop,clientLeft,scrollTop,scrollLeft,box={top:0,left:0},doc=elem&&elem.ownerDocument;if(!doc){return}body=doc.body;if(body===elem){return}docElem=doc.documentElement;if(typeof elem.getBoundingClientRect!=="undefined"){box=elem.getBoundingClientRect()}win=pv.getWindow(doc);clientTop=docElem.clientTop||body.clientTop||0;clientLeft=docElem.clientLeft||body.clientLeft||0;scrollTop=win.pageYOffset||docElem.scrollTop;scrollLeft=win.pageXOffset||docElem.scrollLeft;return{top:box.top+scrollTop-clientTop,left:box.left+scrollLeft-clientLeft}};pv.listenForPageLoad=function(listener){if(document.readyState==="complete"){listener()}if(pv.renderer()=="svgweb"){window.addEventListener("SVGLoad",listener,false)}else{if(document.addEventListener){window.addEventListener("load",listener,false)}else if(document.attachEvent){window.attachEvent("onload",listener)}}};pv.renderer=function(){var renderer=(typeof document.svgImplementation!=="undefined")?document.svgImplementation:(typeof window.svgweb==="undefined")?"nativesvg":"svgweb";pv.renderer=function(){return renderer};return renderer};pv.id=function(){var id=1;return function(){return id++}}();pv.functor=function(v){return typeof v=="function"?v:function(){return v}};pv.get=function(o,p,dv){var v;return o&&(v=o[p])!=null?v:dv};if(pv.renderer()!=="batik"){pv.listen(window,"load",function(){pv.$={i:0,x:document.getElementsByTagName("script")};pv.$.xlen=pv.$.x.length;for(;pv.$.i<pv.$.xlen;pv.$.i++){pv.$.s=pv.$.x[pv.$.i];if(pv.$.s.type=="text/javascript+protovis"){try{window.eval(pv.parse(pv.$.s.text))}catch(e){pv.error(e)}}}delete pv.$})}pv.Format={};pv.Format.re=function(s){return s.replace(/[\\\^\$\*\+\?\[\]\(\)\.\{\}]/g,"\\$&")};pv.Format.pad=function(c,n,s){var m=n-String(s).length;return(m<1)?s:new Array(m+1).join(c)+s};pv.Format.date=function(pattern){var pad=pv.Format.pad;function format(d){return pattern.replace(/%[a-zA-Z0-9]/g,function(s){switch(s){case'%a':return["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];case'%A':return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][d.getDay()];case'%h':case'%b':return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][d.getMonth()];case'%B':return["January","February","March","April","May","June","July","August","September","October","November","December"][d.getMonth()];case'%c':return d.toLocaleString();case'%C':return pad("0",2,Math.floor(d.getFullYear()/100)%100);case'%d':return pad("0",2,d.getDate());case'%x':case'%D':return pad("0",2,d.getMonth()+1)+"/"+pad("0",2,d.getDate())+"/"+pad("0",2,d.getFullYear()%100);case'%e':return pad(" ",2,d.getDate());case'%H':return pad("0",2,d.getHours());case'%I':{var h=d.getHours()%12;return h?pad("0",2,h):12}case'%m':return pad("0",2,d.getMonth()+1);case'%M':return pad("0",2,d.getMinutes());case'%n':return"\n";case'%p':return d.getHours()<12?"AM":"PM";case'%T':case'%X':case'%r':{var h=d.getHours()%12;return(h?pad("0",2,h):12)+":"+pad("0",2,d.getMinutes())+":"+pad("0",2,d.getSeconds())+" "+(d.getHours()<12?"AM":"PM")}case'%R':return pad("0",2,d.getHours())+":"+pad("0",2,d.getMinutes());case'%S':return pad("0",2,d.getSeconds());case'%Q':return pad("0",3,d.getMilliseconds());case'%t':return"\t";case'%u':{var w=d.getDay();return w?w:1}case'%w':return d.getDay();case'%y':return pad("0",2,d.getFullYear()%100);case'%Y':return d.getFullYear();case'%%':return"%"}return s})}format.format=format;format.parse=function(s){var year=1970,month=0,date=1,hour=0,minute=0,second=0;var fields=[function(){}];var re=pv.Format.re(pattern).replace(/%[a-zA-Z0-9]/g,function(s){switch(s){case'%b':{fields.push(function(x){month={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11}[x]});return"([A-Za-z]+)"}case'%h':case'%B':{fields.push(function(x){month={January:0,February:1,March:2,April:3,May:4,June:5,July:6,August:7,September:8,October:9,November:10,December:11}[x]});return"([A-Za-z]+)"}case'%e':case'%d':{fields.push(function(x){date=x});return"([0-9]+)"}case'%I':case'%H':{fields.push(function(x){hour=x});return"([0-9]+)"}case'%m':{fields.push(function(x){month=x-1});return"([0-9]+)"}case'%M':{fields.push(function(x){minute=x});return"([0-9]+)"}case'%p':{fields.push(function(x){if(hour==12){if(x=="am")hour=0}else if(x=="pm"){hour=Number(hour)+12}});return"(am|pm)"}case'%S':{fields.push(function(x){second=x});return"([0-9]+)"}case'%y':{fields.push(function(x){x=Number(x);year=x+(((0<=x)&&(x<69))?2000:(((x>=69)&&(x<100)?1900:0)))});return"([0-9]+)"}case'%Y':{fields.push(function(x){year=x});return"([0-9]+)"}case'%%':{fields.push(function(){});return"%"}}return s});var match=s.match(re);if(match)match.forEach(function(m,i){fields[i](m)});return new Date(year,month,date,hour,minute,second)};return format};pv.Format.time=function(type){var pad=pv.Format.pad;function format(t){t=Number(t);switch(type){case"short":{if(t>=31536e6){return(t/31536e6).toFixed(1)+" years"}else if(t>=6048e5){return(t/6048e5).toFixed(1)+" weeks"}else if(t>=864e5){return(t/864e5).toFixed(1)+" days"}else if(t>=36e5){return(t/36e5).toFixed(1)+" hours"}else if(t>=6e4){return(t/6e4).toFixed(1)+" minutes"}return(t/1e3).toFixed(1)+" seconds"}case"long":{var a=[],s=((t%6e4)/1e3)>>0,m=((t%36e5)/6e4)>>0;a.push(pad("0",2,s));if(t>=36e5){var h=((t%864e5)/36e5)>>0;a.push(pad("0",2,m));if(t>=864e5){a.push(pad("0",2,h));a.push(Math.floor(t/864e5).toFixed())}else{a.push(h.toFixed())}}else{a.push(m.toFixed())}return a.reverse().join(":")}}}format.format=format;format.parse=function(s){switch(type){case"short":{var re=/([0-9,.]+)\s*([a-z]+)/g,a,t=0;while(a=re.exec(s)){var f=parseFloat(a[0].replace(",","")),u=0;switch(a[2].toLowerCase()){case"year":case"years":u=31536e6;break;case"week":case"weeks":u=6048e5;break;case"day":case"days":u=864e5;break;case"hour":case"hours":u=36e5;break;case"minute":case"minutes":u=6e4;break;case"second":case"seconds":u=1e3;break}t+=f*u}return t}case"long":{var a=s.replace(",","").split(":").reverse(),t=0;if(a.length)t+=parseFloat(a[0])*1e3;if(a.length>1)t+=parseFloat(a[1])*6e4;if(a.length>2)t+=parseFloat(a[2])*36e5;if(a.length>3)t+=parseFloat(a[3])*864e5;return t}}}return format};pv.Format.number=function(){var mini=0,maxi=Infinity,mins=0,minf=0,maxf=0,maxk=1,padi="0",padf="0",padg=true,decimal=".",group=",",np="\u2212",ns="";function format(x){if(Infinity>maxf)x=Math.round(x*maxk)/maxk;var s=String(Math.abs(x)).split(".");var i=s[0];if(i.length>maxi)i=i.substring(i.length-maxi);if(padg&&(i.length<mini))i=new Array(mini-i.length+1).join(padi)+i;if(i.length>3)i=i.replace(/\B(?=(?:\d{3})+(?!\d))/g,group);if(!padg&&(i.length<mins))i=new Array(mins-i.length+1).join(padi)+i;s[0]=x<0?np+i+ns:i;var f=s[1]||"";if(f.length>maxf){f=s[1]=f.substr(0,maxf)}if(f.length<minf)s[1]=f+new Array(minf-f.length+1).join(padf);return s.join(decimal)}format.format=format;format.parse=function(x){var re=pv.Format.re;var s=String(x).split(decimal);if(s.length==1)s[1]="";s[0].replace(new RegExp("^("+re(padi)+")*"),"");s[1].replace(new RegExp("("+re(padf)+")*$"),"")var i=s[0].replace(new RegExp(re(group),"g"),"");if(i.length>maxi)i=i.substring(i.length-maxi);var f=s[1]?Number("0."+s[1]):0;if(Infinity>maxf)f=Math.round(f*maxk)/maxk;return Math.round(i)+f};format.integerDigits=function(min,max){if(arguments.length){mini=Number(min);maxi=(arguments.length>1)?Number(max):mini;mins=mini+Math.floor(mini/3)*group.length;return this}return[mini,maxi]};format.fractionDigits=function(min,max){if(arguments.length){minf=Number(min);maxf=(arguments.length>1)?Number(max):minf;maxk=Math.pow(10,maxf);return this}return[minf,maxf]};format.integerPad=function(x){if(arguments.length){padi=String(x);padg=/\d/.test(padi);return this}return padi};format.fractionPad=function(x){if(arguments.length){padf=String(x);return this}return padf};format.decimal=function(x){if(arguments.length){decimal=String(x);return this}return decimal};format.group=function(x){if(arguments.length){group=x?String(x):"";mins=mini+Math.floor(mini/3)*group.length;return this}return group};format.negativeAffix=function(x,y){if(arguments.length){np=String(x||"");ns=String(y||"");return this}return[np,ns]};return format};(function(){var _cache;pv.Text={};pv.Text.createCache=function(){return new FontSizeCache()};pv.Text.usingCache=function(cache,fun,ctx){if(!(cache instanceof FontSizeCache)){throw new Error("Not a valid cache.")}var prevCache=_cache;_cache=cache;try{return fun.call(ctx)}finally{_cache=prevCache}};pv.Text.measure=function(text,font){if(text==null){text=""}else{text=""+text}var bbox=_cache&&_cache.get(font,text);if(!bbox){if(!text){bbox={width:0,height:0}}else{bbox=this.measureCore(text,font)}if(_cache){_cache.put(font,text,bbox)}}return bbox};pv.Text.fontHeight=function(font){return pv.Text.measure('M',font).height};pv.Text.measureCore=(function(){var _svgText,_svgTextFont;function createTextSizePlaceholder(){var div=document.createElement('div');div.id='pvSVGText_'+new Date().getTime();var style=div.style;style.position='absolute';style.visibility='hidden';style.width=0;style.height=0;style.left=0;style.top=0;document.body.appendChild(div);return div}return function(text,font){if(!_svgText){var holder=createTextSizePlaceholder();var svgElem=pv.SvgScene.create('svg');svgElem.setAttribute('font-size','10px');svgElem.setAttribute('font-family','sans-serif');_svgText=pv.SvgScene.create('text');svgElem.appendChild(_svgText);holder.appendChild(svgElem)}if(!font){font=null}if(_svgTextFont!==font){_svgTextFont=font;pv.SvgScene.setStyle(_svgText,{'font':font})}var textNode=_svgText.firstChild;if(textNode){textNode.nodeValue=''+text}else{if(pv.renderer()==="svgweb"){_svgText.appendChild(document.createTextNode(''+text,true))}else{_svgText.appendChild(document.createTextNode(''+text))}}var box=_svgText.getBBox();return{width:box.width,height:box.height}}}());var FontSizeCache=function(){this._fontsCache={}};var hasOwnProp=Object.prototype.hasOwnProperty;FontSizeCache.prototype._getFont=function(font){font=font||'';return hasOwnProp.call(this._fontsCache,font)?this._fontsCache[font]:(this._fontsCache[font]={})};FontSizeCache.prototype.get=function(font,text){text=text||'';var fontCache=this._getFont(font);return hasOwnProp.call(fontCache,text)?fontCache[text]:null};FontSizeCache.prototype.put=function(font,text,size){return this._getFont(font)[text||'']=size}}());pv.map=function(array,f){var o={};return f?array.map(function(d,i){o.index=i;return f.call(o,d)}):array.slice()};pv.repeat=function(array,n){if(arguments.length==1)n=2;return pv.blend(pv.range(n).map(function(){return array}))};pv.array=function(len,dv){var a=len>=0?new Array(len):[];if(dv!==undefined){for(var i=0;i<len;i++){a[i]=dv}}return a};pv.cross=function(a,b){var array=[];for(var i=0,n=a.length,m=b.length;i<n;i++){for(var j=0,x=a[i];j<m;j++){array.push([x,b[j]])}}return array};pv.blend=function(arrays){return Array.prototype.concat.apply([],arrays)};pv.transpose=function(arrays){var n=arrays.length,m=pv.max(arrays,function(d){return d.length});if(m>n){arrays.length=m;for(var i=n;i<m;i++){arrays[i]=new Array(n)}for(var i=0;i<n;i++){for(var j=i+1;j<m;j++){var t=arrays[i][j];arrays[i][j]=arrays[j][i];arrays[j][i]=t}}}else{for(var i=0;i<m;i++){arrays[i].length=n}for(var i=0;i<n;i++){for(var j=0;j<i;j++){var t=arrays[i][j];arrays[i][j]=arrays[j][i];arrays[j][i]=t}}}arrays.length=m;for(var i=0;i<m;i++){arrays[i].length=n}return arrays};pv.normalize=function(array,f){var norm=pv.map(array,f),sum=pv.sum(norm);for(var i=0;i<norm.length;i++)norm[i]/=sum;return norm};pv.permute=function(array,indexes,f){if(!f)f=pv.identity;var p=new Array(indexes.length),o={};indexes.forEach(function(j,i){o.index=j;p[i]=f.call(o,array[j])});return p};pv.numerate=function(keys,f){if(!f)f=pv.identity;var map={},o={};keys.forEach(function(x,i){o.index=i;map[f.call(o,x)]=i});return map};pv.uniq=function(array,f){if(!f)f=pv.identity;var map={},keys=[],o={},y;array.forEach(function(x,i){o.index=i;y=f.call(o,x);if(!(y in map))map[y]=keys.push(y)});return keys};pv.naturalOrder=function(a,b){return(a<b)?-1:((a>b)?1:0)};pv.reverseOrder=function(b,a){return(a<b)?-1:((a>b)?1:0)};pv.search=function(array,value,f){if(!f)f=pv.identity;var low=0,high=array.length-1;while(low<=high){var mid=(low+high)>>1,midValue=f(array[mid]);if(midValue<value)low=mid+1;else if(midValue>value)high=mid-1;else return mid}return-low-1};pv.search.index=function(array,value,f){var i=pv.search(array,value,f);return(i<0)?(-i-1):i};pv.range=function(start,stop,step){if(arguments.length==1){stop=start;start=0}if(step==undefined)step=1;if((stop-start)/step==Infinity)throw new Error("range must be finite");var array=[],i=0,j;stop-=(stop-start)*1e-10;if(step<0){while((j=start+step*i++)>stop){array.push(j)}}else{while((j=start+step*i++)<stop){array.push(j)}}return array};pv.random=function(start,stop,step){if(arguments.length==1){stop=start;start=0}if(step==undefined)step=1;return step?(Math.floor(Math.random()*(stop-start)/step)*step+start):(Math.random()*(stop-start)+start)};pv.sum=function(array,f){var o={};return array.reduce(f?function(p,d,i){o.index=i;return p+f.call(o,d)}:function(p,d){return p+d},0)};pv.max=function(array,f){if(f==pv.index)return array.length-1;return Math.max.apply(null,f?pv.map(array,f):array)};pv.max.index=function(array,f){if(!array.length)return-1;if(f==pv.index)return array.length-1;if(!f)f=pv.identity;var maxi=0,maxx=-Infinity,o={};for(var i=0;i<array.length;i++){o.index=i;var x=f.call(o,array[i]);if(x>maxx){maxx=x;maxi=i}}return maxi};pv.min=function(array,f){if(f==pv.index)return 0;return Math.min.apply(null,f?pv.map(array,f):array)};pv.min.index=function(array,f){if(!array.length)return-1;if(f==pv.index)return 0;if(!f)f=pv.identity;var mini=0,minx=Infinity,o={};for(var i=0;i<array.length;i++){o.index=i;var x=f.call(o,array[i]);if(x<minx){minx=x;mini=i}}return mini};pv.mean=function(array,f){return pv.sum(array,f)/array.length};pv.median=function(array,f){if(f==pv.index)return(array.length-1)/2;array=pv.map(array,f).sort(pv.naturalOrder);if(array.length%2)return array[Math.floor(array.length/2)];var i=array.length/2;return(array[i-1]+array[i])/2};pv.variance=function(array,f){if(array.length<1)return NaN;if(array.length==1)return 0;var mean=pv.mean(array,f),sum=0,o={};if(!f)f=pv.identity;for(var i=0;i<array.length;i++){o.index=i;var d=f.call(o,array[i])-mean;sum+=d*d}return sum};pv.deviation=function(array,f){return Math.sqrt(pv.variance(array,f)/(array.length-1))};pv.log=function(x,b){return Math.log(x)/Math.log(b)};pv.logSymmetric=function(x,b){return(x==0)?0:((x<0)?-pv.log(-x,b):pv.log(x,b))};pv.logAdjusted=function(x,b){if(!isFinite(x))return x;var negative=x<0;if(x<b)x+=(b-x)/b;return negative?-pv.log(x,b):pv.log(x,b)};pv.logFloor=function(x,b){return(x>0)?Math.pow(b,Math.floor(pv.log(x,b))):-Math.pow(b,-Math.floor(-pv.log(-x,b)))};pv.logCeil=function(x,b){return(x>0)?Math.pow(b,Math.ceil(pv.log(x,b))):-Math.pow(b,-Math.ceil(-pv.log(-x,b)))};(function(){var radians=Math.PI/180,degrees=180/Math.PI;pv.radians=function(degrees){return radians*degrees};pv.degrees=function(radians){return degrees*radians}})();pv.keys=function(map){var array=[];for(var key in map){array.push(key)}return array};pv.entries=function(map){var array=[];for(var key in map){array.push({key:key,value:map[key]})}return array};pv.values=function(map){var array=[];for(var key in map){array.push(map[key])}return array};pv.dict=function(keys,f){var m={},o={};for(var i=0;i<keys.length;i++){if(i in keys){var k=keys[i];o.index=i;m[k]=f.call(o,k)}}return m};pv.hasOwnProp=Object.prototype.hasOwnProperty;pv.copyOwn=function(a,b){if(b){var hop=pv.hasOwnProp;for(var p in b){if(hop.call(b,p)){a[p]=b[p]}}}return a};pv.dom=function(map){return new pv.Dom(map)};pv.Dom=function(map){this.$map=map};pv.Dom.prototype.$leaf=function(n){return typeof n!="object"};pv.Dom.prototype.leaf=function(f){if(arguments.length){this.$leaf=f;return this}return this.$leaf};pv.Dom.prototype.root=function(nodeName){var leaf=this.$leaf,root=recurse(this.$map);function recurse(map){var n=new pv.Dom.Node();for(var k in map){var v=map[k];n.appendChild(leaf(v)?new pv.Dom.Node(v):recurse(v)).nodeName=k}return n}root.nodeName=nodeName;return root};pv.Dom.prototype.nodes=function(){return this.root().nodes()};pv.Dom.Node=function(value){if(value!==undefined){this.nodeValue=value}this.childNodes=[]};pv.Dom.Node.prototype.nodeValue=undefined;pv.Dom.Node.prototype.parentNode=null;pv.Dom.Node.prototype.firstChild=null;pv.Dom.Node.prototype.lastChild=null;pv.Dom.Node.prototype.previousSibling=null;pv.Dom.Node.prototype.nextSibling=null;pv.Dom.Node.prototype._firstDirtyChildIndex=Infinity;pv.Dom.Node.prototype.removeChild=function(n){var i=this.childNodes.indexOf(n);if(i===-1)throw new Error("child not found");return this.removeAt(i)};pv.Dom.Node.prototype.appendChild=function(n){var pn=n.parentNode;if(pn)pn.removeChild(n);var lc=this.lastChild;n.parentNode=this;n.previousSibling=lc;if(lc){lc.nextSibling=n;n._childIndex=lc._childIndex+1}else{this.firstChild=n;n._childIndex=0}this.lastChild=n;this.childNodes.push(n);return n};pv.Dom.Node.prototype.insertBefore=function(n,r){if(!r)return this.appendChild(n);var ns=this.childNodes;var i=ns.indexOf(r);if(i===-1)throw new Error("child not found");return this.insertAt(n,i)};pv.Dom.Node.prototype.insertAt=function(n,i){if(i==null){return this.appendChild(n)}var ns=this.childNodes;var L=ns.length;if(i===L){return this.appendChild(n)}if(i>L){throw new Error("Index out of range.")}var ni=i+1;var firstDirtyIndex=this._firstDirtyChildIndex;if(ni<firstDirtyIndex){this._firstDirtyChildIndex=ni}var pn=n.parentNode;if(pn){pn.removeChild(n)}var r=ns[i];n.parentNode=this;n.nextSibling=r;n._childIndex=i;var psib=n.previousSibling=r.previousSibling;if(psib){psib.nextSibling=n}else{if(r===this.lastChild){this.lastChild=n}this.firstChild=n}this.childNodes.splice(i,0,n);return n};pv.Dom.Node.prototype.removeAt=function(i){var ns=this.childNodes;var n=ns[i];if(n){ns.splice(i,1);if(i<ns.length){var firstDirtyIndex=this._firstDirtyChildIndex;if(i<firstDirtyIndex){this._firstDirtyChildIndex=i}}var psib=n.previousSibling;if(psib){psib.nextSibling=n.nextSibling}else{this.firstChild=n.nextSibling}var nsib=n.nextSibling;if(nsib){nsib.previousSibling=n.previousSibling}else{this.lastChild=n.previousSibling}delete n.nextSibling;delete n.previousSibling;delete n.parentNode}return n};pv.Dom.Node.prototype.replaceChild=function(n,r){var ns=this.childNodes;var i=ns.indexOf(r);if(i===-1)throw new Error("child not found");var pn=n.parentNode;if(pn)pn.removeChild(n);n.parentNode=this;n.nextSibling=r.nextSibling;n._childIndex=r._childIndex;var psib=n.previousSibling=r.previousSibling;if(psib)psib.nextSibling=n;else this.firstChild=n;var nsib=r.nextSibling;if(nsib)nsib.previousSibling=n;else this.lastChild=n;ns[i]=n;return r};pv.Dom.Node.prototype.childIndex=function(){var p=this.parentNode;if(p){var i=p._firstDirtyChildIndex;if(i<Infinity){var ns=p.childNodes;if(i<ns.length){for(var c=ns[i];c;c=c.nextSibling){c._childIndex=i++}}delete p._firstDirtyChildIndex}return this._childIndex}return-1};pv.Dom.Node.prototype.visitBefore=function(f){function visit(n,i){f(n,i);for(var c=n.firstChild;c;c=c.nextSibling){visit(c,i+1)}}visit(this,0)};pv.Dom.Node.prototype.visitAfter=function(f){function visit(n,i){for(var c=n.firstChild;c;c=c.nextSibling){visit(c,i+1)}f(n,i)}visit(this,0)};pv.Dom.Node.prototype.sort=function(f){if(this.firstChild){delete p._firstDirtyChildIndex;this.childNodes.sort(f);var p=this.firstChild=this.childNodes[0],c;delete p.previousSibling;p._childIndex=0;for(var i=1;i<this.childNodes.length;i++){p.sort(f);c=this.childNodes[i];c._childIndex=i;c.previousSibling=p;p=p.nextSibling=c}this.lastChild=p;delete p.nextSibling;p.sort(f)}return this};pv.Dom.Node.prototype.reverse=function(){var childNodes=[];this.visitAfter(function(n){while(n.lastChild)childNodes.push(n.removeChild(n.lastChild));for(var c;c=childNodes.pop();)n.insertBefore(c,n.firstChild)});return this};pv.Dom.Node.prototype.nodes=function(){var array=[];function flatten(node){array.push(node);node.childNodes.forEach(flatten)}flatten(this,array);return array};pv.Dom.Node.prototype.toggle=function(recursive){if(recursive)return this.toggled?this.visitBefore(function(n){if(n.toggled)n.toggle()}):this.visitAfter(function(n){if(!n.toggled)n.toggle()});var n=this;if(n.toggled){for(var c;c=n.toggled.pop();)n.appendChild(c);delete n.toggled}else if(n.lastChild){n.toggled=[];while(n.lastChild)n.toggled.push(n.removeChild(n.lastChild))}};pv.nodes=function(values){var root=new pv.Dom.Node();for(var i=0;i<values.length;i++){root.appendChild(new pv.Dom.Node(values[i]))}return root.nodes()};pv.tree=function(array){return new pv.Tree(array)};pv.Tree=function(array){this.array=array};pv.Tree.prototype.keys=function(k){this.k=k;return this};pv.Tree.prototype.value=function(v){this.v=v;return this};pv.Tree.prototype.map=function(){var map={},o={};for(var i=0;i<this.array.length;i++){o.index=i;var value=this.array[i],keys=this.k.call(o,value),node=map;for(var j=0;j<keys.length-1;j++){node=node[keys[j]]||(node[keys[j]]={})}node[keys[j]]=this.v?this.v.call(o,value):value}return map};pv.nest=function(array){return new pv.Nest(array)};pv.Nest=function(array){this.array=array;this.keys=[]};pv.Nest.prototype.key=function(key){this.keys.push(key);return this};pv.Nest.prototype.sortKeys=function(order){this.keys[this.keys.length-1].order=order||pv.naturalOrder;return this};pv.Nest.prototype.sortValues=function(order){this.order=order||pv.naturalOrder;return this};pv.Nest.prototype.map=function(){var map={},values=[];for(var i,j=0;j<this.array.length;j++){var x=this.array[j];var m=map;for(i=0;i<this.keys.length-1;i++){var k=this.keys[i](x);if(!m[k])m[k]={};m=m[k]}k=this.keys[i](x);if(!m[k]){var a=[];values.push(a);m[k]=a}m[k].push(x)}if(this.order){for(var i=0;i<values.length;i++){values[i].sort(this.order)}}return map};pv.Nest.prototype.entries=function(){function entries(map){var array=[];for(var k in map){var v=map[k];array.push({key:k,values:(v instanceof Array)?v:entries(v)})};return array}function sort(array,i){var o=this.keys[i].order;if(o)array.sort(function(a,b){return o(a.key,b.key)});if(++i<this.keys.length){for(var j=0;j<array.length;j++){sort.call(this,array[j].values,i)}}return array}return sort.call(this,entries(this.map()),0)};pv.Nest.prototype.rollup=function(f){function rollup(map){for(var key in map){var value=map[key];if(value instanceof Array){map[key]=f(value)}else{rollup(value)}}return map}return rollup(this.map())};pv.flatten=function(map){return new pv.Flatten(map)};pv.Flatten=function(map){this.map=map;this.keys=[]};pv.Flatten.prototype.key=function(key,f){this.keys.push({name:key,value:f});delete this.$leaf;return this};pv.Flatten.prototype.leaf=function(f){this.keys.length=0;this.$leaf=f;return this};pv.Flatten.prototype.array=function(){var entries=[],stack=[],keys=this.keys,leaf=this.$leaf;if(leaf){function recurse(value,i){if(leaf(value)){entries.push({keys:stack.slice(),value:value})}else{for(var key in value){stack.push(key);recurse(value[key],i+1);stack.pop()}}}recurse(this.map,0);return entries}function visit(value,i){if(i<keys.length-1){for(var key in value){stack.push(key);visit(value[key],i+1);stack.pop()}}else{entries.push(stack.concat(value))}}visit(this.map,0);return entries.map(function(stack){var m={};for(var i=0;i<keys.length;i++){var k=keys[i],v=stack[i];m[k.name]=k.value?k.value.call(null,v):v}return m})};pv.Transform=function(){};pv.Transform.prototype={k:1,x:0,y:0};pv.Transform.identity=new pv.Transform();pv.Transform.prototype.translate=function(x,y){var v=new pv.Transform();v.k=this.k;v.x=this.k*x+this.x;v.y=this.k*y+this.y;return v};pv.Transform.prototype.scale=function(k){var v=new pv.Transform();v.k=this.k*k;v.x=this.x;v.y=this.y;return v};pv.Transform.prototype.invert=function(){var v=new pv.Transform(),k=1/this.k;v.k=k;v.x=-this.x*k;v.y=-this.y*k;return v};pv.Transform.prototype.times=function(m){var v=new pv.Transform();v.k=this.k*m.k;v.x=this.k*m.x+this.x;v.y=this.k*m.y+this.y;return v};pv.Scale=function(){};pv.Scale.interpolator=function(start,end){if(typeof start=="number"){return function(t){return t*(end-start)+start}}var startGradient=(start.type&&start.type!=='solid');var endGradient=(end.type&&end.type!=='solid');if(startGradient||endGradient){start=startGradient?start:pv.color(start).rgb();end=endGradient?end:pv.color(end).rgb();return function(t){return t<0.5?start:end}}start=pv.color(start).rgb();end=pv.color(end).rgb();return function(t){var a=start.a*(1-t)+end.a*t;if(a<1e-5)a=0;return(start.a==0)?pv.rgb(end.r,end.g,end.b,a):((end.a==0)?pv.rgb(start.r,start.g,start.b,a):pv.rgb(Math.round(start.r*(1-t)+end.r*t),Math.round(start.g*(1-t)+end.g*t),Math.round(start.b*(1-t)+end.b*t),a))}};pv.Scale.common={by:function(f){var scale=this;function by(){return scale(f.apply(this,arguments))}for(var method in scale)by[method]=scale[method];return by},by1:function(f){var scale=this;function by1(x){return scale(f.call(this,x))}for(var method in scale)by1[method]=scale[method];return by1},transform:function(t){var scale=this;function transfScale(){return t.call(this,scale.apply(scale,arguments))}for(var method in scale)transfScale[method]=scale[method];return transfScale}};pv.Scale.quantitative=function(){var d=[0,1],l=[0,1],r=[0,1],i=[pv.identity],type=Number,n=false,f=pv.identity,g=pv.identity,tickFormat=String,tickFormatter=null,dateTickFormat,dateTickPrecision,usedDateTickPrecision,usedNumberExponent;function newDate(x){return new Date(x)}function scale(x){var j=pv.search(d,x);if(j<0)j=-j-2;j=Math.max(0,Math.min(i.length-1,j));return i[j]((f(x)-l[j])/(l[j+1]-l[j]))}scale.transform=function(forward,inverse){f=function(x){return n?-forward(-x):forward(x)};g=function(y){return n?-inverse(-y):inverse(y)};l=d.map(f);return this};scale.domain=function(array,min,max){if(arguments.length){var o;if(array instanceof Array){if(arguments.length<2)min=pv.identity;if(arguments.length<3)max=min;o=array.length&&min(array[0]);d=array.length?[pv.min(array,min),pv.max(array,max)]:[]}else{o=array;d=Array.prototype.slice.call(arguments).map(Number)}if(!d.length)d=[-Infinity,Infinity];else if(d.length==1)d=[d[0],d[0]];n=(d[0]||d[d.length-1])<0;l=d.map(f);type=(o instanceof Date)?newDate:Number;return this}return d.map(type)};scale.range=function(){if(arguments.length){r=Array.prototype.slice.call(arguments);if(!r.length)r=[-Infinity,Infinity];else if(r.length==1)r=[r[0],r[0]];i=[];for(var j=0;j<r.length-1;j++){i.push(pv.Scale.interpolator(r[j],r[j+1]))}return this}return r};scale.invert=function(y){var j=pv.search(r,y);if(j<0)j=-j-2;j=Math.max(0,Math.min(i.length-1,j));return type(g(l[j]+(y-r[j])/(r[j+1]-r[j])*(l[j+1]-l[j])))};scale.ticks=function(m,options){var start=d[0],end=d[d.length-1],reverse=end<start,min=reverse?end:start,max=reverse?start:end,span=max-min;if(!span||!isFinite(span)){if(type==newDate)tickFormat=pv.Format.date("%x");return[type(min)]}if(type==newDate){function floor(d,p){switch(p){case 31536e6:d.setMonth(0);case 2592e6:d.setDate(1);case 6048e5:if(p==6048e5)d.setDate(d.getDate()-d.getDay());case 864e5:d.setHours(0);case 36e5:d.setMinutes(0);case 6e4:d.setSeconds(0);case 1e3:d.setMilliseconds(0)}}var nn=5;var precision,format,increment,step=1;if(span>=nn*31536e6){precision=31536e6;format="%Y";increment=function(d){d.setFullYear(d.getFullYear()+step)}}else if(span>=nn*2592e6){precision=2592e6;format="%m/%Y";increment=function(d){d.setMonth(d.getMonth()+step)}}else if(span>=nn*6048e5){precision=6048e5;format="%m/%d";increment=function(d){d.setDate(d.getDate()+7*step)}}else if(span>=nn*864e5){precision=864e5;format="%m/%d";increment=function(d){d.setDate(d.getDate()+step)}}else if(span>=nn*36e5){precision=36e5;format="%I:%M %p";increment=function(d){d.setHours(d.getHours()+step)}}else if(span>=nn*6e4){precision=6e4;format="%I:%M %p";increment=function(d){d.setMinutes(d.getMinutes()+step)}}else if(span>=nn*1e3){precision=1e3;format="%I:%M:%S";increment=function(d){d.setSeconds(d.getSeconds()+step)}}else{precision=1;format="%S.%Qs";increment=function(d){d.setTime(d.getTime()+step)}}precision=dateTickPrecision?dateTickPrecision:precision;format=dateTickFormat?dateTickFormat:format;usedDateTickPrecision=precision;tickFormat=pv.Format.date(format);var date=new Date(min),dates=[];floor(date,precision);var n=span/precision;if(n>10){switch(precision){case 36e5:{step=(n>20)?6:3;date.setHours(Math.floor(date.getHours()/step)*step);break}case 2592e6:{step=(n>24)?3:((n>12)?2:1);date.setMonth(Math.floor(date.getMonth()/step)*step);break}case 6048e5:{step=(n>15)?3:(n>10?2:1);date.setDate(Math.floor(date.getDate()/(7*step))*(7*step));break}case 864e5:{step=(n>=30)?5:((n>=15)?3:2);date.setDate(Math.floor(date.getDate()/step)*step);break}case 6e4:{step=(n>30)?15:((n>15)?10:5);date.setMinutes(Math.floor(date.getMinutes()/step)*step);break}case 1e3:{step=(n>90)?15:((n>60)?10:5);date.setSeconds(Math.floor(date.getSeconds()/step)*step);break}case 1:{step=(n>1000)?250:((n>200)?100:((n>100)?50:((n>50)?25:5)));date.setMilliseconds(Math.floor(date.getMilliseconds()/step)*step);break}default:{step=pv.logCeil(n/15,10);if(n/step<2)step/=5;else if(n/step<5)step/=2;date.setFullYear(Math.floor(date.getFullYear()/step)*step);break}}}if(dateTickPrecision){step=1;increment=function(d){d.setSeconds(d.getSeconds()+step*dateTickPrecision/1000)}}while(true){increment(date);if(date>max)break;dates.push(new Date(date))}return reverse?dates.reverse():dates}if(m==null){m=10}var roundInside=pv.get(options,'roundInside',true);var exponentMin=pv.get(options,'numberExponentMin',-Infinity);var exponentMax=pv.get(options,'numberExponentMax',+Infinity);var exponent=Math.floor(pv.log(span/m,10));var overflow=false;if(exponent>exponentMax){exponent=exponentMax;overflow=true}else if(exponent<exponentMin){exponent=exponentMin;overflow=true}step=Math.pow(10,exponent);var mObtained=(span/step);var err=m/mObtained;if(err<=.15&&exponent<exponentMax-1){step*=10}else if(err<=.35){step*=5}else if(err<=.75){step*=2}exponent=Math.floor(pv.log(step,10)+1e-10);start=step*Math[roundInside?'ceil':'floor'](min/step);end=step*Math[roundInside?'floor':'ceil'](max/step);usedNumberExponent=Math.max(0,-exponent);tickFormat=pv.Format.number().fractionDigits(usedNumberExponent);var ticks=pv.range(start,end+step,step);if(reverse){ticks.reverse()}ticks.roundInside=roundInside;ticks.step=step;ticks.exponent=exponent;ticks.exponentOverflow=overflow;ticks.exponentMin=exponentMin;ticks.exponentMax=exponentMax;return ticks};scale.dateTickFormat=function(){if(arguments.length){dateTickFormat=arguments[0];return this}return dateTickFormat};scale.dateTickPrecision=function(){if(arguments.length){dateTickPrecision=arguments[0];return this}return dateTickPrecision};scale.tickFormatter=function(f){if(arguments.length){tickFormatter=f;return this}return tickFormatter};scale.tickFormat=function(t){if(tickFormatter){return tickFormatter(t,type!==Number?usedDateTickPrecision:usedNumberExponent)}var formatter=tickFormatter||tickFormat;return formatter(t)};scale.nice=function(){if(d.length!=2)return this;var start=d[0],end=d[d.length-1],reverse=end<start,min=reverse?end:start,max=reverse?start:end,span=max-min;if(!span||!isFinite(span))return this;var step=Math.pow(10,Math.round(Math.log(span)/Math.log(10))-1);d=[Math.floor(min/step)*step,Math.ceil(max/step)*step];if(reverse)d.reverse();l=d.map(f);return this};pv.copyOwn(scale,pv.Scale.common);scale.domain.apply(scale,arguments);return scale};pv.Scale.linear=function(){var scale=pv.Scale.quantitative();scale.domain.apply(scale,arguments);return scale};pv.Scale.log=function(){var scale=pv.Scale.quantitative(1,10),b,p,log=function(x){return Math.log(x)/p},pow=function(y){return Math.pow(b,y)};scale.ticks=function(){var d=scale.domain(),n=d[0]<0,i=Math.floor(n?-log(-d[0]):log(d[0])),j=Math.ceil(n?-log(-d[1]):log(d[1])),ticks=[];if(n){ticks.push(-pow(-i));for(;i++<j;)for(var k=b-1;k>0;k--)ticks.push(-pow(-i)*k)}else{for(;i<j;i++)for(var k=1;k<b;k++)ticks.push(pow(i)*k);ticks.push(pow(i))}for(i=0;ticks[i]<d[0];i++);for(j=ticks.length;ticks[j-1]>d[1];j--);return ticks.slice(i,j)};scale.tickFormat=function(t){return t.toPrecision(1)};scale.nice=function(){var d=scale.domain();return scale.domain(pv.logFloor(d[0],b),pv.logCeil(d[1],b))};scale.base=function(v){if(arguments.length){b=Number(v);p=Math.log(b);scale.transform(log,pow);return this}return b};scale.domain.apply(scale,arguments);return scale.base(10)};pv.Scale.root=function(){var scale=pv.Scale.quantitative();scale.power=function(v){if(arguments.length){var b=Number(v),p=1/b;scale.transform(function(x){return Math.pow(x,p)},function(y){return Math.pow(y,b)});return this}return b};scale.domain.apply(scale,arguments);return scale.power(2)};pv.Scale.ordinal=function(){var d=[],i={},r=[],band=0;function scale(x){if(!(x in i))i[x]=d.push(x)-1;return r[i[x]%r.length]}scale.domain=function(array,f){if(arguments.length){array=(array instanceof Array)?((arguments.length>1)?pv.map(array,f):array):Array.prototype.slice.call(arguments);d=[];var seen={};for(var j=0;j<array.length;j++){var o=array[j];if(!(o in seen)){seen[o]=true;d.push(o)}}i=pv.numerate(d);return this}return d};scale.range=function(array,f){if(arguments.length){r=(array instanceof Array)?((arguments.length>1)?pv.map(array,f):array):Array.prototype.slice.call(arguments);if(typeof r[0]=="string")r=r.map(pv.color);r.min=r[0];r.max=r[r.length-1];return this}return r};scale.split=function(min,max){var R=max-min;var N=this.domain().length;var step=0;if(R===0){r=pv.array(N,min)}else if(N){step=(max-min)/N;r=pv.range(min+step/2,max,step)}r.min=min;r.max=max;r.step=step;return this};scale.splitBandedCenter=function(min,max,band){scale.split(min,max);if(band==null){band=1}r.band=r.step*band;r.margin=r.step-r.band;r.min=min;r.max=max;return this};scale.splitBandedFlushCenter=function(min,max,band){if(band==null){band=1}var R=(max-min),N=this.domain().length,S=0,B=0,M=0;if(R===0){r=pv.array(N,min)}else if(N){B=(R*band)/N;M=N>1?((R-N*B)/(N-1)):0;S=M+B;r=pv.range(min+B/2,max,S)}r.step=S;r.band=B;r.margin=M;r.min=min;r.max=max;return this};scale.splitFlush=function(min,max){var n=this.domain().length,step=(max-min)/(n-1);r=(n==1)?[(min+max)/2]:pv.range(min,max+step/2,step);r.min=min;r.max=max;return this};scale.splitBanded=function(min,max,band){if(arguments.length<3)band=1;if(band<0){var n=this.domain().length,total=-band*n,remaining=max-min-total,padding=remaining/(n+1);r=pv.range(min+padding,max,padding-band);r.band=-band}else{var step=(max-min)/(this.domain().length+(1-band));r=pv.range(min+step*(1-band),max,step);r.band=step*band;r.step=step;r.margin=step-r.band}r.min=min;r.max=max;return this};scale.invertIndex=function(y,noRound){var N=this.domain().length;if(N===0){return-1}var r=this.range();var R=r.max-r.min;if(R===0){return 0}var S=R/N;if(y>=r.max){return N}if(y<r.min){return 0}var i=(y-r.min)/S;return noRound?i:Math.round(i)};pv.copyOwn(scale,pv.Scale.common);scale.domain.apply(scale,arguments);return scale};pv.Scale.quantile=function(){var n=-1,j=-1,q=[],d=[],y=pv.Scale.linear();function scale(x){return y(Math.max(0,Math.min(j,pv.search.index(q,x)-1))/j)}scale.quantiles=function(x){if(arguments.length){n=Number(x);if(n<0){q=[d[0]].concat(d);j=d.length-1}else{q=[];q[0]=d[0];for(var i=1;i<=n;i++){q[i]=d[~~(i*(d.length-1)/n)]}j=n-1}return this}return q};scale.domain=function(array,f){if(arguments.length){d=(array instanceof Array)?pv.map(array,f):Array.prototype.slice.call(arguments);d.sort(pv.naturalOrder);scale.quantiles(n);return this}return d};scale.range=function(){if(arguments.length){y.range.apply(y,arguments);return this}return y.range()};pv.copyOwn(scale,pv.Scale.common);scale.domain.apply(scale,arguments);return scale};pv.histogram=function(data,f){var frequency=true;return{bins:function(ticks){var x=pv.map(data,f),bins=[];if(!arguments.length)ticks=pv.Scale.linear(x).ticks();for(var i=0;i<ticks.length-1;i++){var bin=bins[i]=[];bin.x=ticks[i];bin.dx=ticks[i+1]-ticks[i];bin.y=0}for(var i=0;i<x.length;i++){var j=pv.search.index(ticks,x[i])-1,bin=bins[Math.max(0,Math.min(bins.length-1,j))];bin.y++;bin.push(data[i])}if(!frequency)for(var i=0;i<bins.length;i++){bins[i].y/=x.length}return bins},frequency:function(x){if(arguments.length){frequency=Boolean(x);return this}return frequency}}};(function(){pv.Shape=function(){};var _k0={x:1,y:1};pv.Shape.dist2=function(v,w,k){k=k||_k0;var dx=v.x-w.x;var dy=v.y-w.y;var dx2=dx*dx;var dy2=dy*dy;return{cost:dx2+dy2,dist2:k.x*dx2+k.y*dy2}};var pi=Math.PI;var pi2=2*pi;var atan2=Math.atan2;pv.Shape.normalizeAngle=function(a){a=a%pi2;if(a<0){a+=pi2}return a};pv.Shape.atan2Norm=function(dy,dx){var a=atan2(dy,dx);if(a<0){a+=pi2}return a};pv.Shape.prototype.hasArea=function(){return true}}());(function(){var dist2=pv.Shape.dist2;var cos=Math.cos;var sin=Math.sin;var sqrt=Math.sqrt;pv.vector=function(x,y){return new Point(x,y)};pv.Vector=function(x,y){this.x=x;this.y=y};var Point=pv.Shape.Point=pv.Vector;pv.Vector.prototype=pv.extend(pv.Shape);pv.Vector.prototype.perp=function(){return new Point(-this.y,this.x)};pv.Vector.prototype.rotate=function(angle){var c=cos(angle);var s=sin(angle);return new Point(c*this.x-s*this.y,s*this.x+c*this.y)};pv.Vector.prototype.norm=function(){var l=this.length();return this.times(l?(1/l):1)};pv.Vector.prototype.length=function(){return sqrt(this.x*this.x+this.y*this.y)};pv.Vector.prototype.times=function(k){return new Point(this.x*k,this.y*k)};pv.Vector.prototype.plus=function(x,y){return(arguments.length==1)?new Point(this.x+x.x,this.y+x.y):new Point(this.x+x,this.y+y)};pv.Vector.prototype.minus=function(x,y){return(arguments.length==1)?new Point(this.x-x.x,this.y-x.y):new Point(this.x-x,this.y-y)};pv.Vector.prototype.dot=function(x,y){return(arguments.length==1)?this.x*x.x+this.y*x.y:this.x*x+this.y*y};pv.Vector.prototype.hasArea=function(){return false};pv.Vector.prototype.clone=function(){return new Point(this.x,this.y)};pv.Vector.prototype.apply=function(t){return new Point(t.x+(t.k*this.x),t.y+(t.k*this.y))};pv.Vector.prototype.intersectsRect=function(rect){return(this.x>=rect.x)&&(this.x<=rect.x2)&&(this.y>=rect.y)&&(this.y<=rect.y2)};pv.Vector.prototype.containsPoint=function(p){return(this.x===p.x)&&(this.y===p.y)};pv.Vector.prototype.points=function(){return[this]};pv.Vector.prototype.edges=function(){return[]};pv.Vector.prototype.center=function(){return this};pv.Vector.prototype.distance2=function(p,k){return dist2(this,p,k)}}());(function(){var Point=pv.Shape.Point;var dist2=pv.Shape.dist2;pv.Shape.Line=function(x,y,x2,y2){this.x=x||0;this.y=y||0;this.x2=x2||0;this.y2=y2||0};var Line=pv.Shape.Line;Line.prototype=pv.extend(pv.Shape);Line.prototype.hasArea=function(){return false};Line.prototype.clone=function(){return new Line(this.x,this.y,this.x2,this.x2)};Line.prototype.apply=function(t){var x=t.x+(t.k*this.x);var y=t.y+(t.k*this.y);var x2=t.x+(t.k*this.x2);var y2=t.y+(t.k*this.y2);return new Line(x,y,x2,y2)};Line.prototype.points=function(){return[new Point(this.x,this.y),new Point(this.x2,this.y2)]};Line.prototype.edges=function(){return[this]};Line.prototype.center=function(){return new Point((this.x+this.x2)/2,(this.y+this.y2)/2)};Line.prototype.normal=function(at,shapeCenter){var points=this.points();var norm=points[1].minus(points[0]).perp().norm();if(shapeCenter){var outside=points[0].minus(shapeCenter);if(outside.dot(norm)<0){norm=norm.times(-1)}}return norm};Line.prototype.intersectsRect=function(rect){var i,L;var points=this.points();L=points.length;for(i=0;i<L;i++){if(points[i].intersectsRect(rect)){return true}}var edges=rect.edges();L=edges.length;for(i=0;i<L;i++){if(this.intersectsLine(edges[i])){return true}}return false};Line.prototype.containsPoint=function(p){var x=this.x;var x2=this.x2;var y=this.y;var y2=this.y2;return x<=p.x&&p.x<=x2&&((x===x2)?(Math.min(y,y2)<=p.y&&p.y<=Math.max(y,y2)):(Math.abs((y2-y)/(x2-x)*(p.x-x)+y-p.y)<=1e-10))};Line.prototype.intersectsLine=function(b){var a=this,x21=a.x2-a.x,y21=a.y2-a.y,x43=b.x2-b.x,y43=b.y2-b.y,denom=y43*x21-x43*y21;if(denom===0){return false}var y13=a.y-b.y,x13=a.x-b.x,numa=(x43*y13-y43*x13),numb=(x21*y13-y21*x13);if(denom===0){return(numa===0)&&(numb===0)}var ua=numa/denom;if(ua<0||ua>1){return false}var ub=numb/denom;if(ub<0||ub>1){return false}return true};Line.prototype.distance2=function(p,k){var v=this;var w={x:this.x2,y:this.y2};var l2=dist2(v,w).dist2;if(l2<=1e-10){return dist2(p,v,k)}var wvx=w.x-v.x;var wvy=w.y-v.y;var t=((p.x-v.x)*wvx+(p.y-v.y)*wvy)/l2;if(t<0){return dist2(p,v,k)}if(t>1){return dist2(p,w,k)}var proj={x:v.x+t*wvx,y:v.y+t*wvy};return dist2(p,proj,k)}}());(function(){var Point=pv.Shape.Point;var Line=pv.Shape.Line;pv.Shape.Polygon=function(points){this._points=points||[]};var Polygon=pv.Shape.Polygon;Polygon.prototype=pv.extend(pv.Shape);Polygon.prototype.points=function(){return this._points};Polygon.prototype.clone=function(){return new Polygon(this.points().slice())};Polygon.prototype.apply=function(t){var points=this.points();var L=points.length;var points2=new Array(L);for(var i=0;i<L;i++){points2[i]=points[i].apply(t)}return new Polygon(points2)};Polygon.prototype.intersectsRect=function(rect){var i,L;var points=this.points();L=points.length;for(i=0;i<L;i++){if(points[i].intersectsRect(rect)){return true}}var edges=this.edges();L=edges.length;for(i=0;i<L;i++){if(edges[i].intersectsRect(rect)){return true}}return false};Polygon.prototype.edges=function(){var edges=this._edges;if(!edges){edges=this._edges=[];var points=this.points();var L=points.length;if(L){var prevPoint=points[0];var firstPoint=prevPoint;var point;for(var i=1;i<L;i++){point=points[i];edges.push(new Line(prevPoint.x,prevPoint.y,point.x,point.y));prevPoint=point}if(L>2){edges.push(new Line(point.x,point.y,firstPoint.x,firstPoint.y))}}}return edges};Polygon.prototype.distance2=function(p,k){var min={cost:Infinity,dist2:Infinity};this.edges().forEach(function(edge){var d=edge.distance2(p,k);if(d.cost<min.cost){min=d}},this);return min};Polygon.prototype.center=function(){var points=this.points();var x=0;var y=0;for(var i=0,L=points.length;i<L;i++){var p=points[i];x+=p.x;y+=p.y}return new Point(x/L,y/L)};Polygon.prototype.containsPoint=function(p){var bbox=this.bbox();if(!bbox.containsPoint(p)){return false}var e=bbox.dx*0.01;var ray=new Line(bbox.x-e,p.y,p.x,p.y);var intersectCount=0;var edges=this.edges();edges.forEach(function(edge){if(edge.intersectsLine(ray)){intersectCount++}});return(intersectCount&1)===1};Polygon.prototype.bbox=function(){var bbox=this._bbox;if(!bbox){var min,max;this.points().forEach(function(point,index){if(min==null){min={x:point.x,y:point.y}}else{if(point.x<min.x){min.x=point.x}if(point.y<min.y){min.y=point.y}}if(max==null){max={x:point.x,y:point.y}}else{if(point.x>max.x){max.x=point.x}if(point.y>max.y){max.y=point.y}}});if(min){bbox=this._bbox=new pv.Shape.Rect(min.x,min.y,max.x-min.x,max.y-min.y)}}return bbox}}());(function(){var Point=pv.Shape.Point;var Line=pv.Shape.Line;pv.Shape.Rect=function(x,y,dx,dy){this.x=x||0;this.y=y||0;this.dx=dx||0;this.dy=dy||0;if(this.dx<0){this.dx=-this.dx;this.x=this.x-this.dx}if(this.dy<0){this.dy=-this.dy;this.y=this.y-this.dy}this.x2=this.x+this.dx;this.y2=this.y+this.dy};var Rect=pv.Shape.Rect;Rect.prototype=pv.extend(pv.Shape.Polygon);Rect.prototype.clone=function(){var r2=Object.create(Rect.prototype);r2.x=this.x;r2.y=this.y;r2.dx=this.dx;r2.dy=this.dy;r2.x2=this.x2;r2.y2=this.y2;return r2};Rect.prototype.apply=function(t){var x=t.x+(t.k*this.x);var y=t.y+(t.k*this.y);var dx=t.k*this.dx;var dy=t.k*this.dy;return new Rect(x,y,dx,dy)};Rect.prototype.containsPoint=function(p){return this.x<=p.x&&p.x<=this.x2&&this.y<=p.y&&p.y<=this.y2};Rect.prototype.intersectsRect=function(rect){return(this.x2>rect.x)&&(this.x<rect.x2)&&(this.y2>rect.y)&&(this.y<rect.y2)};Rect.prototype.edges=function(){if(!this._edges){var x=this.x,y=this.y,x2=this.x2,y2=this.y2;this._edges=[new Line(x,y,x2,y),new Line(x2,y,x2,y2),new Line(x2,y2,x,y2),new Line(x,y2,x,y)]}return this._edges};Rect.prototype.center=function(){return new Point(this.x+this.dx/2,this.y+this.dy/2)};Rect.prototype.points=function(){var points=this._points;if(!points){var x=this.x,y=this.y,x2=this.x2,y2=this.y2;points=this._points=[new Point(x,y),new Point(x2,y),new Point(x2,y2),new Point(x,y2)]}return points};Rect.prototype.bbox=function(){return this.clone()}}());(function(){var Point=pv.Shape.Point;var dist2=pv.Shape.dist2;var sqrt=Math.sqrt;var abs=Math.abs;var pow=Math.pow;pv.Shape.Circle=function(x,y,radius){this.x=x||0;this.y=y||0;this.radius=radius||0};var Circle=pv.Shape.Circle;Circle.prototype=pv.extend(pv.Shape);Circle.prototype.clone=function(){return new Circle(this.x,this.y,this.radius)};Circle.prototype.apply=function(t){var x=t.x+(t.k*this.x);var y=t.y+(t.k*this.y);var r=t.k*this.radius;return new Circle(x,y,r)};Circle.prototype.intersectsRect=function(rect){var dx2=rect.dx/2,dy2=rect.dy/2,r=this.radius;var circleDistX=abs(this.x-rect.x-dx2),circleDistY=abs(this.y-rect.y-dy2);if((circleDistX>dx2+r)||(circleDistY>dy2+r)){return false}if(circleDistX<=dx2||circleDistY<=dy2){return true}var sqCornerDistance=pow(circleDistX-dx2,2)+pow(circleDistY-dy2,2);return sqCornerDistance<=r*r};Circle.prototype.intersectLine=function(line,isInfiniteLine){var baX=line.x2-line.x;var baY=line.y2-line.y;var caX=this.x-line.x;var caY=this.y-line.y;var ba2=baX*baX+baY*baY;var bBy2=baX*caX+baY*caY;var r=this.radius;var c=caX*caX+caY*caY-r*r;var pBy2=bBy2/ba2;var disc=pBy2*pBy2-c/ba2;if(disc<0){return}var discSqrt=sqrt(disc);var t1=pBy2-discSqrt;var t2=pBy2+discSqrt;var ps=[];if(isInfiniteLine||(t1>=0&&t1<=1)){ps.push(new Point(line.x+baX*t1,line.y+baY*t1))}if(disc!==0){if(isInfiniteLine||(t2>=0&&t2<=1)){ps.push(new Point(line.x+baX*t2,line.y+baY*t2))}}return ps};Circle.prototype.points=function(){return[this.center()]};Circle.prototype.center=function(){return new Point(this.x,this.y)};Circle.prototype.normal=function(at){return at.minus(this.x,this.y).norm()};Circle.prototype.containsPoint=function(p){var dx=p.x-this.x,dy=p.y-this.y,r=this.radius;return dx*dx+dy*dy<=r*r};Circle.prototype.distance2=function(p,k){var dx=p.x-this.x,dy=p.y-this.y,r=this.radius;var b=p.minus(this).norm().times(r).plus(this);var dBorder=dist2(p,b,k);return dBorder}}());(function(){var Point=pv.Shape.Point;var dist2=pv.Shape.dist2;var normalizeAngle=pv.Shape.normalizeAngle;var atan2Norm=pv.Shape.atan2Norm;var cos=Math.cos;var sin=Math.sin;var sqrt=Math.sqrt;pv.Shape.Arc=function(x,y,radius,startAngle,angleSpan){this.x=x;this.y=y;this.radius=radius;this.startAngle=normalizeAngle(startAngle);this.angleSpan=normalizeAngle(angleSpan);this.endAngle=this.startAngle+this.angleSpan};var Arc=pv.Shape.Arc;Arc.prototype=pv.extend(pv.Shape);Arc.prototype.hasArea=function(){return false};Arc.prototype.clone=function(){var arc=Object.create(Arc.prototype);var me=this;arc.x=me.x;arc.y=me.y;arc.radius=me.radius;arc.startAngle=me.startAngle;arc.angleSpan=me.angleSpan;arc.endAngle=me.endAngle;return arc};Arc.prototype.apply=function(t){var x=t.x+(t.k*this.x);var y=t.y+(t.k*this.y);var r=t.k*this.radius;return new Arc(x,y,r,this.startAngle,this.angleSpan)};Arc.prototype.containsPoint=function(p){var dx=p.x-this.x;var dy=p.y-this.y;var r=sqrt(dx*dx+dy*dy);if(Math.abs(r-this.radius)<=1e-10){var a=atan2Norm(dy,dx);return this.startAngle<=a&&a<=this.endAngle}return false};Arc.prototype.intersectsRect=function(rect){var i,L;var points=this.points();var L=points.length;for(i=0;i<L;i++){if(points[i].intersectsRect(rect)){return true}}var edges=rect.edges();L=edges.length;for(i=0;i<L;i++){if(this.intersectLine(edges[i])){return true}}return false};var circleIntersectLine=pv.Shape.Circle.prototype.intersectLine;Arc.prototype.intersectLine=function(line,isInfiniteLine){var ps=circleIntersectLine.call(this,line,isInfiniteLine);if(ps){ps=ps.filter(function(p){return this.containsPoint(p)},this);if(ps.length){return ps}}};Arc.prototype.points=function(){var x=this.x;var y=this.y;var r=this.radius;var ai=this.startAngle;var af=this.endAngle;return[new Point(x+r*cos(ai),y+r*sin(ai)),new Point(x+r*cos(af),y+r*sin(af))]};Arc.prototype.center=function(){var x=this.x;var y=this.y;var r=this.radius;var am=(this.startAngle+this.endAngle)/2;return new Point(x+r*cos(am),y+r*sin(am))};Arc.prototype.normal=function(at,shapeCenter){var norm=at.minus(this.x,this.y).norm();if(shapeCenter){var outside=this.center().minus(shapeCenter);if(outside.dot(norm)<0){norm=norm.times(-1)}}return norm};Arc.prototype.distance2=function(p,k){var dx=p.x-this.x;var dy=p.y-this.y;var a=atan2Norm(dy,dx);if(this.startAngle<=a&&a<=this.endAngle){var b=new Point(this.x+this.radius*cos(a),this.y+this.radius*sin(a));return dist2(p,b,k)}var points=this.points();var d1=dist2(p,points[0],k);var d2=dist2(p,points[1],k);return d1.cost<d2.cost?d1:d2}}());(function(){var Arc=pv.Shape.Arc;var Line=pv.Shape.Line;var Point=pv.Shape.Point;var cos=Math.cos;var sin=Math.sin;var sqrt=Math.sqrt;var atan2Norm=pv.Shape.atan2Norm;var normalizeAngle=pv.Shape.normalizeAngle;pv.Shape.Wedge=function(x,y,innerRadius,outerRadius,startAngle,angleSpan){this.x=x;this.y=y;this.innerRadius=innerRadius;this.outerRadius=outerRadius;this.startAngle=normalizeAngle(startAngle);this.angleSpan=normalizeAngle(angleSpan);this.endAngle=this.startAngle+this.angleSpan};var Wedge=pv.Shape.Wedge;Wedge.prototype=pv.extend(pv.Shape);Wedge.prototype.clone=function(){return new Wedge(this.x,this.y,this.innerRadius,this.outerRadius,this.startAngle,this.angleSpan)};Wedge.prototype.apply=function(t){var x=t.x+(t.k*this.x);var y=t.y+(t.k*this.y);var ir=t.k*this.innerRadius;var or=t.k*this.outerRadius;return new Wedge(x,y,ir,or,this.startAngle,this.angleSpan)};Wedge.prototype.containsPoint=function(p){var dx=p.x-this.x;var dy=p.y-this.y;var r=sqrt(dx*dx+dy*dy);if(r>=this.innerRadius&&r<=this.outerRadius){var a=atan2Norm(dy,dx);return this.startAngle<=a&&a<=this.endAngle}return false};Wedge.prototype.intersectsRect=function(rect){var i,L;var points=this.points();L=points.length;for(i=0;i<L;i++){if(points[i].intersectsRect(rect)){return true}}points=rect.points();L=points.length;for(i=0;i<L;i++){if(this.containsPoint(points[i])){return true}}var edges=this.edges();L=edges.length;for(i=0;i<L;i++){if(edges[i].intersectsRect(rect)){return true}}return false};Wedge.prototype.points=function(){if(!this._points){this.edges()}return this._points};Wedge.prototype.edges=function(){var edges=this._edges;if(!edges){var x=this.x;var y=this.y;var ir=this.innerRadius;var or=this.outerRadius;var ai=this.startAngle;var af=this.endAngle;var aa=this.angleSpan;var cai=cos(ai);var sai=sin(ai);var caf=cos(af);var saf=sin(af);var pii,pfi;if(ir>0){pii=new Point(x+ir*cai,y+ir*sai);pfi=new Point(x+ir*caf,y+ir*saf)}else{pii=pfi=new Point(x,y)}var pio=new Point(x+or*cai,y+or*sai);var pfo=new Point(x+or*caf,y+or*saf);edges=this._edges=[];if(ir>0){edges.push(new Arc(x,y,ir,ai,aa))}edges.push(new Line(pii.x,pii.y,pio.x,pio.y),new Arc(x,y,or,ai,aa),new Line(pfi.x,pfi.y,pfo.x,pfo.y));var points=this._points=[pii,pio,pfo];if(ir>0){points.push(pfi)}}return edges};Wedge.prototype.distance2=function(p,k){var min={cost:Infinity,dist2:Infinity};this.edges().forEach(function(edge){var d=edge.distance2(p,k);if(d.cost<min.cost){min=d}});return min};Wedge.prototype.center=function(){var midAngle=(this.startAngle+this.endAngle)/2;var midRadius=(this.innerRadius+this.outerRadius)/2;return new Point(this.x+midRadius*cos(midAngle),this.y+midRadius*sin(midAngle))}}());pv.color=function(format){if(format.rgb)return format.rgb();var m1=/([a-z]+)\((.*)\)/i.exec(format);if(m1){var m2=m1[2].split(","),a=1;switch(m1[1]){case"hsla":case"rgba":{a=parseFloat(m2[3]);if(!a)return pv.Color.transparent;break}}switch(m1[1]){case"hsla":case"hsl":{var h=parseFloat(m2[0]),s=parseFloat(m2[1])/100, l=parseFloat(m2[2])/100; return(new pv.Color.Hsl(h,s,l,a)).rgb()}case"rgba":case"rgb":{function parse(c){var f=parseFloat(c);return(c[c.length-1]=='%')?Math.round(f*2.55):f}var r=parse(m2[0]),g=parse(m2[1]),b=parse(m2[2]);return pv.rgb(r,g,b,a)}}}var named=pv.Color.names[format];if(named)return named;if(format.charAt(0)=="#"){var r,g,b;if(format.length==4){r=format.charAt(1);r+=r;g=format.charAt(2);g+=g;b=format.charAt(3);b+=b}else if(format.length==7){r=format.substring(1,3);g=format.substring(3,5);b=format.substring(5,7)}return pv.rgb(parseInt(r,16),parseInt(g,16),parseInt(b,16),1)}return new pv.Color(format,1)};pv.Color=function(color,opacity){this.color=color;this.opacity=opacity;this.key="solid "+color+" alpha("+opacity+")"};pv.Color.prototype.hsl=function(){return this.rgb().hsl()};pv.Color.prototype.brighter=function(k){return this.rgb().brighter(k)};pv.Color.prototype.darker=function(k){return this.rgb().darker(k)};pv.rgb=function(r,g,b,a){return new pv.Color.Rgb(r,g,b,(arguments.length==4)?a:1)};pv.Color.Rgb=function(r,g,b,a){pv.Color.call(this,a?("rgb("+r+","+g+","+b+")"):"none",a);this.r=r;this.g=g;this.b=b;this.a=a};pv.Color.Rgb.prototype=pv.extend(pv.Color);pv.Color.Rgb.prototype.red=function(r){return pv.rgb(r,this.g,this.b,this.a)};pv.Color.Rgb.prototype.green=function(g){return pv.rgb(this.r,g,this.b,this.a)};pv.Color.Rgb.prototype.blue=function(b){return pv.rgb(this.r,this.g,b,this.a)};pv.Color.Rgb.prototype.alpha=function(a){return pv.rgb(this.r,this.g,this.b,a)};pv.Color.Rgb.prototype.rgb=function(){return this};pv.Color.Rgb.prototype.brighter=function(k){k=Math.pow(0.7,arguments.length?k:1);var r=this.r,g=this.g,b=this.b,i=30;if(!r&&!g&&!b)return pv.rgb(i,i,i,this.a);if(r&&(r<i))r=i;if(g&&(g<i))g=i;if(b&&(b<i))b=i;return pv.rgb(Math.min(255,Math.floor(r/k)),Math.min(255,Math.floor(g/k)),Math.min(255,Math.floor(b/k)),this.a)};pv.Color.Rgb.prototype.darker=function(k){k=Math.pow(0.7,arguments.length?k:1);return pv.rgb(Math.max(0,Math.floor(k*this.r)),Math.max(0,Math.floor(k*this.g)),Math.max(0,Math.floor(k*this.b)),this.a)};pv.Color.Rgb.prototype.hsl=function(){var r=this.r/255;var g=this.g/255;var b=this.b/255;var max=Math.max(r,g,b);var min=Math.min(r,g,b);var l=(max+min)/2;var h,s;if(max===min){h=s=0}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6}return pv.hsl(h*360,s,l,this.a)};pv.hsl=function(h,s,l,a){return new pv.Color.Hsl(h,s,l,(arguments.length==4)?a:1)};pv.Color.Hsl=function(h,s,l,a){pv.Color.call(this,"hsl("+h+","+(s*100)+"%,"+(l*100)+"%)",a);this.h=h;this.s=s;this.l=l;this.a=a};pv.Color.Hsl.prototype=pv.extend(pv.Color);pv.Color.Hsl.prototype.hsl=function(){return this};pv.Color.Hsl.prototype.hue=function(h){return pv.hsl(h,this.s,this.l,this.a)};pv.Color.Hsl.prototype.saturation=function(s){return pv.hsl(this.h,s,this.l,this.a)};pv.Color.Hsl.prototype.lightness=function(l){return pv.hsl(this.h,this.s,l,this.a)};pv.Color.Hsl.prototype.alpha=function(a){return pv.hsl(this.h,this.s,this.l,a)};pv.Color.Hsl.prototype.rgb=function(){var h=this.h,s=this.s,l=this.l;h=h%360;if(h<0)h+=360;s=Math.max(0,Math.min(s,1));l=Math.max(0,Math.min(l,1));var m2=(l<=.5)?(l*(1+s)):(l+s-l*s);var m1=2*l-m2;function v(h){if(h>360)h-=360;else if(h<0)h+=360;if(h<60)return m1+(m2-m1)*h/60;if(h<180)return m2;if(h<240)return m1+(m2-m1)*(240-h)/60;return m1}function vv(h){return Math.round(v(h)*255)}return pv.rgb(vv(h+120),vv(h),vv(h-120),this.a)};pv.Color.names={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32",transparent:pv.Color.transparent=pv.rgb(0,0,0,0)};(function(){var names=pv.Color.names;names.none=names.transparent;for(var name in names)names[name]=pv.color(names[name])})();pv.colors=function(){var scale=pv.Scale.ordinal();scale.range.apply(scale,arguments);return scale};pv.Colors={};pv.Colors.category10=function(){var scale=pv.colors("#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf");scale.domain.apply(scale,arguments);return scale};pv.Colors.category20=function(){var scale=pv.colors("#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5");scale.domain.apply(scale,arguments);return scale};pv.Colors.category19=function(){var scale=pv.colors("#9c9ede","#7375b5","#4a5584","#cedb9c","#b5cf6b","#8ca252","#637939","#e7cb94","#e7ba52","#bd9e39","#8c6d31","#e7969c","#d6616b","#ad494a","#843c39","#de9ed6","#ce6dbd","#a55194","#7b4173");scale.domain.apply(scale,arguments);return scale};(function(){pv.fillStyle=function(format){if(format.type){return format}if(format.rgb){return new pv.FillStyle.Solid(format.color,format.opacity)}var match=/^\s*([a-z\-]+)\(\s*(.*?)\s*\)\s*$/.exec(format);if(match){switch(match[1]){case"linear-gradient":return parseLinearGradient(match[2]);case"radial-gradient":return parseRadialGradient(match[2])}}return new pv.FillStyle.Solid(pv.color(format))};var keyAnglesDeg={top:0,'top right':45,right:90,'bottom right':135,bottom:180,'bottom left':225,left:270,'top left':315};function parseLinearGradient(text){var terms=parseText(text);if(!terms.length){return null}var angle=Math.PI;var keyAngle;var m,f;var term=terms[0];if(term.indexOf('to ')===0){m=/^to\s+(?:((top|bottom)(?:\s+(left|right))?)|((left|right)(?:\\s+(top|bottom))?))$/.exec(term);if(m){if(m[1]){keyAngle=m[2];if(m[3]){keyAngle+=' '+m[3]}}else{keyAngle=m[5];if(m[6]){keyAngle=m[6]+' '+keyAngle}}angle=pv.radians(keyAnglesDeg[keyAngle]);terms.shift()}}else{f=parseFloat(term);if(!isNaN(f)){angle=f;if(/^.*?deg$/.test(term)){angle=pv.radians(angle)}terms.shift()}}var stops=parseStops(terms);switch(stops.length){case 0:return null;case 1:return new pv.FillStyle.Solid(stops[0].color,1)}return new pv.FillStyle.LinearGradient(angle,stops,text)}function parseRadialGradient(text){var terms=parseText(text);if(!terms.length){return null}var stops=parseStops(terms);switch(stops.length){case 0:return null;case 1:return new pv.FillStyle.Solid(stops[0].color,1)}return new pv.FillStyle.RadialGradient(50,50,stops,text)}function parseText(text){var colorFuns={};var colorFunId=0;text=text.replace(/\b\w+?\(.*?\)/g,function($0){var id='__color'+(colorFunId++);colorFuns[id]=$0;return id});var terms=text.split(/\s*,\s*/);if(!terms.length){return null}if(colorFunId){terms.forEach(function(id,index){if(colorFuns.hasOwnProperty(id)){terms[index]=colorFuns[id]}})}return terms}function parseStops(terms){var stops=[];var minOffsetPercent=+Infinity;var maxOffsetPercent=-Infinity;var pendingOffsetStops=[];function processPendingStops(lastOffset){var count=pendingOffsetStops.length;if(count){var firstOffset=maxOffsetPercent;var step=(lastOffset-firstOffset)/(count+1);for(var i=0;i<count;i++){firstOffset+=step;pendingOffsetStops[i].offset=firstOffset}pendingOffsetStops.length=0}}var i=0;var T=terms.length;while(i<T){var term=terms[i++];var m=/^(.+?)\s*([+\-]?[e\.\d]+%)?$/i.exec(term);if(m){var stop={color:pv.color(m[1])};var offsetPercent=parseFloat(m[2]);if(isNaN(offsetPercent)){if(!stops.length){offsetPercent=0}else if(i===T){offsetPercent=Math.max(maxOffsetPercent,100)}}stops.push(stop);if(isNaN(offsetPercent)){pendingOffsetStops.push(stop)}else{stop.offset=offsetPercent;processPendingStops(offsetPercent);if(offsetPercent>maxOffsetPercent){maxOffsetPercent=offsetPercent}else if(offsetPercent<maxOffsetPercent){offsetPercent=maxOffsetPercent}if(offsetPercent<minOffsetPercent){minOffsetPercent=offsetPercent}}}}if(stops.length>=2&&(minOffsetPercent<0||maxOffsetPercent>100)){var colorDomain=[];var colorRange=[];stops.forEach(function(stop){colorDomain.push(stop.offset);colorRange.push(stop.color)});var colorScale=pv.scale.linear().domain(colorDomain).range(colorRange);if(minOffsetPercent<0){while(stops.length&&stops[0].offset<=0){stops.shift()}stops.unshift({offset:0,color:colorScale(0)})}if(maxOffsetPercent>100){while(stops.length&&stops[stops.length-1].offset>=100){stops.pop()}stops.push({offset:100,color:colorScale(100)})}}return stops}var FillStyle=pv.FillStyle=function(type){this.type=type;this.key=type};FillStyle.prototype=new pv.Color('none',1);FillStyle.prototype.rgb=function(){var color=pv.color(this.color);if(this.opacity!==color.opacity){color=color.alpha(this.opacity)}return color};var Solid=pv.FillStyle.Solid=function(color,opacity){FillStyle.call(this,'solid');if(color.rgb){this.color=color.color;this.opacity=color.opacity}else{this.color=color;this.opacity=opacity}this.key+=" "+this.color+" alpha("+this.opacity+")"};Solid.prototype=pv.extend(pv.FillStyle);Solid.prototype.alpha=function(opacity){return new Solid(this.color,opacity)};Solid.prototype.brighter=function(k){return new Solid(this.rgb().brighter(k))};Solid.prototype.darker=function(k){return new Solid(this.rgb().darker(k))};pv.FillStyle.transparent=new Solid(pv.Color.transparent);var gradient_id=0;var Gradient=pv.FillStyle.Gradient=function(type,stops){FillStyle.call(this,type);this.id=++gradient_id;this.stops=stops;if(stops.length){this.color=stops[0].color.color}this.key+=" stops("+stops.map(function(stop){var color=stop.color;return color.color+" alpha("+color.opacity+") at("+stop.offset+")"}).join(", ")+")"};Gradient.prototype=pv.extend(pv.FillStyle);Gradient.prototype.rgb=function(){return this.stops.length?this.stops[0].color:undefined};Gradient.prototype.alpha=function(opacity){return this._clone(this.stops.map(function(stop){return{offset:stop.offset,color:stop.color.alpha(opacity)}}))};Gradient.prototype.darker=function(k){return this._clone(this.stops.map(function(stop){return{offset:stop.offset,color:stop.color.darker(k)}}))};Gradient.prototype.brighter=function(k){return this._clone(this.stops.map(function(stop){return{offset:stop.offset,color:stop.color.brighter(k)}}))};var LinearGradient=pv.FillStyle.LinearGradient=function(angle,stops){Gradient.call(this,'lineargradient',stops);this.angle=angle;this.key+=" angle("+angle+")"};LinearGradient.prototype=pv.extend(Gradient);LinearGradient.prototype._clone=function(stops){return new LinearGradient(this.angle,stops)};var RadialGradient=pv.FillStyle.RadialGradient=function(cx,cy,stops){Gradient.call(this,'radialgradient',stops);this.cx=cx;this.cy=cy;this.key+=" center("+cx+","+cy+")"};RadialGradient.prototype=pv.extend(Gradient);RadialGradient.prototype._clone=function(stops){return new RadialGradient(this.cx,this.cy)}})();pv.ramp=function(start,end){var scale=pv.Scale.linear();scale.range.apply(scale,arguments);return scale};pv.Scene=pv.SvgScene={svg:"http://www.w3.org/2000/svg",xmlns:"http://www.w3.org/2000/xmlns",xlink:"http://www.w3.org/1999/xlink",xhtml:"http://www.w3.org/1999/xhtml",scale:1,events:["DOMMouseScroll","mousewheel","mousedown","mouseup","mouseover","mouseout","mousemove","click","dblclick"],implicit:{svg:{"shape-rendering":"auto","pointer-events":"painted","x":0,"y":0,"dy":0,"text-anchor":"start","transform":"translate(0,0)","fill":"none","fill-opacity":1,"stroke":"none","stroke-opacity":1,"stroke-width":1.5,"stroke-linejoin":"miter","stroke-linecap":"butt","stroke-miterlimit":8,"stroke-dasharray":"none"},css:{"font":"10px sans-serif"}}};pv.SvgScene.updateAll=function(scenes){if(scenes.length&&scenes[0].reverse&&(scenes.type!="line")&&(scenes.type!="area")){var reversed=pv.extend(scenes);for(var i=0,j=scenes.length-1;j>=0;i++,j--){reversed[i]=scenes[j]}scenes=reversed}this.removeSiblings(this[scenes.type](scenes))};pv.SvgScene.create=function(type){return document.createElementNS(this.svg,type)};pv.SvgScene.expect=function(e,type,scenes,i,attributes,style){var tagName;if(e){tagName=e.tagName;if(tagName==='defs'){e=e.nextSibling;if(e){tagName=e.tagName}}else if(tagName==='a'){e=e.firstChild}}if(e){if(tagName!==type){var n=this.create(type);e.parentNode.replaceChild(n,e);e=n}}else{e=this.create(type)}if(attributes)this.setAttributes(e,attributes);if(style)this.setStyle(e,style);return e};pv.SvgScene.setAttributes=function(e,attributes){var implicitSvg=this.implicit.svg;for(var name in attributes){var value=attributes[name];if(value==null||value==implicitSvg[name]){e.removeAttribute(name)}else{e.setAttribute(name,value)}}};pv.SvgScene.setStyle=function(e,style){var implicitCss=this.implicit.css;switch(pv.renderer()){case'batik':for(var name in style){var value=style[name];if(value==null||value==implicitCss[name]){e.removeAttribute(name)}else{e.style.setProperty(name,value)}}break;case'svgweb':for(var name in style){var value=style[name];if(value==null||value==implicitCss[name]){continue}e.style[name]=value}break;default:for(var name in style){var value=style[name];if(value==null||value==implicitCss[name]){e.style.removeProperty(name)}else{e.style[name]=value}}}};pv.SvgScene.append=function(e,scenes,index){e.$scene={scenes:scenes,index:index};e=this.title(e,scenes[index]);if(!e.parentNode)scenes.$g.appendChild(e);return e.nextSibling};pv.SvgScene.title=function(e,s){var a=e.parentNode;if(a&&(a.tagName!="a"))a=null;if(s.title){if(!a){a=this.create("a");a.setAttributeNS(this.xlink,"xlink:href","");if(e.parentNode)e.parentNode.replaceChild(a,e);a.appendChild(e)}a.setAttributeNS(this.xlink,"xlink:title",s.title);var t=null;for(var c=e.firstChild;c!=null;c=c.nextSibling){if(c.nodeName=="title"){t=c;break}}if(!t){t=this.create("title");e.appendChild(t)}else{t.removeChild(t.firstChild)}if(pv.renderer()=="svgweb"){t.appendChild(document.createTextNode(s.title,true))}else{t.appendChild(document.createTextNode(s.title))}return a}if(a)a.parentNode.replaceChild(e,a);return e};pv.SvgScene.dispatch=pv.listener(function(e){var t=e.target.$scene;if(t){var type=e.type;switch(type){case"DOMMouseScroll":type="mousewheel";e.wheel=-480*e.detail;break;case"mousewheel":e.wheel=(window.opera?12:1)*e.wheelDelta;break}if(pv.Mark.dispatch(type,t.scenes,t.index,e)){e.preventDefault()}}});pv.SvgScene.removeSiblings=function(e){while(e){var n=e.nextSibling;if(e.nodeName!=='defs'){e.parentNode.removeChild(e)}e=n}};pv.SvgScene.undefined=function(){};pv.SvgScene.removeFillStyleDefinitions=function(scenes){var results=scenes.$g.getElementsByTagName('defs');if(results.length===1){var defs;if(pv.renderer()!=="batik")defs=results[0];else defs=new cgg.element(results.item(0));var cur=defs.firstChild;while(cur){var next=cur.nextSibling;if(cur.nodeName=='linearGradient'||cur.nodeName=='radialGradient'){defs.removeChild(cur)}cur=next}}};(function(){var dashAliasMap={'-':'shortdash','.':'shortdot','-.':'shortdashdot','-..':'shortdashdotdot','. ':'dot','- ':'dash','--':'longdash','- .':'dashdot','--.':'longdashdot','--..':'longdashdotdot'};var dashMap={'shortdash':[3,1],'shortdot':[1,1],'shortdashdot':[3,1,1,1],'shortdashdotdot':[3,1,1,1,1,1],'dot':[1,3],'dash':[4,3],'longdash':[8,3],'dashdot':[4,3,1,3],'longdashdot':[8,3,1,3],'longdashdotdot':[8,3,1,3,1,3]};pv.SvgScene.isStandardDashStyle=function(dashArray){return dashMap.hasOwnProperty(dashArray)};pv.SvgScene.translateDashStyleAlias=function(dashArray){return dashAliasMap.hasOwnProperty(dashArray)?dashAliasMap[dashArray]:dashArray};pv.SvgScene.parseDasharray=function(s){var dashArray=s.strokeDasharray;if(dashArray&&dashArray!=='none'){dashArray=this.translateDashStyleAlias(dashArray);var standardDashArray=dashMap[dashArray];if(standardDashArray){dashArray=standardDashArray}else{dashArray=dashArray.split(/[\s,]+/)}var lineWidth=s.lineWidth;var lineCap=s.lineCap||'butt';var isButtCap=lineCap==='butt';dashArray=dashArray.map(function(num,index){num=+num;if(!isButtCap){if(index%2){num++}else{num-=1}}if(num<=0){num=.001}return num*lineWidth/this.scale},this).join(' ')}else{dashArray=null}return dashArray}})();(function(){var gradient_definition_id=0;function zeroRounding(x){return Math.abs(x)<=1e-12?0:x}pv.SvgScene.addFillStyleDefinition=function(scenes,fill){if(!fill.type||fill.type==='solid'){return}var isLinear=fill.type==='lineargradient';if(isLinear||fill.type==='radialgradient'){var g=scenes.$g;var results=g.getElementsByTagName('defs');var defs;if(results.length){if(pv.renderer()!=="batik")defs=results.item(0);else defs=new cgg.element(results.item(0))}else{defs=g.appendChild(this.create("defs"))}var elem;var className='__pv_gradient'+fill.id;results=undefined;if(!results){var instId='__pv_gradient'+fill.id+'_inst_'+(++gradient_definition_id);elem=defs.appendChild(this.create(isLinear?"linearGradient":"radialGradient"));elem.setAttribute("id",instId);elem.setAttribute("class",className);if(isLinear){var svgAngle=fill.angle-Math.PI/2;var diagAngle=Math.abs(svgAngle%(Math.PI/2))-Math.PI/4;var radius=Math.abs((Math.SQRT2/2)*Math.cos(diagAngle));var dirx=radius*Math.cos(svgAngle);var diry=radius*Math.sin(svgAngle);var x1=zeroRounding(0.5-dirx);var y1=zeroRounding(0.5-diry);var x2=zeroRounding(0.5+dirx);var y2=zeroRounding(0.5+diry);elem.setAttribute("x1",x1);elem.setAttribute("y1",y1);elem.setAttribute("x2",x2);elem.setAttribute("y2",y2)}else{}var stops=fill.stops;for(var i=0,S=stops.length;i<S;i++){var stop=stops[i];var stopElem=elem.appendChild(this.create("stop"));var color=stop.color;stopElem.setAttribute("offset",stop.offset+'%');stopElem.setAttribute("stop-color",color.color);stopElem.setAttribute("stop-opacity",color.opacity+'')}fill.color='url(#'+instId+')'}}}})();pv.SvgScene.pathBasis=(function(){var basis=[[1/6,2/3,1/6,0],[0,2/3,1/3,0],[0,1/3,2/3,0],[0,1/6,2/3,1/6]];function weight(w,p0,p1,p2,p3){return{x:w[0]*p0.left+w[1]*p1.left+w[2]*p2.left+w[3]*p3.left,y:w[0]*p0.top+w[1]*p1.top+w[2]*p2.top+w[3]*p3.top}}var convert=function(p0,p1,p2,p3){var b1=weight(basis[1],p0,p1,p2,p3),b2=weight(basis[2],p0,p1,p2,p3),b3=weight(basis[3],p0,p1,p2,p3);return"C"+b1.x+","+b1.y+","+b2.x+","+b2.y+","+b3.x+","+b3.y};convert.segment=function(p0,p1,p2,p3){var b0=weight(basis[0],p0,p1,p2,p3),b1=weight(basis[1],p0,p1,p2,p3),b2=weight(basis[2],p0,p1,p2,p3),b3=weight(basis[3],p0,p1,p2,p3);return["M"+b0.x+","+b0.y,"C"+b1.x+","+b1.y+","+b2.x+","+b2.y+","+b3.x+","+b3.y]};return convert})();pv.SvgScene.curveBasis=function(points,from,to){var L;if(from==null){L=points.length;from=0;to=L-1}else{L=to-from+1}if(L<=2)return"";var path="",p0=points[from],p1=p0,p2=p0,p3=points[from+1];path+=this.pathBasis(p0,p1,p2,p3);for(var i=from+2;i<=to;i++){p0=p1;p1=p2;p2=p3;p3=points[i];path+=this.pathBasis(p0,p1,p2,p3)}path+=this.pathBasis(p1,p2,p3,p3);path+=this.pathBasis(p2,p3,p3,p3);return path};pv.SvgScene.curveBasisSegments=function(points,from,to){var L;if(from==null){L=points.length;from=0;to=L-1}else{L=to-from+1}if(L<=2)return"";var paths=[],p0=points[from],p1=p0,p2=p0,p3=points[from+1],firstPath=this.pathBasis.segment(p0,p1,p2,p3);p0=p1;p1=p2;p2=p3;p3=points[from+2];firstPath[1]+=this.pathBasis(p0,p1,p2,p3);paths.push(firstPath);for(var i=from+3;i<=to;i++){p0=p1;p1=p2;p2=p3;p3=points[i];paths.push(this.pathBasis.segment(p0,p1,p2,p3))}var lastPath=this.pathBasis.segment(p1,p2,p3,p3);lastPath[1]+=this.pathBasis(p2,p3,p3,p3);paths.push(lastPath);return paths};pv.SvgScene.curveHermite=function(points,tangents,from,to){var L;if(from==null){L=points.length;from=0;to=L-1}else{L=to-from+1}var T=tangents.length;if(T<1||(L!==T&&L!==T+2)){return""}var quad=L!==T,path="",p0=points[from],p=points[from+1],t0=tangents[0],t=t0,pi=from+1;if(quad){path+="Q"+(p.left-t0.x*2/3)+","+(p.top-t0.y*2/3)+","+p.left+","+p.top;p0=points[from+1];pi=from+2}if(T>1){t=tangents[1];p=points[pi];pi++;path+="C"+(p0.left+t0.x)+","+(p0.top+t0.y)+","+(p.left-t.x)+","+(p.top-t.y)+","+p.left+","+p.top;for(var i=2;i<T;i++,pi++){p=points[pi];t=tangents[i];path+="S"+(p.left-t.x)+","+(p.top-t.y)+","+p.left+","+p.top}}if(quad){var lp=points[pi];path+="Q"+(p.left+t.x*2/3)+","+(p.top+t.y*2/3)+","+lp.left+","+lp.top}return path};pv.SvgScene.curveHermiteSegments=function(points,tangents,from,to){var L;if(from==null){L=points.length;from=0;to=L-1}else{L=to-from+1}var T=tangents.length;if(T<1||(L!==T&&L!==T+2)){return[]}var quad=L!==T,paths=[],p0=points[from],p=p0,t0=tangents[0],t=t0,pi=from+1;if(quad){p=points[from+1];paths.push(["M"+p0.left+","+p0.top,"Q"+(p.left-t.x*2/3)+","+(p.top-t.y*2/3)+","+p.left+","+p.top]);pi=from+2}for(var i=1;i<T;i++,pi++){p0=p;t0=t;p=points[pi];t=tangents[i];paths.push(["M"+p0.left+","+p0.top,"C"+(p0.left+t0.x)+","+(p0.top+t0.y)+","+(p.left-t.x)+","+(p.top-t.y)+","+p.left+","+p.top])}if(quad){var lp=points[pi];paths.push(["M"+p.left+","+p.top,"Q"+(p.left+t.x*2/3)+","+(p.top+t.y*2/3)+","+lp.left+","+lp.top])}return paths};pv.SvgScene.cardinalTangents=function(points,tension,from,to){var L;if(from==null){L=points.length;from=0;to=L-1}else{L=to-from+1}var tangents=[],a=(1-tension)/2,p0=points[from],p1=points[from+1],p2=points[from+2];for(var i=from+3;i<=to;i++){tangents.push({x:a*(p2.left-p0.left),y:a*(p2.top-p0.top)});p0=p1;p1=p2;p2=points[i]}tangents.push({x:a*(p2.left-p0.left),y:a*(p2.top-p0.top)});return tangents};pv.SvgScene.curveCardinal=function(points,tension,from,to){var L;if(from==null){L=points.length;from=0;to=L-1}else{L=to-from+1}if(L<=2)return"";return this.curveHermite(points,this.cardinalTangents(points,tension,from,to),from,to)};pv.SvgScene.curveCardinalSegments=function(points,tension,from,to){var L;if(from==null){L=points.length;from=0;to=L-1}else{L=to-from+1}if(L<=2)return"";return this.curveHermiteSegments(points,this.cardinalTangents(points,tension,from,to),from,to)};pv.SvgScene.monotoneTangents=function(points,from,to){var L;if(from==null){L=points.length;from=0;to=L-1}else{L=to-from+1}var tangents=[],d=[],m=[],dx=[],k=0,j;for(k=0;k<L-1;k++){j=from+k;var den=points[j+1].left-points[j].left;d[k]=Math.abs(den)<=1e-12?0:(points[j+1].top-points[j].top)/den}m[0]=d[0];dx[0]=points[from+1].left-points[from].left;for(k=1,j=from+k;k<L-1;k++,j++){m[k]=(d[k-1]+d[k])/2;dx[k]=(points[j+1].left-points[j-1].left)/2}m[k]=d[k-1];dx[k]=(points[j].left-points[j-1].left);for(k=0;k<L-1;k++){if(d[k]==0){m[k]=0;m[k+1]=0}}for(k=0;k<L-1;k++){if((Math.abs(m[k])<1e-5)||(Math.abs(m[k+1])<1e-5))continue;var ak=m[k]/d[k],bk=m[k+1]/d[k],s=ak*ak+bk*bk;if(s>9){var tk=3/Math.sqrt(s);m[k]=tk*ak*d[k];m[k+1]=tk*bk*d[k]}}var len;for(var i=0;i<L;i++){len=1+m[i]*m[i];tangents.push({x:dx[i]/ 3 /len,y:m[i]*dx[i]/ 3 /len})}return tangents};pv.SvgScene.curveMonotone=function(points,from,to){var L;if(from==null){L=points.length;from=0;to=L-1}else{L=to-from+1}if(L<=2)return"";return this.curveHermite(points,this.monotoneTangents(points,from,to),from,to)};pv.SvgScene.curveMonotoneSegments=function(points,from,to){var L;if(from==null){L=points.length;from=0;to=L-1}else{L=to-from+1}if(L<=2)return"";return this.curveHermiteSegments(points,this.monotoneTangents(points,from,to),from,to)};pv.SvgScene.area=function(scenes){var e=scenes.$g.firstChild;this.removeFillStyleDefinitions(scenes);var count=scenes.length;if(!count){return e}var s=scenes[0];if(s.segmented==='smart'){return this.areaSegmentedSmart(e,scenes)}if(s.segmented){return this.areaSegmentedFull(e,scenes)}return this.areaFixed(e,scenes,0,count-1,true)};pv.SvgScene.areaFixed=function(elm,scenes,from,to,addEvents){var count=to-from+1;if(count===1){return this.lineAreaDot(elm,scenes,from)}var s=scenes[from];if(!s.visible){return elm}var fill=s.fillStyle;var stroke=s.strokeStyle;if(!fill.opacity&&!stroke.opacity){return elm}this.addFillStyleDefinition(scenes,fill);this.addFillStyleDefinition(scenes,stroke);var isInterpBasis=false;var isInterpCardinal=false;var isInterpMonotone=false;var isInterpStepAfter=false;var isInterpStepBefore=false;switch(s.interpolate){case'basis':isInterpBasis=true;break;case'cardinal':isInterpCardinal=true;break;case'monotone':isInterpMonotone=true;break;case'step-after':isInterpStepAfter=true;break;case'step-before':isInterpStepBefore=true;break}var isInterpBasisCardinalOrMonotone=isInterpBasis||isInterpCardinal||isInterpMonotone;var d=[],si,sj;for(var i=from;i<=to;i++){si=scenes[i];if(!si.width&&!si.height){continue}for(var j=i+1;j<=to;j++){sj=scenes[j];if(!sj.width&&!sj.height){break}}if((i>from)&&!isInterpStepAfter){i--}if((j<=to)&&!isInterpStepBefore){j++}var fun=isInterpBasisCardinalOrMonotone&&(j-i>2)?this.areaPathCurve:this.areaPathStraight;d.push(fun.call(this,scenes,i,j-1,s));i=j-1}if(!d.length){return elm}var sop=stroke.opacity;elm=this.expect(elm,"path",scenes,from,{"shape-rendering":s.antialias?null:"crispEdges","pointer-events":addEvents?s.events:'none',"cursor":s.cursor,"d":"M"+d.join("ZM")+"Z","fill":fill.color,"fill-opacity":fill.opacity||null,"stroke":stroke.color,"stroke-opacity":sop||null,"stroke-width":sop?(s.lineWidth/this.scale):null,"stroke-linecap":s.lineCap,"stroke-linejoin":s.lineJoin,"stroke-miterlimit":s.strokeMiterLimit,"stroke-dasharray":sop?this.parseDasharray(s):null});if(s.svg)this.setAttributes(elm,s.svg);if(s.css)this.setStyle(elm,s.css);return this.append(elm,scenes,from)};pv.SvgScene.areaSegmentedSmart=function(elm,scenes){var eventsSegments=scenes.mark.$hasHandlers?[]:null;elm=this.eachLineAreaSegment(elm,scenes,function(elm,scenes,from,to){var segment=this.areaSegmentPaths(scenes,from,to);var pathsT=segment.top;var pathsB=segment.bottom;var fromp=from;if(eventsSegments){eventsSegments.push(segment)}var options={breakOnKeyChange:true,from:from,to:to};return this.eachLineAreaSegment(elm,scenes,options,function(elm,scenes,from,to){var s1=scenes[from];var fill=s1.fillStyle;var stroke=s1.strokeStyle;this.addFillStyleDefinition(scenes,fill);this.addFillStyleDefinition(scenes,stroke);if(from===to){return this.lineAreaDotAlone(elm,scenes,from)}var d=this.areaJoinPaths(pathsT,pathsB,from-fromp,to-fromp-1);var sop=stroke.opacity;var attrs={'shape-rendering':s1.antialias?null:'crispEdges','pointer-events':'none','cursor':s1.cursor,'d':d,'fill':fill.color,'fill-opacity':fill.opacity||null,'stroke':stroke.color,'stroke-opacity':sop||null,'stroke-width':sop?(s1.lineWidth/this.scale):null,'stroke-linecap':s1.lineCap,'stroke-linejoin':s1.lineJoin,'stroke-miterlimit':s1.strokeMiterLimit,'stroke-dasharray':sop?this.parseDasharray(s1):null};elm=this.expect(elm,'path',scenes,from,attrs,s1.css);return this.append(elm,scenes,from)})});if(eventsSegments){eventsSegments.forEach(function(segment){var from=segment.from;var pathsT=segment.top;var pathsB=segment.bottom;var P=pathsT.length;var attrsBase={'shape-rendering':'crispEdges','fill':'rgb(127,127,127)','fill-opacity':0.005,'stroke':null};pathsT.forEach(function(pathT,j){var i=from+j;var s=scenes[i];var events=s.events;if(events&&events!=="none"){var pathB=pathsB[P-j-1];var attrs=Object.create(attrsBase);attrs['pointer-events']=events;attrs.cursor=s.cursor;attrs.d=pathT.join("")+"L"+pathB[0].substr(1)+pathB[1]+"Z";elm=this.expect(elm,'path',scenes,i,attrs);elm=this.append(elm,scenes,i)}},this)},this)}return elm};pv.SvgScene.areaSegmentPaths=function(scenes,from,to){return this.areaSegmentCurvePaths(scenes,from,to)||this.areaSegmentStraightPaths(scenes,from,to)};pv.SvgScene.areaSegmentCurvePaths=function(scenes,from,to){var count=to-from+1;var s=scenes[from];var isBasis=s.interpolate==="basis";var isCardinal=!isBasis&&s.interpolate==="cardinal";if(isBasis||isCardinal||s.interpolate=="monotone"){var pointsT=[];var pointsB=[];for(var i=0;i<count;i++){var si=scenes[from+i];var sj=scenes[to-i];pointsT.push(si);pointsB.push({left:sj.left+sj.width,top:sj.top+sj.height})}var pathsT,pathsB;if(isBasis){pathsT=this.curveBasisSegments(pointsT);pathsB=this.curveBasisSegments(pointsB)}else if(isCardinal){pathsT=this.curveCardinalSegments(pointsT,s.tension);pathsB=this.curveCardinalSegments(pointsB,s.tension)}else{pathsT=this.curveMonotoneSegments(pointsT);pathsB=this.curveMonotoneSegments(pointsB)}if(pathsT||pathsT.length){return{from:from,top:pathsT,bottom:pathsB}}}};pv.SvgScene.areaSegmentStraightPaths=function(scenes,i,j){var pathsT=[];var pathsB=[];for(var k=j,m=i;i<k;i++,j--){var si=scenes[i],sj=scenes[j],pi=['M'+si.left+","+si.top],pj=['M'+(sj.left+sj.width)+","+(sj.top+sj.height)];var sk=scenes[i+1],sl=scenes[j-1];switch(si.interpolate){case'step-before':pi.push("V"+sk.top+"H"+sk.left);break;case'step-after':pi.push("H"+sk.left+"V"+sk.top);break;default:pi.push("L"+sk.left+","+sk.top)}pj.push("L"+(sl.left+sl.width)+","+(sl.top+sl.height));pathsT.push(pi);pathsB.push(pj)}return{from:m,top:pathsT,bottom:pathsB}};pv.SvgScene.areaJoinPaths=function(pathsT,pathsB,i,j){var fullPathT="";var fullPathB="";var N=pathsT.length;for(var k=i,l=N-1-j;k<=j;k++,l++){var pathT=pathsT[k];var pathB=pathsB[l];var dT;var dB;if(k===i){dT=pathT.join("");dB="L"+pathB[0].substr(1)+pathB[1]}else{dT=pathT[1];dB=pathB[1]}fullPathT+=dT;fullPathB+=dB}return fullPathT+fullPathB+"Z"};pv.SvgScene.areaSegmentedFull=function(e,scenes){var count=scenes.length;var pathsT,pathsB;var result=this.areaSegmentCurvePaths(scenes,0,count-1);if(result){pathsT=result.top;pathsB=result.bottom}var s=scenes[0];for(var i=0;i<count-1;i++){var s1=scenes[i];var s2=scenes[i+1];if(!s1.visible||!s2.visible){continue}var fill=s1.fillStyle;var stroke=s1.strokeStyle;if(!fill.opacity&&!stroke.opacity){continue}var d;if(pathsT){var pathT=pathsT[i].join(""),pathB="L"+pathsB[count-i-2].join("").substr(1);d=pathT+pathB+"Z"}else{var si=s1;var sj=s2;switch(s1.interpolate){case"step-before":si=s2;break;case"step-after":sj=s1;break}d="M"+s1.left+","+si.top+"L"+s2.left+","+sj.top+"L"+(s2.left+s2.width)+","+(sj.top+sj.height)+"L"+(s1.left+s1.width)+","+(si.top+si.height)+"Z"}var attrs={"shape-rendering":s1.antialias?null:"crispEdges","pointer-events":s1.events,"cursor":s1.cursor,"d":d,"fill":fill.color,"fill-opacity":fill.opacity||null,"stroke":stroke.color,"stroke-opacity":stroke.opacity||null,"stroke-width":stroke.opacity?s1.lineWidth/this.scale:null};e=this.expect(e,"path",scenes,i,attrs);if(s1.svg)this.setAttributes(e,s1.svg);if(s1.css)this.setStyle(e,s1.css);e=this.append(e,scenes,i)}return e};pv.SvgScene.areaPathStraight=function(scenes,i,j,s){var pointsT=[];var pointsB=[];for(var k=j;i<=k;i++,j--){var si=scenes[i],sj=scenes[j],pi=si.left+","+si.top,pj=(sj.left+sj.width)+","+(sj.top+sj.height);if(i<k){var sk=scenes[i+1],sl=scenes[j-1];switch(s.interpolate){case'step-before':pi+="V"+sk.top;pj+="H"+(sl.left+sl.width);break;case'step-after':pi+="H"+sk.left;pj+="V"+(sl.top+sl.height);break}}pointsT.push(pi);pointsB.push(pj)}return pointsT.concat(pointsB).join("L")};pv.SvgScene.areaPathCurve=function(scenes,i,j,s){var pointsT=[];var pointsB=[];var pathT,pathB;for(var k=j;i<=k;i++,j--){var sj=scenes[j];pointsT.push(scenes[i]);pointsB.push({left:sj.left+sj.width,top:sj.top+sj.height})}switch(s.interpolate){case'basis':pathT=this.curveBasis(pointsT);pathB=this.curveBasis(pointsB);break;case'cardinal':pathT=this.curveCardinal(pointsT,s.tension);pathB=this.curveCardinal(pointsB,s.tension);break;default:pathT=this.curveMonotone(pointsT);pathB=this.curveMonotone(pointsB)}return pointsT[0].left+","+pointsT[0].top+pathT+"L"+pointsB[0].left+","+pointsB[0].top+pathB};pv.SvgScene.minBarWidth=1;pv.SvgScene.minBarHeight=1;pv.SvgScene.minBarLineWidth=0.2;pv.SvgScene.bar=function(scenes){var e=scenes.$g.firstChild;this.removeFillStyleDefinitions(scenes);for(var i=0;i<scenes.length;i++){var s=scenes[i];if(!s.visible||Math.abs(s.width)<=1E-10||Math.abs(s.height)<=1E-10)continue;if(s.width<this.minBarWidth){s.width=this.minBarWidth}if(s.height<this.minBarHeight){s.height=this.minBarHeight}var fill=s.fillStyle,stroke=s.strokeStyle;if(!fill.opacity&&!stroke.opacity)continue;if(fill.type&&fill.type!=='solid'){this.addFillStyleDefinition(scenes,fill)}if(stroke.type&&stroke.type!='solid'){this.addFillStyleDefinition(scenes,stroke)}var lineWidth;if(stroke.opacity){lineWidth=s.lineWidth;if(lineWidth<1e-10){lineWidth=0}else{lineWidth=Math.max(this.minBarLineWidth,lineWidth/this.scale)}}else{lineWidth=null}e=this.expect(e,"rect",scenes,i,{"shape-rendering":s.antialias?null:"crispEdges","pointer-events":s.events,"cursor":s.cursor,"x":s.left,"y":s.top,"width":Math.max(1E-10,s.width),"height":Math.max(1E-10,s.height),"fill":fill.color,"fill-opacity":fill.opacity||null,"stroke":stroke.color,"stroke-opacity":stroke.opacity||null,"stroke-width":lineWidth,"stroke-linecap":s.lineCap,"stroke-dasharray":stroke.opacity?this.parseDasharray(s):null});if(s.svg)this.setAttributes(e,s.svg);if(s.css)this.setStyle(e,s.css);e=this.append(e,scenes,i)}return e};pv.SvgScene.dot=function(scenes){var e=scenes.$g.firstChild;this.removeFillStyleDefinitions(scenes);for(var i=0;i<scenes.length;i++){var s=scenes[i];if(!s.visible)continue;var fill=s.fillStyle,stroke=s.strokeStyle;if(!fill.opacity&&!stroke.opacity)continue;if(fill.type&&fill.type!=='solid'){this.addFillStyleDefinition(scenes,fill)}if(stroke.type&&stroke.type!='solid'){this.addFillStyleDefinition(scenes,stroke)}var radius=s.shapeRadius,path=null;switch(s.shape){case"cross":{path="M"+ -radius+","+ -radius+"L"+radius+","+radius+"M"+radius+","+ -radius+"L"+ -radius+","+radius;break}case"triangle":{var h=radius,w=radius*1.1547;path="M0,"+h+"L"+w+","+ -h+" "+ -w+","+ -h+"Z";break}case"diamond":{radius*=Math.SQRT2;path="M0,"+ -radius+"L"+radius+",0"+" 0,"+radius+" "+ -radius+",0"+"Z";break}case"square":{path="M"+ -radius+","+ -radius+"L"+radius+","+ -radius+" "+radius+","+radius+" "+ -radius+","+radius+"Z";break}case"tick":{path="M0,0L0,"+ -s.shapeSize;break}case"bar":{path="M0,"+(s.shapeSize/2)+"L0,"+ -(s.shapeSize/2);break}}var svg={"shape-rendering":s.antialias?null:"crispEdges","pointer-events":s.events,"cursor":s.cursor,"fill":fill.color,"fill-opacity":fill.opacity||null,"stroke":stroke.color,"stroke-opacity":stroke.opacity||null,"stroke-width":stroke.opacity?s.lineWidth/this.scale:null,"stroke-linecap":s.lineCap,"stroke-dasharray":stroke.opacity?this.parseDasharray(s):null};if(path){svg.transform="translate("+s.left+","+s.top+")";if(s.shapeAngle)svg.transform+=" rotate("+180*s.shapeAngle/Math.PI+")";svg.d=path;e=this.expect(e,"path",scenes,i,svg)}else{svg.cx=s.left;svg.cy=s.top;svg.r=radius;e=this.expect(e,"circle",scenes,i,svg)}if(s.svg)this.setAttributes(e,s.svg);if(s.css)this.setStyle(e,s.css);e=this.append(e,scenes,i)}return e};pv.SvgScene.image=function(scenes){var e=scenes.$g.firstChild;for(var i=0;i<scenes.length;i++){var s=scenes[i];if(!s.visible)continue;e=this.fill(e,scenes,i);if(s.image){e=this.expect(e,"foreignObject",scenes,i,{"cursor":s.cursor,"x":s.left,"y":s.top,"width":s.width,"height":s.height});if(s.svg)this.setAttributes(e,s.svg);if(s.css)this.setStyle(e,s.css);var c=e.firstChild||e.appendChild(document.createElementNS(this.xhtml,"canvas"));c.$scene={scenes:scenes,index:i};c.style.width=s.width;c.style.height=s.height;c.width=s.imageWidth;c.height=s.imageHeight;c.getContext("2d").putImageData(s.image,0,0)}else{e=this.expect(e,"image",scenes,i,{"preserveAspectRatio":"none","cursor":s.cursor,"x":s.left,"y":s.top,"width":s.width,"height":s.height});if(s.svg)this.setAttributes(e,s.svg);if(s.css)this.setStyle(e,s.css);e.setAttributeNS(this.xlink,"xlink:href",s.url)}e=this.append(e,scenes,i);e=this.stroke(e,scenes,i)}return e};pv.SvgScene.label=function(scenes){var e=scenes.$g.firstChild;for(var i=0;i<scenes.length;i++){var s=scenes[i];if(!s.visible)continue;var fill=s.textStyle;if(!fill.opacity||!s.text)continue;var x=0,y=0,dy=0,anchor="start";switch(s.textBaseline){case"middle":if(pv.renderer()=='svgweb')y=3;else dy=".35em";break;case"top":if(pv.renderer()=='svgweb'){y=9+s.textMargin}else{dy=".71em";y=s.textMargin}break;case"bottom":y="-"+s.textMargin;break}switch(s.textAlign){case"right":anchor="end";x="-"+s.textMargin;break;case"center":anchor="middle";break;case"left":x=s.textMargin;break}e=this.expect(e,"text",scenes,i,{"pointer-events":s.events,"cursor":s.cursor,"x":x,"y":y,"dy":dy,"transform":"translate("+s.left+","+s.top+")"+(s.textAngle?" rotate("+180*s.textAngle/Math.PI+")":"")+(this.scale!=1?" scale("+1/this.scale+")":""),"fill":fill.color,"fill-opacity":fill.opacity||null,"text-anchor":anchor},{"font":s.font,"text-shadow":s.textShadow,"text-decoration":s.textDecoration});if(s.svg)this.setAttributes(e,s.svg);if(s.css)this.setStyle(e,s.css);if(e.firstChild)e.firstChild.nodeValue=s.text;else{if(pv.renderer()=="svgweb"){e.appendChild(document.createTextNode(s.text,true))}else{e.appendChild(document.createTextNode(s.text))}}e=this.append(e,scenes,i)}return e};pv.SvgScene.line=function(scenes){var e=scenes.$g.firstChild;this.removeFillStyleDefinitions(scenes);var count=scenes.length;if(!count){return e}var s=scenes[0];if(s.segmented==='smart'){return this.lineSegmentedSmart(e,scenes)}if(count<2){return e}if(s.segmented){return this.lineSegmentedFull(e,scenes)}return this.lineFixed(e,scenes)};pv.SvgScene.lineFixed=function(elm,scenes){var count=scenes.length;if(count===1){return this.lineAreaDotAlone(elm,scenes,0)}var s=scenes[0];if(!s.visible){return elm}var fill=s.fillStyle;var stroke=s.strokeStyle;if(!fill.opacity&&!stroke.opacity){return elm}this.addFillStyleDefinition(scenes,fill);this.addFillStyleDefinition(scenes,stroke);var d="M"+s.left+","+s.top;var curveInterpolated=(count>2);if(curveInterpolated){switch(s.interpolate){case"basis":d+=this.curveBasis(scenes);break;case"cardinal":d+=this.curveCardinal(scenes,s.tension);break;case"monotone":d+=this.curveMonotone(scenes);break;default:curveInterpolated=false}}if(!curveInterpolated){for(var i=1;i<count;i++){d+=this.lineSegmentPath(scenes[i-1],scenes[i])}}var sop=stroke.opacity;var attrs={'shape-rendering':s.antialias?null:'crispEdges','pointer-events':s.events,'cursor':s.cursor,'d':d,'fill':fill.color,'fill-opacity':fill.opacity||null,'stroke':stroke.color,'stroke-opacity':sop||null,'stroke-width':sop?(s.lineWidth/this.scale):null,'stroke-linecap':s.lineCap,'stroke-linejoin':s.lineJoin,'stroke-miterlimit':s.strokeMiterLimit,'stroke-dasharray':sop?this.parseDasharray(s):null};elm=this.expect(elm,'path',scenes,0,attrs,s.css);if(s.svg)this.setAttributes(elm,s.svg);return this.append(elm,scenes,0)};pv.SvgScene.lineSegmentedSmart=function(elm,scenes){var eventsSegments=scenes.mark.$hasHandlers?[]:null;elm=this.eachLineAreaSegment(elm,scenes,function(elm,scenes,from,to){var paths=this.lineSegmentPaths(scenes,from,to);var fromp=from;if(eventsSegments){eventsSegments.push({from:from,paths:paths})}var options={breakOnKeyChange:true,from:from,to:to};return this.eachLineAreaSegment(elm,scenes,options,function(elm,scenes,from,to){var s1=scenes[from];var fill=s1.fillStyle;this.addFillStyleDefinition(scenes,fill);var stroke=s1.strokeStyle;this.addFillStyleDefinition(scenes,stroke);if(from===to){return this.lineAreaDotAlone(elm,scenes,from)}var d=this.lineJoinPaths(paths,from-fromp,to-fromp-1);var sop=stroke.opacity;var attrs={'shape-rendering':s1.antialias?null:'crispEdges','pointer-events':'none','cursor':s1.cursor,'d':d,'fill':fill.color,'fill-opacity':fill.opacity||null,'stroke':stroke.color,'stroke-opacity':sop||null,'stroke-width':sop?(s1.lineWidth/this.scale):null,'stroke-linecap':s1.lineCap,'stroke-linejoin':s1.lineJoin,'stroke-miterlimit':s1.strokeMiterLimit,'stroke-dasharray':sop?this.parseDasharray(s1):null};elm=this.expect(elm,'path',scenes,from,attrs,s1.css);return this.append(elm,scenes,from)})});if(eventsSegments){eventsSegments.forEach(function(segment){var from=segment.from;var paths=segment.paths;var attrsBase={'shape-rendering':'crispEdges','fill':'rgb(127,127,127)','fill-opacity':0.005,'stroke':'rgb(127,127,127)','stroke-opacity':0.005,'stroke-width':5};paths.forEach(function(path,j){var i=from+j;var s=scenes[i];var events=s.events;if(events&&events!=='none'){var attrs=Object.create(attrsBase);attrs['pointer-events']=events;attrs.cursor=s.cursor;attrs.d=path.join('');elm=this.expect(elm,'path',scenes,i,attrs);elm=this.append(elm,scenes,i)}},this)},this)}return elm};pv.SvgScene.lineSegmentedFull=function(e,scenes){var s=scenes[0];var paths;switch(s.interpolate){case"basis":paths=this.curveBasisSegments(scenes);break;case"cardinal":paths=this.curveCardinalSegments(scenes,s.tension);break;case"monotone":paths=this.curveMonotoneSegments(scenes);break}for(var i=0,n=scenes.length-1;i<n;i++){var s1=scenes[i],s2=scenes[i+1];if(!s1.visible||!s2.visible)continue;var stroke=s1.strokeStyle,fill=pv.FillStyle.transparent;if(!stroke.opacity)continue;var d;if((s1.interpolate=="linear")&&(s1.lineJoin=="miter")){fill=stroke;stroke=pv.FillStyle.transparent;d=this.pathJoin(scenes[i-1],s1,s2,scenes[i+2])}else if(paths){d=paths[i].join("")}else{d="M"+s1.left+","+s1.top+this.lineSegmentPath(s1,s2)}e=this.expect(e,"path",scenes,i,{"shape-rendering":s1.antialias?null:"crispEdges","pointer-events":s1.events,"cursor":s1.cursor,"d":d,"fill":fill.color,"fill-opacity":fill.opacity||null,"stroke":stroke.color,"stroke-opacity":stroke.opacity||null,"stroke-width":stroke.opacity?s1.lineWidth/this.scale:null,"stroke-linejoin":s1.lineJoin});if(s1.svg)this.setAttributes(e,s1.svg);if(s1.css)this.setStyle(e,s1.css);e=this.append(e,scenes,i)}return e};pv.SvgScene.lineSegmentPath=function(s1,s2){var l=1;switch(s1.interpolate){case"polar-reverse":l=0;case"polar":{var dx=s2.left-s1.left,dy=s2.top-s1.top,e=1-s1.eccentricity,r=Math.sqrt(dx*dx+dy*dy)/(2*e);if((e<=0)||(e>1))break;return"A"+r+","+r+" 0 0,"+l+" "+s2.left+","+s2.top}case"step-before":return"V"+s2.top+"H"+s2.left;case"step-after":return"H"+s2.left+"V"+s2.top}return"L"+s2.left+","+s2.top};pv.SvgScene.lineSegmentPaths=function(scenes,from,to){var s=scenes[from];var paths;switch(s.interpolate){case"basis":paths=this.curveBasisSegments(scenes,from,to);break;case"cardinal":paths=this.curveCardinalSegments(scenes,s.tension,from,to);break;case"monotone":paths=this.curveMonotoneSegments(scenes,from,to);break}if(!paths||!paths.length){paths=[];for(var i=from+1;i<=to;i++){var s1=scenes[i-1];var s2=scenes[i];paths.push(["M"+s1.left+","+s1.top,this.lineSegmentPath(s1,s2)])}}return paths};pv.strokeMiterLimit=4;pv.SvgScene.pathJoin=function(s0,s1,s2,s3){var pts=[];var miterLimit,miterRatio,miterLength;var w1=s1.lineWidth/this.scale;var p1=pv.vector(s1.left,s1.top);var p2=pv.vector(s2.left,s2.top);var p21=p2.minus(p1);var v21=p21.perp().norm();var w21=v21.times(w1/2);var a=p1.plus(w21);var d=p1.minus(w21);var b=p2.plus(w21);var c=p2.minus(w21);if(!s0||!s0.visible){pts.push(d,a)}else{var p0=pv.vector(s0.left,s0.top);var p10=p1.minus(p0);var v10=p10.perp().norm();var v1=v10.plus(v21).norm();var am=this.lineIntersect(p1,v1,a,p21);var dm=this.lineIntersect(p1,v1,d,p21);miterLength=am.minus(dm).length();var w0=s0.lineWidth/this.scale;var w10avg=(w1+w0)/2;miterRatio=miterLength/w10avg;miterLimit=s1.strokeMiterLimit||pv.strokeMiterLimit;if(miterRatio<=miterLimit){pts.push(dm,am)}else{var p12=p21.times(-1);var v1Outer=p10.norm().plus(p12.norm()).norm();var bevel10=p1.plus(v1Outer.times(w10avg/2));if(v1Outer.dot(v21)>=0){pts.push(dm,bevel10,a)}else{pts.push(d,bevel10,am)}}}if(!s3||!s3.visible){pts.push(b,c)}else{var p3=pv.vector(s3.left,s3.top);var p32=p3.minus(p2);var v32=p32.perp().norm();var v2=v32.plus(v21).norm();var bm=this.lineIntersect(p2,v2,b,p21);var cm=this.lineIntersect(p2,v2,c,p21);miterLength=bm.minus(cm).length();var w3=s3.lineWidth/this.scale;var w31avg=(w3+w1)/2;miterRatio=miterLength/w31avg;miterLimit=s2.strokeMiterLimit||pv.strokeMiterLimit;if(miterRatio<=miterLimit){pts.push(bm,cm)}else{var p23=p32.times(-1);var v2Outer=p21.norm().plus(p23.norm()).norm();var bevel31=p2.plus(v2Outer.times(w31avg/2));if(v2Outer.dot(v21)>=0){pts.push(b,bevel31,cm)}else{pts.push(bm,bevel31,c)}}}var pt=pts.shift();return"M"+pt.x+","+pt.y+"L"+pts.map(function(pt2){return pt2.x+","+pt2.y}).join(" ")};pv.SvgScene.lineIntersect=function(o1,d1,o2,d2){return o1.plus(d1.times(o2.minus(o1).dot(d2.perp())/d1.dot(d2.perp())))};pv.SvgScene.lineJoinPaths=function(paths,from,to){var d=paths[from].join("");for(var i=from+1;i<=to;i++){d+=paths[i][1]}return d};pv.SvgScene.lineAreaDotAlone=function(elm,scenes,i){return elm};pv.SvgScene.eachLineAreaSegment=function(elm,scenes,keyArgs,lineAreaSegment){if(typeof keyArgs==='function'){lineAreaSegment=keyArgs;keyArgs=null}var breakOnKeyChange=pv.get(keyArgs,'breakOnKeyChange',false);var from=pv.get(keyArgs,'from')||0;var to=pv.get(keyArgs,'to',scenes.length-1);var ki,kf;if(breakOnKeyChange){ki=[];kf=[]}var i=from;while(i<=to){var si=scenes[i];if(!this.isSceneVisible(si)){i++;continue}if(breakOnKeyChange){this.lineAreaSceneKey(si,ki)}var i2;var f=i;while(true){var f2=f+1;if(f2>to){i2=f2;break}var sf=scenes[f2];if(!this.isSceneVisible(sf)){i2=f2+1;break}f=f2;if(breakOnKeyChange){this.lineAreaSceneKey(sf,kf);if(!this.equalSceneKeys(ki,kf)){i2=f;break}}}elm=lineAreaSegment.call(this,elm,scenes,i,f,keyArgs);i=i2}return elm};pv.SvgScene.lineAreaSceneKey=function(s,k){k[0]=s.fillStyle.key;k[1]=s.strokeStyle.key;k[2]=s.lineWidth;k[3]=(s.strokeDasharray||'none');k[4]=s.interpolate;return k};pv.SvgScene.isSceneVisible=function(s){return s.visible&&(s.fillStyle.opacity>0||s.strokeStyle.opacity>0)};pv.SvgScene.equalSceneKeys=function(ka,kb){for(var i=0,K=ka.length;i<K;i++){if(ka[i]!==kb[i]){return false}}return true};pv.SvgScene.panel=function(scenes){var g=scenes.$g,e=g&&g.firstChild;var complete=false;for(var i=0;i<scenes.length;i++){var s=scenes[i];if(!s.visible)continue;if(!scenes.parent){if(pv.renderer()!=="batik"){s.canvas.style.display="inline-block"}if(g&&(g.parentNode!=s.canvas)){g=s.canvas.firstChild;e=g&&g.firstChild}if(!g){g=this.create(pv.renderer()!=="batik"?"svg":"g");g.setAttribute("font-size","10px");g.setAttribute("font-family","sans-serif");g.setAttribute("fill","none");g.setAttribute("stroke","none");g.setAttribute("stroke-width",1.5);g.setAttribute("style","-webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;");if(typeof g.onselectstart!=='undefined'){g.setAttribute('unselectable','on');g.onselectstart=function(){return false}}if(pv.renderer()==="svgweb"){g.setAttribute("width",s.width+s.left+s.right);g.setAttribute("height",s.height+s.top+s.bottom);var frag=document.createDocumentFragment(true);g.addEventListener('SVGLoad',function(){var me=this;(function(){if(complete){complete=false;me.appendChild(frag);for(var j=0;j<pv.Scene.events.length;j++){me.addEventListener(pv.Scene.events[j],pv.SvgScene.dispatch,false)}scenes.$g=me;scenes.$g.__ready=true}else{setTimeout(arguments.callee,10)}})()},false);svgweb.appendChild(g,s.canvas);g=frag}else{for(var j=0;j<this.events.length;j++){g.addEventListener(this.events[j],this.dispatch,false)}g=s.canvas.appendChild(g);g.__ready=true}e=g.firstChild}scenes.$g=g;if(g.__ready){g.setAttribute("width",s.width+s.left+s.right);g.setAttribute("height",s.height+s.top+s.bottom)}}if(s.overflow=="hidden"){var id=pv.id().toString(36),c=this.expect(e,"g",scenes,i,{"clip-path":"url(#"+id+")"});if(!c.parentNode)g.appendChild(c);scenes.$g=g=c;e=c.firstChild;e=this.expect(e,"clipPath",scenes,i,{"id":id});var r=e.firstChild||e.appendChild(this.create("rect"));r.setAttribute("x",s.left);r.setAttribute("y",s.top);r.setAttribute("width",s.width);r.setAttribute("height",s.height);if(!e.parentNode)g.appendChild(e);e=e.nextSibling}e=this.fill(e,scenes,i);var k=this.scale,t=s.transform,x=s.left+t.x,y=s.top+t.y;this.scale*=t.k;this.eachChild(scenes,i,function(childScenes){childScenes.$g=e=this.expect(e,"g",scenes,i,{"transform":"translate("+x+","+y+")"+(t.k!=1?" scale("+t.k+")":"")});this.updateAll(childScenes);if(!e.parentNode)g.appendChild(e);e=e.nextSibling});this.scale=k;e=this.stroke(e,scenes,i);if(s.overflow=="hidden"){scenes.$g=g=c.parentNode;e=c.nextSibling}}complete=true;return e};pv.SvgScene.eachChild=function(scenes,i,fun,ctx){if(scenes.mark.zOrderChildCount){var sorted=scenes[i].children.slice(0);sorted.sort(function(scenes1,scenes2){var compare=scenes1.mark._zOrder-scenes2.mark._zOrder;if(compare===0){compare=scenes1.childIndex-scenes2.childIndex}return compare});sorted.forEach(fun,ctx||this)}else{scenes[i].children.forEach(fun,ctx||this)}};pv.SvgScene.fill=function(e,scenes,i){this.removeFillStyleDefinitions(scenes);var s=scenes[i],fill=s.fillStyle;if(fill.opacity||s.events=="all"){if(fill.type&&fill.type!=='solid'){this.addFillStyleDefinition(scenes,fill)}e=this.expect(e,"rect",scenes,i,{"shape-rendering":s.antialias?null:"crispEdges","pointer-events":s.events,"cursor":s.cursor,"x":s.left,"y":s.top,"width":s.width,"height":s.height,"fill":fill.color,"fill-opacity":fill.opacity,"stroke":null});e=this.append(e,scenes,i)}return e};pv.SvgScene.stroke=function(e,scenes,i){var s=scenes[i],stroke=s.strokeStyle;if(stroke.opacity||s.events=="all"){e=this.expect(e,"rect",scenes,i,{"shape-rendering":s.antialias?null:"crispEdges","pointer-events":s.events=="all"?"stroke":s.events,"cursor":s.cursor,"x":s.left,"y":s.top,"width":Math.max(1E-10,s.width),"height":Math.max(1E-10,s.height),"fill":null,"stroke":stroke.color,"stroke-opacity":stroke.opacity,"stroke-width":s.lineWidth/this.scale,"stroke-linecap":s.lineCap,"stroke-dasharray":stroke.opacity?this.parseDasharray(s):null});e=this.append(e,scenes,i)}return e};pv.SvgScene.minRuleLineWidth=1;pv.SvgScene.rule=function(scenes){var e=scenes.$g.firstChild;for(var i=0;i<scenes.length;i++){var s=scenes[i];if(!s.visible)continue;var stroke=s.strokeStyle;if(!stroke.opacity)continue;var lineWidth=s.lineWidth;if(lineWidth<1e-10){lineWidth=0}else{lineWidth=Math.max(this.minRuleLineWidth,lineWidth/this.scale)}e=this.expect(e,"line",scenes,i,{"shape-rendering":s.antialias?null:"crispEdges","pointer-events":s.events,"cursor":s.cursor,"x1":s.left,"y1":s.top,"x2":s.left+s.width,"y2":s.top+s.height,"stroke":stroke.color,"stroke-opacity":stroke.opacity,"stroke-width":lineWidth,"stroke-linecap":s.lineCap,"stroke-dasharray":stroke.opacity?this.parseDasharray(s):null});if(s.svg)this.setAttributes(e,s.svg);if(s.css)this.setStyle(e,s.css);e=this.append(e,scenes,i)}return e};pv.SvgScene.wedge=function(scenes){var e=scenes.$g.firstChild;this.removeFillStyleDefinitions(scenes);for(var i=0;i<scenes.length;i++){var s=scenes[i];if(!s.visible)continue;var fill=s.fillStyle,stroke=s.strokeStyle;if(!fill.opacity&&!stroke.opacity)continue;var r1=s.innerRadius,r2=s.outerRadius,a=Math.abs(s.angle),p;if(a>=2*Math.PI){if(r1){p="M0,"+r2+"A"+r2+","+r2+" 0 1,1 0,"+(-r2)+"A"+r2+","+r2+" 0 1,1 0,"+r2+"M0,"+r1+"A"+r1+","+r1+" 0 1,1 0,"+(-r1)+"A"+r1+","+r1+" 0 1,1 0,"+r1+"Z"}else{p="M0,"+r2+"A"+r2+","+r2+" 0 1,1 0,"+(-r2)+"A"+r2+","+r2+" 0 1,1 0,"+r2+"Z"}}else{var sa=Math.min(s.startAngle,s.endAngle),ea=Math.max(s.startAngle,s.endAngle),c1=Math.cos(sa),c2=Math.cos(ea),s1=Math.sin(sa),s2=Math.sin(ea);if(r1){p="M"+r2*c1+","+r2*s1+"A"+r2+","+r2+" 0 "+((a<Math.PI)?"0":"1")+",1 "+r2*c2+","+r2*s2+"L"+r1*c2+","+r1*s2+"A"+r1+","+r1+" 0 "+((a<Math.PI)?"0":"1")+",0 "+r1*c1+","+r1*s1+"Z"}else{p="M"+r2*c1+","+r2*s1+"A"+r2+","+r2+" 0 "+((a<Math.PI)?"0":"1")+",1 "+r2*c2+","+r2*s2+"L0,0Z"}}if(fill.type&&fill.type!=='solid'){this.addFillStyleDefinition(scenes,fill)}if(stroke.type&&stroke.type!='solid'){this.addFillStyleDefinition(scenes,stroke)}e=this.expect(e,"path",scenes,i,{"shape-rendering":s.antialias?null:"crispEdges","pointer-events":s.events,"cursor":s.cursor,"transform":"translate("+s.left+","+s.top+")","d":p,"fill":fill.color,"fill-rule":"evenodd","fill-opacity":fill.opacity||null,"stroke":stroke.color,"stroke-opacity":stroke.opacity||null,"stroke-width":stroke.opacity?s.lineWidth/this.scale:null,"stroke-linejoin":s.lineJoin,"stroke-miterlimit":s.strokeMiterLimit,"stroke-linecap":s.lineCap,"stroke-dasharray":stroke.opacity?this.parseDasharray(s):null});if(s.svg)this.setAttributes(e,s.svg);if(s.css)this.setStyle(e,s.css);e=this.append(e,scenes,i)}return e};pv.Mark=function(){this.$properties=[];this.$propertiesMap={};this.$handlers={}};pv.Mark.prototype.properties={};pv.Mark.cast={};pv.Mark.prototype.property=function(name,cast){if(!this.hasOwnProperty("properties")){this.properties=pv.extend(this.properties)}this.properties[name]=true;pv.Mark.prototype.propertyMethod(name,false,pv.Mark.cast[name]=cast);return this};pv.Mark.prototype.localProperty=function(name,cast){if(!this.hasOwnProperty("properties")){this.properties=pv.extend(this.properties)}this.properties[name]=true;var currCast=pv.Mark.cast[name];if(cast){pv.Mark.cast[name]=currCast=cast}this.propertyMethod(name,false,currCast);return this};pv.Mark.prototype.propertyMethod=function(name,def,cast){if(!cast)cast=pv.Mark.cast[name];this[name]=function(v,tag){if(def&&this.scene){var defs=this.scene.defs;if(arguments.length){defs[name]={id:(v==null)?0:pv.id(),value:((v!=null)&&cast)?cast(v):v};return this}return defs[name]?defs[name].value:null}if(arguments.length){this.setPropertyValue(name,v,def,cast,false,tag);return this}var propEval=pv.propertyEval;if(propEval){var binds=this.binds;var propRead=binds.properties[name];if(propRead){var net=binds.net;var readNetIndex=net[name];if(readNetIndex==null){readNetIndex=net[name]=0}(propRead.dependents||(propRead.dependents={}))[propEval.name]=true;(pv.propertyEvalDependencies||(pv.propertyEvalDependencies={}))[name]=true;if(readNetIndex>=pv.propertyEvalNetIndex){pv.propertyEvalNetIndex=readNetIndex+1}}}return this.instance()[name]}};pv.Mark.funPropertyCaller=function(fun,cast){var stack=pv.Mark.stack;return function(){var value=fun.apply(this,stack);return value!=null?cast(value):value}};pv.Mark.prototype.setPropertyValue=function(name,v,def,cast,chain,tag){var type=!def<<1|(typeof v==="function");if(type&1&&cast){v=pv.Mark.funPropertyCaller(v,cast)}else if(v!=null&&cast){v=cast(v)}var propertiesMap=this.$propertiesMap;var properties=this.$properties;var p={name:name,id:pv.id(),value:v,type:type,tag:tag};var specified=propertiesMap[name];propertiesMap[name]=p;if(specified){for(var i=0;i<properties.length;i++){if(properties[i]===specified){properties.splice(i,1);break}}}properties.push(p);if(chain&&specified&&type===3){p.proto=specified;p.root=specified.root||specified}return p};pv.Mark.prototype.intercept=function(name,v,keyArgs){this.setPropertyValue(name,v,false,pv.get(keyArgs,'noCast')?null:pv.Mark.cast[name],true,pv.get(keyArgs,'tag'));return this};pv.Mark.prototype.propertyValue=function(name,inherit){var p=this.$propertiesMap[name];if(p){return p.value}if(inherit){if(this.proto){var value=this.proto.propertyValueRecursive(name);if(value!==undefined){return value}}return this.defaults.propertyValueRecursive(name)}};pv.Mark.prototype.propertyValueRecursive=function(name){var p=this.$propertiesMap[name];if(p){return p.value}if(this.proto){return this.proto.propertyValueRecursive(name)}};pv.Mark.stack=[];pv.Mark.prototype.property("data").property("visible",Boolean).property("css",Object).property("svg",Object).property("left",Number).property("right",Number).property("top",Number).property("bottom",Number).property("cursor",String).property("title",String).property("reverse",Boolean).property("antialias",Boolean).property("events",String).property("id",String);pv.Mark.prototype.childIndex=-1;pv.Mark.prototype.index=-1;pv.Mark.prototype.scale=1;pv.Mark.prototype._zOrder=0;pv.Mark.prototype.defaults=new pv.Mark().data(function(d){return[d]}).visible(true).antialias(true).events("painted");pv.Mark.prototype.extend=function(proto){this.proto=proto;this.target=proto.target;return this};pv.Mark.prototype.add=function(type){return this.parent.add(type).extend(this)};pv.Mark.prototype.def=function(name,v){this.propertyMethod(name,true);return this[name](arguments.length>1?v:null)};pv.Mark.prototype.zOrder=function(zOrder){if(!arguments.length){return this._zOrder}zOrder=(+zOrder)||0;if(this._zOrder!==zOrder){if(this._zOrder!==0&&this.parent){this.parent.zOrderChildCount--}this._zOrder=zOrder;if(this._zOrder!==0&&this.parent){this.parent.zOrderChildCount++}}return this};pv.Mark.prototype.anchor=function(name){if(!name)name="center";return new pv.Anchor(this).name(name).data(function(){return this.scene.target.map(function(s){return s.data})}).visible(function(){return this.scene.target[this.index].visible}).id(function(){return this.scene.target[this.index].id}).left(function(){var s=this.scene.target[this.index],w=s.width||0;switch(this.name()){case"bottom":case"top":case"center":return s.left+w/2;case"left":return null}return s.left+w}).top(function(){var s=this.scene.target[this.index],h=s.height||0;switch(this.name()){case"left":case"right":case"center":return s.top+h/2;case"top":return null}return s.top+h}).right(function(){var s=this.scene.target[this.index];return this.name()=="left"?s.right+(s.width||0):null}).bottom(function(){var s=this.scene.target[this.index];return this.name()=="top"?s.bottom+(s.height||0):null}).textAlign(function(){switch(this.name()){case"bottom":case"top":case"center":return"center";case"right":return"right"}return"left"}).textBaseline(function(){switch(this.name()){case"right":case"left":case"center":return"middle";case"top":return"top"}return"bottom"})};pv.Mark.prototype.anchorTarget=function(){return this.target};pv.Mark.prototype.margin=function(n){return this.left(n).right(n).top(n).bottom(n)};pv.Mark.prototype.instance=function(defaultIndex){var scene=this.scene||this.parent.instance(-1).children[this.childIndex],index=!arguments.length||this.hasOwnProperty("index")?this.index:defaultIndex;return scene[index<0?scene.length-1:index]};pv.Mark.prototype.instances=function(source){var mark=this,index=[],scene;while(!(scene=mark.scene)){source=source.parent;index.push({index:source.index,childIndex:mark.childIndex});mark=mark.parent}while(index.length){var i=index.pop();scene=scene[i.index].children[i.childIndex]}if(this.hasOwnProperty("index")){var s=pv.extend(scene[this.index]);s.right=s.top=s.left=s.bottom=0;return[s]}return scene};pv.Mark.prototype.first=function(){return this.scene[0]};pv.Mark.prototype.last=function(){return this.scene[this.scene.length-1]};pv.Mark.prototype.sibling=function(){return(this.index==0)?null:this.scene[this.index-1]};pv.Mark.prototype.cousin=function(){var p=this.parent,s=p&&p.sibling();return(s&&s.children)?s.children[this.childIndex][this.index]:null};pv.Mark.prototype.render=function(){if(this.parent&&!this.root.scene){this.root.render();return}this.renderCore()};pv.Mark.prototype.renderCore=function(){var parent=this.parent,stack=pv.Mark.stack;var indexes=[];for(var mark=this;mark.parent;mark=mark.parent){indexes.unshift(mark.childIndex)}function render(mark,depth,scale){mark.scale=scale;if(depth<indexes.length){stack.unshift(null);try{if(mark.hasOwnProperty("index")){renderInstance(mark,depth,scale)}else{for(var i=0,n=mark.scene.length;i<n;i++){mark.index=i;renderInstance(mark,depth,scale)}delete mark.index}}finally{stack.shift()}}else{mark.build();pv.Scene.scale=scale;var id=null;if(mark.scene&&mark.scene.$g&&mark.scene.$g.suspendRedraw)id=mark.scene.$g.suspendRedraw(1000);pv.Scene.updateAll(mark.scene);if(id)mark.scene.$g.unsuspendRedraw(id)}delete mark.scale}function renderInstance(mark,depth,scale){var s=mark.scene[mark.index],i;if(s.visible){var childIndex=indexes[depth],child=mark.children[childIndex];for(i=0;i<childIndex;i++){mark.children[i].scene=s.children[i]}stack[0]=s.data;if(child.scene){render(child,depth+1,scale*s.transform.k)}else{child.scene=s.children[childIndex];render(child,depth+1,scale*s.transform.k);delete child.scene}for(i=0;i<childIndex;i++){delete mark.children[i].scene}}}this.bind();while(parent&&!parent.hasOwnProperty("index"))parent=parent.parent;this.context(parent?parent.scene:undefined,parent?parent.index:-1,function(){render(this.root,0,1)})};pv.Mark.prototype.bind=function(){var seen={},data,required=[],types=[[],[],[],[]];function bind(mark){do{var properties=mark.$properties;for(var i=properties.length-1;i>=0;i--){var p=properties[i];var pLeaf=seen[p.name];if(!pLeaf){seen[p.name]=p;switch(p.name){case"data":data=p;break;case"visible":case"id":required.push(p);break;default:types[p.type].push(p);break}}else if(pLeaf.type===3){var pRoot=pLeaf.root;if(!pRoot){pLeaf.proto=pLeaf.root=p}else if(!pRoot.proto){pRoot.proto=p;pLeaf.root=p}}}}while(mark=mark.proto)}bind(this);bind(this.defaults);types[1].reverse();types[3].reverse();var mark=this;do{for(var name in mark.properties){if(!(name in seen)){types[2].push(seen[name]={name:name,type:2,value:null})}}}while((mark=mark.proto));var defs=types[0].concat(types[1]);for(var i=0;i<defs.length;i++){this.propertyMethod(defs[i].name,true)}this.binds={properties:seen,net:{},data:data,defs:defs,required:required,optional:pv.blend(types)}};pv.Mark.prototype.updateNet=function(pDependent,netIndex){var binds=this.binds;var props=binds.properties;var net=binds.net;propagateRecursive(pDependent,netIndex);function propagateRecursive(p,minNetIndex){if(minNetIndex>(net[p.name]||0)){net[p.name]=minNetIndex;var deps=p.dependents;if(deps){minNetIndex++;for(var depName in deps){if(deps.hasOwnProperty(depName)){var pDep=props[depName];if(pDep){propagateRecursive(pDep,minNetIndex)}}}}}}};pv.Mark.prototype.build=function(){var scene=this.scene,stack=pv.Mark.stack;if(!scene){scene=this.scene=[];scene.mark=this;scene.type=this.type;scene.childIndex=this.childIndex;if(this.parent){scene.parent=this.parent.scene;scene.parentIndex=this.parent.index}}if(this.target)scene.target=this.target.instances(scene);if(this.binds.defs.length){var defs=scene.defs;if(!defs)scene.defs=defs={};for(var i=0;i<this.binds.defs.length;i++){var p=this.binds.defs[i],d=defs[p.name];if(!d||(p.id>d.id)){defs[p.name]={id:0,value:(p.type&1)?p.value.apply(this,stack):p.value}}}}var data=this.binds.data;data=data.type&1?data.value.apply(this,stack):data.value;var markProto=pv.Mark.prototype;stack.unshift(null);try{var L=scene.length=data.length;for(var i=0;i<L;i++){markProto.index=this.index=i;var s=scene[i]||(scene[i]={});s.data=stack[0]=data[i];this.buildInstance(s)}}finally{markProto.index=-1;delete this.index;stack.shift()}return this};pv.Mark.prototype.buildProperties=function(s,properties){var stack=pv.Mark.stack;for(var i=0,n=properties.length;i<n;i++){var p=properties[i];var v;switch(p.type){case 3:var oldProtoProp=pv.propertyProto;try{pv.propertyProto=p.proto;v=p.value.apply(this,stack)}finally{pv.propertyProto=oldProtoProp}break;case 2:v=p.value;break;case 0:case 1:v=this.scene.defs[p.name].value;break}s[p.name]=v}};pv.Mark.prototype.delegate=function(dv,tag){var protoProp=pv.propertyProto;if(protoProp&&(!tag||protoProp.tag===tag)){var value=this.evalProperty(protoProp);if(value!==undefined){return value}}return dv};pv.Mark.prototype.hasDelegate=function(tag){var protoProp=pv.propertyProto;return!!protoProp&&(!tag||protoProp.tag===tag)};pv.Mark.prototype.evalProperty=function(p){switch(p.type){case 3:var oldProtoProp=pv.propertyProto;try{pv.propertyProto=p.proto;return p.value.apply(this,pv.Mark.stack)}finally{pv.propertyProto=oldProtoProp}case 2:return p.value;case 0:case 1:return this.scene.defs[p.name].value}};pv.Mark.prototype.buildPropertiesWithDepTracking=function(s,properties){var net=this.binds.net;var netIndex,newNetIndex,netDirtyProps,prevNetDirtyProps,propertyIndexes,evaluatedProps;var stack=pv.Mark.stack;var n=properties.length;try{while(true){netDirtyProps=null;evaluatedProps={};for(var i=0;i<n;i++){var p=properties[i];var name=p.name;evaluatedProps[name]=true;if(!prevNetDirtyProps||prevNetDirtyProps[name]){var v;switch(p.type){case 3:pv.propertyEval=p;pv.propertyEvalNetIndex=netIndex=(net[name]||0);pv.propertyEvalDependencies=null;var oldProtoProp=pv.propertyProto;try{pv.propertyProto=p.proto;v=p.value.apply(this,stack)}finally{pv.propertyProto=oldProtoProp}newNetIndex=pv.propertyEvalNetIndex;if(newNetIndex>netIndex){var evalDeps=pv.propertyEvalDependencies;for(var depName in evalDeps){if(evalDeps.hasOwnProperty(depName)&&!evaluatedProps.hasOwnProperty(name)){if(!netDirtyProps){netDirtyProps={}}netDirtyProps[depName]=true}}this.updateNet(p,newNetIndex)}break;case 2:v=p.value;break;case 0:case 1:v=this.scene.defs[name].value;break}s[name]=v}}if(!netDirtyProps){break}prevNetDirtyProps=netDirtyProps;propertyIndexes=pv.numerate(properties,function(p){return p.name});properties.sort(function(pa,pb){var comp=pv.naturalOrder(net[pa.name]||0,net[pb.name]||0);if(!comp){comp=pv.naturalOrder(propertyIndexes[pa.name],propertyIndexes[pb.name])}return comp});propertyIndexes=null}}finally{pv.propertyEval=null;pv.propertyEvalNetIndex=null;pv.propertyEvalDependencies=null}};pv.Mark.prototype.buildInstance=function(s){this.buildProperties(s,this.binds.required);if(s.visible){if(this.index===0){this.buildPropertiesWithDepTracking(s,this.binds.optional)}else{this.buildProperties(s,this.binds.optional)}this.buildImplied(s)}};pv.Mark.prototype.buildImplied=function(s){var l=s.left;var r=s.right;var t=s.top;var b=s.bottom;var p=this.properties;var w=p.width?s.width:0;var h=p.height?s.height:0;var instance;var checked;if(w==null||r==null||l==null){instance=this.parent?this.parent.instance():null;checked=true;var width=instance?instance.width:(w+l+r);if(w==null){w=width-(r=r||0)-(l=l||0)}else if(r==null){if(l==null){l=r=(width-w)/2}else{r=width-w-l}}else{l=width-w-r}}if(h==null||b==null||t==null){if(!checked){instance=this.parent?this.parent.instance():null}var height=instance?instance.height:(h+t+b);if(h==null){h=height-(t=t||0)-(b=b||0)}else if(b==null){if(t==null){b=t=(height-h)/2}else{b=height-h-t}}else{t=height-h-b}}s.left=l;s.right=r;s.top=t;s.bottom=b;if(p.width)s.width=w;if(p.height)s.height=h;if(p.textStyle&&!s.textStyle)s.textStyle=pv.FillStyle.transparent;if(p.fillStyle&&!s.fillStyle)s.fillStyle=pv.FillStyle.transparent;if(p.strokeStyle&&!s.strokeStyle)s.strokeStyle=pv.FillStyle.transparent};pv.Mark.prototype.mouse=function(){var n=this.root.canvas(),ev=pv.event,x=ev.pageX,y=ev.pageY;var offset=pv.elementOffset(n);if(offset){x-=offset.left;y-=offset.top;var computed=pv.getWindow(n.ownerDocument).getComputedStyle(n,null);if(computed){x-=parseFloat(computed.paddingLeft||0);y-=parseFloat(computed.paddingTop||0)}}var t=pv.Transform.identity,p=this.properties.transform?this:this.parent,pz=[];do{pz.push(p)}while((p=p.parent));while((p=pz.pop())){var pinst=p.instance();t=t.translate(pinst.left,pinst.top).times(pinst.transform)}t=t.invert();return pv.vector(x*t.k+t.x,y*t.k+t.y)};pv.Mark.prototype.event=function(type,handler){handler=pv.functor(handler);var handlers=this.$handlers[type];if(!handlers){handlers=handler}else if(handlers instanceof Array){handlers.push(handler)}else{handlers=[handlers,handler]}this.$hasHandlers=true;this.$handlers[type]=handlers;return this};pv.Mark.prototype.context=function(scene,index,f){var proto=pv.Mark.prototype,stack=pv.Mark.stack,oscene=pv.Mark.scene,oindex=proto.index;function apply(scene,index){pv.Mark.scene=scene;proto.index=index;if(!scene){return}var that=scene.mark,mark=that,ancestors=[];do{ancestors.push(mark);stack.push(scene[index].data);mark.index=index;mark.scene=scene;index=scene.parentIndex;scene=scene.parent}while(mark=mark.parent);for(var i=ancestors.length-1,k=1;i>0;i--){mark=ancestors[i];mark.scale=k;k*=mark.scene[mark.index].transform.k}var children=that.children;if(children){var thatInstance=that.scene[that.index];for(var i=0,n=children.length;i<n;i++){mark=children[i];mark.scene=thatInstance.children[i];mark.scale=k}}}function clear(scene,index){if(!scene)return;var that=scene.mark,mark;var children=that.children;if(children){for(var i=0,n=children.length;i<n;i++){mark=children[i];delete mark.scene;delete mark.scale}}mark=that;do{stack.pop();if(mark.parent){delete mark.scene;delete mark.scale}delete mark.index}while(mark=mark.parent)}if(scene&&scene===oscene&&index===oindex){try{f.apply(this,stack)}catch(ex){pv.error(ex);throw ex}finally{pv.Mark.scene=oscene;proto.index=oindex}}else{clear(oscene,oindex);apply(scene,index);try{f.apply(this,stack)}catch(ex){pv.error(ex);throw ex}finally{clear(scene,index);apply(oscene,oindex)}}};pv.Mark.getEventHandler=function(type,scenes,index,event){var handler=scenes.mark.$handlers[type];if(handler){return[handler,type,scenes,index,event]}var parentScenes=scenes.parent;if(parentScenes){return this.getEventHandler(type,parentScenes,scenes.parentIndex,event)}};pv.Mark.dispatch=function(type,scenes,index,event){var root=scenes.mark.root;if(root.animatingCount){return true}var handlerInfo;var interceptors=root.$interceptors&&root.$interceptors[type];if(interceptors){for(var i=0,L=interceptors.length;i<L;i++){handlerInfo=interceptors[i](type,event);if(handlerInfo){break}if(handlerInfo===false){return true}}}if(!handlerInfo){handlerInfo=this.getEventHandler(type,scenes,index,event)}return handlerInfo?this.handle.apply(this,handlerInfo):false};pv.Mark.handle=function(handler,type,scenes,index,event){var m=scenes.mark;m.context(scenes,index,function(){var stack=pv.Mark.stack.concat(event);if(handler instanceof Array){var ms;handler.forEach(function(hi){var mi=hi.apply(m,stack);if(mi&&mi.render){(ms||(ms=[])).push(mi)}});if(ms){ms.forEach(function(mi){mi.render()})}}else{m=handler.apply(m,stack);if(m&&m.render){m.render()}}});return true};pv.Mark.prototype.addEventInterceptor=function(type,handler,before){var root=this.root;if(root){var interceptors=root.$interceptors||(root.$interceptors={});var list=interceptors[type]||(interceptors[type]=[]);if(before){list.unshift(handler)}else{list.push(handler)}}};pv.Mark.prototype.eachInstance=function(fun,ctx){var mark=this,indexes=[];while(mark.parent){indexes.unshift(mark.childIndex);mark=mark.parent}var rootScene=mark.scene;if(!rootScene){return}var L=indexes.length;function mapRecursive(scene,level,toScreen){var D=scene.length;if(D>0){var isLastLevel=level===L,childIndex;if(!isLastLevel){childIndex=indexes[level]}for(var index=0;index<D;index++){var instance=scene[index];if(instance.visible){if(level===L){fun.call(ctx,scene,index,toScreen)}else{var childScene=instance.children[childIndex];if(childScene){var childToScreen=toScreen.times(instance.transform).translate(instance.left,instance.top);mapRecursive(childScene,level+1,childToScreen)}}}}}}mapRecursive(rootScene,0,pv.Transform.identity)};pv.Mark.prototype.toScreenTransform=function(){var t=pv.Transform.identity;if(this instanceof pv.Panel){t=t.translate(this.left(),this.top()).times(this.transform())}var parent=this.parent;if(parent){do{t=t.translate(parent.left(),parent.top()).times(parent.transform())}while((parent=parent.parent))}return t};pv.Mark.prototype.transition=function(){return new pv.Transition(this)};pv.Mark.prototype.on=function(state){return this["$"+state]=new pv.Transient(this)};pv.Mark.prototype.getShape=function(scenes,index){var s=scenes[index];if(!s.visible){return null}return s._shape||(s._shape=this.getShapeCore(scenes,index))};pv.Mark.prototype.getShapeCore=function(scenes,index){var s=scenes[index];return new pv.Shape.Rect(s.left,s.top,s.width,s.height)};pv.Anchor=function(target){pv.Mark.call(this);this.target=target;this.parent=target.parent};pv.Anchor.prototype=pv.extend(pv.Mark).property("name",String);pv.Anchor.prototype.extend=function(proto){this.proto=proto;return this};pv.Area=function(){pv.Mark.call(this)};pv.Area.castSegmented=function(v){if(!v){return''}switch(v){case'smart':case'full':break;default:v='full'}return v};pv.Area.prototype=pv.extend(pv.Mark).property("width",Number).property("height",Number).property("lineWidth",Number).property("lineJoin",String).property("strokeMiterLimit",Number).property("lineCap",String).property("strokeDasharray",String).property("strokeStyle",pv.fillStyle).property("fillStyle",pv.fillStyle).property("segmented",pv.Area.castSegmented).property("interpolate",String).property("tension",Number);pv.Area.prototype.type="area";pv.Area.prototype.defaults=new pv.Area().extend(pv.Mark.prototype.defaults).lineWidth(1.5).fillStyle(pv.Colors.category20().by(pv.parent)).interpolate("linear").tension(.7).lineJoin("miter").strokeMiterLimit(8).lineCap("butt").strokeDasharray("none");pv.Area.prototype.buildImplied=function(s){if(s.height==null)s.height=0;if(s.width==null)s.width=0;pv.Mark.prototype.buildImplied.call(this,s)};pv.Area.fixed={lineWidth:1,lineJoin:1,strokeMiterLimit:1,lineCap:1,strokeStyle:1,strokeDasharray:1,fillStyle:1,segmented:1,interpolate:1,tension:1};pv.Area.prototype.bind=function(){pv.Mark.prototype.bind.call(this);var binds=this.binds,required=binds.required,optional=binds.optional;for(var i=0,n=optional.length;i<n;i++){var p=optional[i];p.fixed=p.name in pv.Area.fixed;if(p.name=="segmented"){required.push(p);optional.splice(i,1);i--;n--}}this.binds.$required=required;this.binds.$optional=optional};pv.Area.prototype.buildInstance=function(s){var binds=this.binds;if(this.index){var fixed=binds.fixed;if(!fixed){fixed=binds.fixed=[];function f(p){return!p.fixed||(fixed.push(p),false)}binds.required=binds.required.filter(f);if(!this.scene[0].segmented)binds.optional=binds.optional.filter(f)}var n=fixed.length;if(n){var firstScene=this.scene[0];for(var i=0;i<n;i++){var p=fixed[i].name;s[p]=firstScene[p]}}}else{binds.required=binds.$required;binds.optional=binds.$optional;binds.fixed=null}pv.Mark.prototype.buildInstance.call(this,s)};pv.Area.prototype.anchor=function(name){var scene;return pv.Mark.prototype.anchor.call(this,name).interpolate(function(){return this.scene.target[this.index].interpolate}).eccentricity(function(){return this.scene.target[this.index].eccentricity}).tension(function(){return this.scene.target[this.index].tension})};pv.Area.prototype.getShapeCore=function(scenes,index){var s=scenes[index];var w=(s.width||0),h=(s.height||0),x=s.left,y=s.top;var s2=index+1<scenes.length?scenes[index+1]:null;if(!s2||!s2.visible){return new pv.Shape.Line(x,y,x+w,y+h)}var x2=s2.left,y2=s2.top,h2=s2.height||0,w2=s2.width||0;return new pv.Shape.Polygon([new pv.Vector(x,y),new pv.Vector(x2,y2),new pv.Vector(x2+w2,y2+h2),new pv.Vector(x+w,y+h)])};pv.Bar=function(){pv.Mark.call(this)};pv.Bar.prototype=pv.extend(pv.Mark).property("width",Number).property("height",Number).property("lineWidth",Number).property("strokeStyle",pv.fillStyle).property("fillStyle",pv.fillStyle).property("lineCap",String).property("strokeDasharray",String);pv.Bar.prototype.type="bar";pv.Bar.prototype.defaults=new pv.Bar().extend(pv.Mark.prototype.defaults).lineWidth(1.5).fillStyle(pv.Colors.category20().by(pv.parent)).lineCap("butt").strokeDasharray("none");pv.Dot=function(){pv.Mark.call(this)};pv.Dot.prototype=pv.extend(pv.Mark).property("shape",String).property("shapeAngle",Number).property("shapeRadius",Number).property("shapeSize",Number).property("lineWidth",Number).property("strokeStyle",pv.fillStyle).property("lineCap",String).property("strokeDasharray",String).property("fillStyle",pv.fillStyle);pv.Dot.prototype.type="dot";pv.Dot.prototype.defaults=new pv.Dot().extend(pv.Mark.prototype.defaults).shape("circle").lineWidth(1.5).strokeStyle(pv.Colors.category10().by(pv.parent)).lineCap("butt").strokeDasharray("none");pv.Dot.prototype.anchor=function(name){var scene;return pv.Mark.prototype.anchor.call(this,name).left(function(){var s=this.scene.target[this.index];switch(this.name()){case"bottom":case"top":case"center":return s.left;case"left":return null}return s.left+s.shapeRadius}).right(function(){var s=this.scene.target[this.index];return this.name()=="left"?s.right+s.shapeRadius:null}).top(function(){var s=this.scene.target[this.index];switch(this.name()){case"left":case"right":case"center":return s.top;case"top":return null}return s.top+s.shapeRadius}).bottom(function(){var s=this.scene.target[this.index];return this.name()=="top"?s.bottom+s.shapeRadius:null}).textAlign(function(){switch(this.name()){case"left":return"right";case"bottom":case"top":case"center":return"center"}return"left"}).textBaseline(function(){switch(this.name()){case"right":case"left":case"center":return"middle";case"bottom":return"top"}return"bottom"})};pv.Dot.prototype.buildImplied=function(s){var r=s.shapeRadius,z=s.shapeSize;if(r==null){if(z==null){s.shapeSize=20.25;s.shapeRadius=4.5}else{s.shapeRadius=Math.sqrt(z)}}else if(z==null){s.shapeSize=r*r}pv.Mark.prototype.buildImplied.call(this,s)};pv.Dot.prototype.getShapeCore=function(scenes,index){var s=scenes[index];var radius=s.shapeRadius,cx=s.left,cy=s.top;switch(s.shape){case'diamond':radius*=Math.SQRT2;case'square':case'cross':return new pv.Shape.Rect(cx-radius,cy-radius,2*radius,2*radius)}return new pv.Shape.Circle(cx,cy,radius)};pv.Label=function(){pv.Mark.call(this)};pv.Label.prototype=pv.extend(pv.Mark).property("text",String).property("font",String).property("textAngle",Number).property("textStyle",pv.color).property("textAlign",String).property("textBaseline",String).property("textMargin",Number).property("textDecoration",String).property("textShadow",String);pv.Label.prototype.type="label";pv.Label.prototype.defaults=new pv.Label().extend(pv.Mark.prototype.defaults).events("none").text(pv.identity).font("10px sans-serif").textAngle(0).textStyle("black").textAlign("left").textBaseline("bottom").textMargin(3);pv.Label.prototype.getShapeCore=function(scenes,index){var s=scenes[index];var size=pv.Text.measure(s.text,s.font);return pv.Label.getPolygon(size.width,size.height,s.textAlign,s.textBaseline,s.textAngle,s.textMargin).apply(pv.Transform.identity.translate(s.left,s.top))};pv.Label.getPolygon=function(textWidth,textHeight,align,baseline,angle,margin){var x,y;switch(baseline){case"middle":y=textHeight/2; break;case"top":y=margin+textHeight;break;case"bottom":y=-margin;break}switch(align){case"right":x=-margin-textWidth;break;case"center":x=-textWidth/2;break;case"left":x=margin;break}var bl=new pv.Vector(x,y);var br=bl.plus(textWidth,0);var tr=br.plus(0,-textHeight);var tl=bl.plus(0,-textHeight);if(angle!==0){bl=bl.rotate(angle);br=br.rotate(angle);tl=tl.rotate(angle);tr=tr.rotate(angle)}return new pv.Shape.Polygon([bl,br,tr,tl])};pv.Line=function(){pv.Mark.call(this)};pv.Line.prototype=pv.extend(pv.Mark).property("lineWidth",Number).property("lineJoin",String).property("strokeMiterLimit",Number).property("lineCap",String).property("strokeStyle",pv.fillStyle).property("strokeDasharray",String).property("fillStyle",pv.fillStyle).property("segmented",pv.Area.castSegmented).property("interpolate",String).property("eccentricity",Number).property("tension",Number);pv.Line.prototype.type="line";pv.Line.prototype.defaults=new pv.Line().extend(pv.Mark.prototype.defaults).lineWidth(1.5).strokeStyle(pv.Colors.category10().by(pv.parent)).interpolate("linear").eccentricity(0).tension(.7).lineJoin("miter").strokeMiterLimit(8).lineCap("butt").strokeDasharray("none");pv.Line.prototype.bind=pv.Area.prototype.bind;pv.Line.prototype.buildInstance=pv.Area.prototype.buildInstance;pv.Line.prototype.anchor=function(name){return pv.Area.prototype.anchor.call(this,name).textAlign(function(d){switch(this.name()){case"left":return"right";case"bottom":case"top":case"center":return"center";case"right":return"left"}}).textBaseline(function(d){switch(this.name()){case"right":case"left":case"center":return"middle";case"top":return"bottom";case"bottom":return"top"}})};pv.Line.prototype.getShapeCore=function(scenes,index){var s=scenes[index];var s2=index+1<scenes.length?scenes[index+1]:null;if(s2==null||!s2.visible){return new pv.Shape.Point(s.left,s.top)}return new pv.Shape.Line(s.left,s.top,s2.left,s2.top)};pv.Rule=function(){pv.Mark.call(this)};pv.Rule.prototype=pv.extend(pv.Mark).property("width",Number).property("height",Number).property("lineWidth",Number).property("strokeStyle",pv.fillStyle).property("lineCap",String).property("strokeDasharray",String);pv.Rule.prototype.type="rule";pv.Rule.prototype.defaults=new pv.Rule().extend(pv.Mark.prototype.defaults).lineWidth(1).strokeStyle("black").antialias(false).lineCap("butt").strokeDasharray("none");pv.Rule.prototype.anchor=pv.Line.prototype.anchor;pv.Rule.prototype.buildImplied=function(s){var l=s.left,r=s.right,t=s.top,b=s.bottom;if((s.width!=null)||((l==null)&&(r==null))||((r!=null)&&(l!=null))){s.height=0}else{s.width=0}pv.Mark.prototype.buildImplied.call(this,s)};pv.Rule.prototype.getShapeCore=function(scenes,index){var s=scenes[index];return new pv.Shape.Line(s.left,s.top,s.left+s.width,s.top+s.height)};pv.Panel=function(){pv.Bar.call(this);this.children=[];this.root=this;this.$dom=pv.$&&pv.$.s};pv.Panel.prototype=pv.extend(pv.Bar).property("transform").property("overflow",String).property("canvas",function(c){return(typeof c=="string")?document.getElementById(c):c});pv.Panel.prototype.type="panel";pv.Panel.prototype.animatingCount=0;pv.Panel.prototype.zOrderChildCount=0;pv.Panel.prototype.defaults=new pv.Panel().extend(pv.Bar.prototype.defaults).fillStyle(null).overflow("visible");pv.Panel.prototype.anchor=function(name){var anchor=pv.Bar.prototype.anchor.call(this,name);anchor.parent=this;return anchor};pv.Panel.prototype.add=function(type){var child=new type();child.parent=this;child.root=this.root;child.childIndex=this.children.length;this.children.push(child);return child};pv.Panel.prototype.bind=function(){pv.Mark.prototype.bind.call(this);var children=this.children;for(var i=0,n=children.length;i<n;i++){children[i].bind()}};pv.Panel.prototype.buildInstance=function(s){pv.Bar.prototype.buildInstance.call(this,s);if(!s.visible)return;var scale=this.scale*s.transform.k;pv.Mark.prototype.index=-1;var child;var children=this.children;var childScenes=s.children||(s.children=[]);for(var i=0,n=children.length;i<n;i++){child=children[i];child.scene=childScenes[i];child.scale=scale;child.build()}for(var i=0;i<n;i++){child=children[i];childScenes[i]=child.scene;delete child.scene;delete child.scale}childScenes.length=n};pv.Panel.prototype.buildImplied=function(s){if(!this.parent){var c=s.canvas;if(pv.renderer()==="batik"){if(c){if(c.$panel!=this){pv.Panel.updateCreateId(c);c.$panel=this;while(c.lastChild)c.removeChild(c.lastChild)}}else{c=document.lastChild}}else if(c){if(c.$panel!=this){pv.Panel.updateCreateId(c);c.$panel=this;while(c.lastChild)c.removeChild(c.lastChild)}var w,h;if(s.width==null){w=parseFloat(pv.css(c,"width"));s.width=w-s.left-s.right}if(s.height==null){h=parseFloat(pv.css(c,"height"));s.height=h-s.top-s.bottom}}else{var cache=this.$canvas||(this.$canvas=[]);if(!(c=cache[this.index])){c=cache[this.index]=document.createElement(pv.renderer()=="svgweb"?"div":"span");if(this.$dom){this.$dom.parentNode.insertBefore(c,this.$dom)}else{var n=document.body;while(n.lastChild&&n.lastChild.tagName)n=n.lastChild;if(n!=document.body)n=n.parentNode;n.appendChild(c)}}}s.canvas=c}if(!s.transform)s.transform=pv.Transform.identity;pv.Mark.prototype.buildImplied.call(this,s)};pv.Panel.updateCreateId=function(c){c.$pvCreateId=(c.$pvCreateId||0)+1};pv.Image=function(){pv.Bar.call(this)};pv.Image.prototype=pv.extend(pv.Bar).property("url",String).property("imageWidth",Number).property("imageHeight",Number);pv.Image.prototype.type="image";pv.Image.prototype.defaults=new pv.Image().extend(pv.Bar.prototype.defaults).fillStyle(null);pv.Image.prototype.image=function(f){this.$image=function(){var c=f.apply(this,arguments);return c==null?pv.Color.transparent:typeof c=="string"?pv.color(c):c};return this};pv.Image.prototype.bind=function(){pv.Bar.prototype.bind.call(this);var binds=this.binds,mark=this;do{binds.image=mark.$image}while(!binds.image&&(mark=mark.proto))};pv.Image.prototype.buildImplied=function(s){pv.Bar.prototype.buildImplied.call(this,s);if(!s.visible)return;if(s.imageWidth==null)s.imageWidth=s.width;if(s.imageHeight==null)s.imageHeight=s.height;if((s.url==null)&&this.binds.image){var canvas=this.$canvas||(this.$canvas=document.createElement("canvas")),context=canvas.getContext("2d"),w=s.imageWidth,h=s.imageHeight,stack=pv.Mark.stack,data;canvas.width=w;canvas.height=h;data=(s.image=context.createImageData(w,h)).data;stack.unshift(null,null);for(var y=0,p=0;y<h;y++){stack[1]=y;for(var x=0;x<w;x++){stack[0]=x;var color=this.binds.image.apply(this,stack);data[p++]=color.r;data[p++]=color.g;data[p++]=color.b;data[p++]=255*color.a}}stack.splice(0,2)}};pv.Wedge=function(){pv.Mark.call(this)};pv.Wedge.prototype=pv.extend(pv.Mark).property("startAngle",Number).property("endAngle",Number).property("angle",Number).property("innerRadius",Number).property("outerRadius",Number).property("lineWidth",Number).property("strokeStyle",pv.fillStyle).property("lineJoin",String).property("strokeMiterLimit",Number).property("lineCap",String).property("strokeDasharray",String).property("fillStyle",pv.fillStyle);pv.Wedge.prototype.type="wedge";pv.Wedge.prototype.defaults=new pv.Wedge().extend(pv.Mark.prototype.defaults).startAngle(function(){var s=this.sibling();return s?s.endAngle:-Math.PI/2}).innerRadius(0).lineWidth(1.5).strokeStyle(null).fillStyle(pv.Colors.category20().by(pv.index)).lineJoin("miter").strokeMiterLimit(8).lineCap("butt").strokeDasharray("none");pv.Wedge.prototype.midRadius=function(){return(this.innerRadius()+this.outerRadius())/2};pv.Wedge.prototype.midAngle=function(){return(this.startAngle()+this.endAngle())/2};pv.Wedge.prototype.anchor=function(name){function partial(s){return s.innerRadius||s.angle<2*Math.PI}function midRadius(s){return(s.innerRadius+s.outerRadius)/2}function midAngle(s){return(s.startAngle+s.endAngle)/2}return pv.Mark.prototype.anchor.call(this,name).left(function(){var s=this.scene.target[this.index];if(partial(s))switch(this.name()){case"outer":return s.left+s.outerRadius*Math.cos(midAngle(s));case"inner":return s.left+s.innerRadius*Math.cos(midAngle(s));case"start":return s.left+midRadius(s)*Math.cos(s.startAngle);case"center":return s.left+midRadius(s)*Math.cos(midAngle(s));case"end":return s.left+midRadius(s)*Math.cos(s.endAngle)}return s.left}).top(function(){var s=this.scene.target[this.index];if(partial(s))switch(this.name()){case"outer":return s.top+s.outerRadius*Math.sin(midAngle(s));case"inner":return s.top+s.innerRadius*Math.sin(midAngle(s));case"start":return s.top+midRadius(s)*Math.sin(s.startAngle);case"center":return s.top+midRadius(s)*Math.sin(midAngle(s));case"end":return s.top+midRadius(s)*Math.sin(s.endAngle)}return s.top}).textAlign(function(){var s=this.scene.target[this.index];if(partial(s))switch(this.name()){case"outer":return pv.Wedge.upright(midAngle(s))?"right":"left";case"inner":return pv.Wedge.upright(midAngle(s))?"left":"right"}return"center"}).textBaseline(function(){var s=this.scene.target[this.index];if(partial(s))switch(this.name()){case"start":return pv.Wedge.upright(s.startAngle)?"top":"bottom";case"end":return pv.Wedge.upright(s.endAngle)?"bottom":"top"}return"middle"}).textAngle(function(){var s=this.scene.target[this.index],a=0;if(partial(s))switch(this.name()){case"center":case"inner":case"outer":a=midAngle(s);break;case"start":a=s.startAngle;break;case"end":a=s.endAngle;break}return pv.Wedge.upright(a)?a:(a+Math.PI)})};pv.Wedge.upright=function(angle){angle=angle%(2*Math.PI);angle=(angle<0)?(2*Math.PI+angle):angle;return(angle<Math.PI/2)||(angle>=3*Math.PI/2)};pv.Wedge.prototype.buildImplied=function(s){if(s.angle==null)s.angle=s.endAngle-s.startAngle;else if(s.endAngle==null)s.endAngle=s.startAngle+s.angle;pv.Mark.prototype.buildImplied.call(this,s)};pv.Wedge.prototype.getShapeCore=function(scenes,index){var s=scenes[index];return new pv.Shape.Wedge(s.left,s.top,s.innerRadius,s.outerRadius,s.startAngle,s.angle)};pv.Ease=(function(){function reverse(f){return function(t){return 1-f(1-t)}}function reflect(f){return function(t){return.5*(t<.5?f(2*t):(2-f(2-2*t)))}}function poly(e){return function(t){return t<0?0:t>1?1:Math.pow(t,e)}}function sin(t){return 1-Math.cos(t*Math.PI/2)}function exp(t){return t?Math.pow(2,10*(t-1))-0.001:0}function circle(t){return-(Math.sqrt(1-t*t)-1)}function elastic(a,p){var s;if(!p)p=0.45;if(!a||a<1){a=1;s=p/4}else s=p/(2*Math.PI)*Math.asin(1/a);return function(t){return t<=0||t>=1?t:-(a*Math.pow(2,10*(--t))*Math.sin((t-s)*(2*Math.PI)/p))}}function back(s){if(!s)s=1.70158;return function(t){return t*t*((s+1)*t-s)}}function bounce(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}var quad=poly(2),cubic=poly(3),elasticDefault=elastic(),backDefault=back();var eases={"linear":pv.identity,"quad-in":quad,"quad-out":reverse(quad),"quad-in-out":reflect(quad),"quad-out-in":reflect(reverse(quad)),"cubic-in":cubic,"cubic-out":reverse(cubic),"cubic-in-out":reflect(cubic),"cubic-out-in":reflect(reverse(cubic)),"sin-in":sin,"sin-out":reverse(sin),"sin-in-out":reflect(sin),"sin-out-in":reflect(reverse(sin)),"exp-in":exp,"exp-out":reverse(exp),"exp-in-out":reflect(exp),"exp-out-in":reflect(reverse(exp)),"circle-in":circle,"circle-out":reverse(circle),"circle-in-out":reflect(circle),"circle-out-in":reflect(reverse(circle)),"elastic-in":elasticDefault,"elastic-out":reverse(elasticDefault),"elastic-in-out":reflect(elasticDefault),"elastic-out-in":reflect(reverse(elasticDefault)),"back-in":backDefault,"back-out":reverse(backDefault),"back-in-out":reflect(backDefault),"back-out-in":reflect(reverse(backDefault)),"bounce-in":bounce,"bounce-out":reverse(bounce),"bounce-in-out":reflect(bounce),"bounce-out-in":reflect(reverse(bounce))};pv.ease=function(f){return eases[f]};return{reverse:reverse,reflect:reflect,linear:function(){return pv.identity},sin:function(){return sin},exp:function(){return exp},circle:function(){return circle},elastic:elastic,back:back,bounce:bounce,poly:poly}})();pv.Transition=function(mark){var that=this,ease=pv.ease("cubic-in-out"),duration=250,timer,onEndCallback;var interpolated={top:1,left:1,right:1,bottom:1,width:1,height:1,innerRadius:1,outerRadius:1,radius:1,startAngle:1,endAngle:1,angle:1,fillStyle:1,strokeStyle:1,lineWidth:1,eccentricity:1,tension:1,textAngle:1,textStyle:1,textMargin:1};var defaults=new pv.Transient();function ids(marks){var map={};for(var i=0;i<marks.length;i++){var mark=marks[i];if(mark.id){map[mark.id]=mark}}return map}function interpolateProperty(list,name,before,after){var f;if(name in interpolated){var i=pv.Scale.interpolator(before[name],after[name]);f=function(t){before[name]=i(t)}}else{f=function(t){if(t>.5){before[name]=after[name]}}}f.next=list.head;list.head=f}function interpolateInstance(list,before,after){for(var name in before){if(name=="children")continue;if(before[name]==after[name])continue;interpolateProperty(list,name,before,after)}if(before.children){for(var j=0;j<before.children.length;j++){interpolate(list,before.children[j],after.children[j])}}}function interpolate(list,before,after){var mark=before.mark,bi=ids(before),ai=ids(after);for(var i=0;i<before.length;i++){var b=before[i],a=b.id?ai[b.id]:after[i];b.index=i;if(!b.visible){continue}if(!(a&&a.visible)){var o=override(before,i,mark.$exit,after);b.transition=a?2:(after.push(o),1);a=o}interpolateInstance(list,b,a)}for(var i=0;i<after.length;i++){var a=after[i],b=a.id?bi[a.id]:before[i];if(!(b&&b.visible)&&a.visible){var o=override(after,i,mark.$enter,before);if(!b)before.push(o);else before[b.index]=o;interpolateInstance(list,o,a)}}}function override(scene,index,proto,other){var s=pv.extend(scene[index]),m=scene.mark,r=m.root.scene,p=(proto||defaults).$properties,t;if(other.target&&(t=other.target[other.length])){scene=pv.extend(scene);scene.target=pv.extend(other.target);scene.target[index]=t}var seen={};for(var i=0;i<p.length;i++){seen[p[i].name]=1}p=m.binds.optional.filter(function(p){return!(p.name in seen)}).concat(p);m.context(scene,index,function(){this.buildProperties(s,p);this.buildImplied(s)});m.root.scene=r;return s}function cleanup(scene){for(var i=0,j=0;i<scene.length;i++){var s=scene[i];if(s.transition!=1){scene[j++]=s;if(s.transition==2)s.visible=false;if(s.children)s.children.forEach(cleanup)}}scene.length=j}that.ease=function(x){return arguments.length?(ease=typeof x=="function"?x:pv.ease(x),that):ease};that.duration=function(x){return arguments.length?(duration=Number(x),that):duration};function doEnd(){mark.root.animatingCount--;if(onEndCallback){var cb=onEndCallback;onEndCallback=null;cb()}}that.start=function(onEnd){onEndCallback=onEnd;mark.root.animatingCount++;if(mark.parent){doEnd();throw new Error("Animated partial rendering is not supported.")}try{if(mark.$transition){mark.$transition.stop()}mark.$transition=that;var i=pv.Mark.prototype.index,before=mark.scene,after;mark.scene=null;mark.bind();mark.build();after=mark.scene;mark.scene=before;pv.Mark.prototype.index=i;var start=Date.now(),list={};interpolate(list,before,after)}catch(ex){doEnd();throw ex}timer=setInterval(function(){var t=Math.max(0,Math.min(1,(Date.now()-start)/duration)),e=ease(t);for(var i=list.head;i;i=i.next){i(e)}if(t==1){cleanup(mark.scene);that.stop()}pv.Scene.updateAll(before)},24)};that.stop=function(){clearInterval(timer);doEnd()}};pv.Transient=function(mark){pv.Mark.call(this);this.fillStyle(null).strokeStyle(null).textStyle(null);this.on=function(state){return mark.on(state)}};pv.Transient.prototype=pv.extend(pv.Mark);pv.simulation=function(particles){return new pv.Simulation(particles)};pv.Simulation=function(particles){for(var i=0;i<particles.length;i++)this.particle(particles[i])};pv.Simulation.prototype.particle=function(p){p.next=this.particles;if(isNaN(p.px))p.px=p.x;if(isNaN(p.py))p.py=p.y;if(isNaN(p.fx))p.fx=0;if(isNaN(p.fy))p.fy=0;this.particles=p;return this};pv.Simulation.prototype.force=function(f){f.next=this.forces;this.forces=f;return this};pv.Simulation.prototype.constraint=function(c){c.next=this.constraints;this.constraints=c;return this};pv.Simulation.prototype.stabilize=function(n){var c;if(!arguments.length)n=3;for(var i=0;i<n;i++){var q=new pv.Quadtree(this.particles);for(c=this.constraints;c;c=c.next)c.apply(this.particles,q)}for(var p=this.particles;p;p=p.next){p.px=p.x;p.py=p.y}return this};pv.Simulation.prototype.step=function(){var p,f,c;for(p=this.particles;p;p=p.next){var px=p.px,py=p.py;p.px=p.x;p.py=p.y;p.x+=p.vx=((p.x-px)+p.fx);p.y+=p.vy=((p.y-py)+p.fy)}var q=new pv.Quadtree(this.particles);for(c=this.constraints;c;c=c.next)c.apply(this.particles,q);for(p=this.particles;p;p=p.next)p.fx=p.fy=0;for(f=this.forces;f;f=f.next)f.apply(this.particles,q)};pv.Quadtree=function(particles){var p;var x1=Number.POSITIVE_INFINITY,y1=x1,x2=Number.NEGATIVE_INFINITY,y2=x2;for(p=particles;p;p=p.next){if(p.x<x1)x1=p.x;if(p.y<y1)y1=p.y;if(p.x>x2)x2=p.x;if(p.y>y2)y2=p.y}var dx=x2-x1,dy=y2-y1;if(dx>dy)y2=y1+dx;else x2=x1+dy;this.xMin=x1;this.yMin=y1;this.xMax=x2;this.yMax=y2;function insert(n,p,x1,y1,x2,y2){if(isNaN(p.x)||isNaN(p.y))return;if(n.leaf){if(n.p){if((Math.abs(n.p.x-p.x)+Math.abs(n.p.y-p.y))<.01){insertChild(n,p,x1,y1,x2,y2)}else{var v=n.p;n.p=null;insertChild(n,v,x1,y1,x2,y2);insertChild(n,p,x1,y1,x2,y2)}}else{n.p=p}}else{insertChild(n,p,x1,y1,x2,y2)}}function insertChild(n,p,x1,y1,x2,y2){var sx=(x1+x2)*.5,sy=(y1+y2)*.5,right=p.x>=sx,bottom=p.y>=sy;n.leaf=false;switch((bottom<<1)+right){case 0:n=n.c1||(n.c1=new pv.Quadtree.Node());break;case 1:n=n.c2||(n.c2=new pv.Quadtree.Node());break;case 2:n=n.c3||(n.c3=new pv.Quadtree.Node());break;case 3:n=n.c4||(n.c4=new pv.Quadtree.Node());break}if(right)x1=sx;else x2=sx;if(bottom)y1=sy;else y2=sy;insert(n,p,x1,y1,x2,y2)}this.root=new pv.Quadtree.Node();for(p=particles;p;p=p.next)insert(this.root,p,x1,y1,x2,y2)};pv.Quadtree.Node=function(){this.leaf=true;this.c1=null;this.c2=null;this.c3=null;this.c4=null;this.p=null};pv.Force={};pv.Force.charge=function(k){var min=2,min1=1/min,max=500,max1=1/max,theta=.9,force={};if(!arguments.length)k=-40;force.constant=function(x){if(arguments.length){k=Number(x);return force}return k};force.domain=function(a,b){if(arguments.length){min=Number(a);min1=1/min;max=Number(b);max1=1/max;return force}return[min,max]};force.theta=function(x){if(arguments.length){theta=Number(x);return force}return theta};function accumulate(n){var cx=0,cy=0;n.cn=0;function accumulateChild(c){accumulate(c);n.cn+=c.cn;cx+=c.cn*c.cx;cy+=c.cn*c.cy}if(!n.leaf){if(n.c1)accumulateChild(n.c1);if(n.c2)accumulateChild(n.c2);if(n.c3)accumulateChild(n.c3);if(n.c4)accumulateChild(n.c4)}if(n.p){n.cn+=k;cx+=k*n.p.x;cy+=k*n.p.y}n.cx=cx/n.cn;n.cy=cy/n.cn}function forces(n,p,x1,y1,x2,y2){var dx=n.cx-p.x,dy=n.cy-p.y,dn=1/Math.sqrt(dx*dx+dy*dy);if((n.leaf&&(n.p!=p))||((x2-x1)*dn<theta)){if(dn<max1)return;if(dn>min1)dn=min1;var kc=n.cn*dn*dn*dn,fx=dx*kc,fy=dy*kc;p.fx+=fx;p.fy+=fy}else if(!n.leaf){var sx=(x1+x2)*.5,sy=(y1+y2)*.5;if(n.c1)forces(n.c1,p,x1,y1,sx,sy);if(n.c2)forces(n.c2,p,sx,y1,x2,sy);if(n.c3)forces(n.c3,p,x1,sy,sx,y2);if(n.c4)forces(n.c4,p,sx,sy,x2,y2);if(dn<max1)return;if(dn>min1)dn=min1;if(n.p&&(n.p!=p)){var kc=k*dn*dn*dn,fx=dx*kc,fy=dy*kc;p.fx+=fx;p.fy+=fy}}}force.apply=function(particles,q){accumulate(q.root);for(var p=particles;p;p=p.next){forces(q.root,p,q.xMin,q.yMin,q.xMax,q.yMax)}};return force};pv.Force.drag=function(k){var force={};if(!arguments.length)k=.1;force.constant=function(x){if(arguments.length){k=x;return force}return k};force.apply=function(particles){if(k)for(var p=particles;p;p=p.next){p.fx-=k*p.vx;p.fy-=k*p.vy}};return force};pv.Force.spring=function(k){var d=.1,l=20,links,kl,force={};if(!arguments.length)k=.1;force.links=function(x){if(arguments.length){links=x;kl=x.map(function(l){return 1/Math.sqrt(Math.max(l.sourceNode.linkDegree,l.targetNode.linkDegree))});return force}return links};force.constant=function(x){if(arguments.length){k=Number(x);return force}return k};force.damping=function(x){if(arguments.length){d=Number(x);return force}return d};force.length=function(x){if(arguments.length){l=Number(x);return force}return l};force.apply=function(particles){for(var i=0;i<links.length;i++){var a=links[i].sourceNode,b=links[i].targetNode,dx=a.x-b.x,dy=a.y-b.y,dn=Math.sqrt(dx*dx+dy*dy),dd=dn?(1/dn):1,ks=k*kl[i],kd=d*kl[i],kk=(ks*(dn-l)+kd*(dx*(a.vx-b.vx)+dy*(a.vy-b.vy))*dd)*dd,fx=-kk*(dn?dx:(.01*(.5-Math.random()))),fy=-kk*(dn?dy:(.01*(.5-Math.random())));a.fx+=fx;a.fy+=fy;b.fx-=fx;b.fy-=fy}};return force};pv.Constraint={};pv.Constraint.collision=function(radius){var n=1,r1,px1,py1,px2,py2,constraint={};if(!arguments.length)r1=10;constraint.repeat=function(x){if(arguments.length){n=Number(x);return constraint}return n};function constrain(n,p,x1,y1,x2,y2){if(!n.leaf){var sx=(x1+x2)*.5,sy=(y1+y2)*.5,top=sy>py1,bottom=sy<py2,left=sx>px1,right=sx<px2;if(top){if(n.c1&&left)constrain(n.c1,p,x1,y1,sx,sy);if(n.c2&&right)constrain(n.c2,p,sx,y1,x2,sy)}if(bottom){if(n.c3&&left)constrain(n.c3,p,x1,sy,sx,y2);if(n.c4&&right)constrain(n.c4,p,sx,sy,x2,y2)}}if(n.p&&(n.p!=p)){var dx=p.x-n.p.x,dy=p.y-n.p.y,l=Math.sqrt(dx*dx+dy*dy),d=r1+radius(n.p);if(l<d){var k=(l-d)/l*.5;dx*=k;dy*=k;p.x-=dx;p.y-=dy;n.p.x+=dx;n.p.y+=dy}}}constraint.apply=function(particles,q){var p,r,max=-Infinity;for(p=particles;p;p=p.next){r=radius(p);if(r>max)max=r}for(var i=0;i<n;i++){for(p=particles;p;p=p.next){r=(r1=radius(p))+max;px1=p.x-r;px2=p.x+r;py1=p.y-r;py2=p.y+r;constrain(q.root,p,q.xMin,q.yMin,q.xMax,q.yMax)}}};return constraint};pv.Constraint.position=function(f){var a=1,constraint={};if(!arguments.length)f=function(p){return p.fix};constraint.alpha=function(x){if(arguments.length){a=Number(x);return constraint}return a};constraint.apply=function(particles){for(var p=particles;p;p=p.next){var v=f(p);if(v){p.x+=(v.x-p.x)*a;p.y+=(v.y-p.y)*a;p.fx=p.fy=p.vx=p.vy=0}}};return constraint};pv.Constraint.bound=function(){var constraint={},x,y;constraint.x=function(min,max){if(arguments.length){x={min:Math.min(min,max),max:Math.max(min,max)};return this}return x};constraint.y=function(min,max){if(arguments.length){y={min:Math.min(min,max),max:Math.max(min,max)};return this}return y};constraint.apply=function(particles){if(x)for(var p=particles;p;p=p.next){p.x=p.x<x.min?x.min:(p.x>x.max?x.max:p.x)}if(y)for(var p=particles;p;p=p.next){p.y=p.y<y.min?y.min:(p.y>y.max?y.max:p.y)}};return constraint};pv.Layout=function(){pv.Panel.call(this)};pv.Layout.prototype=pv.extend(pv.Panel);pv.Layout.prototype.property=pv.Mark.prototype.localProperty;pv.Layout.Network=function(){pv.Layout.call(this);var that=this;this.$id=pv.id();(this.node=new pv.Mark().data(function(){return that.nodes()}).strokeStyle("#1f77b4").fillStyle("#fff").left(function(n){return n.x}).top(function(n){return n.y})).parent=this;this.link=new pv.Mark().extend(this.node).data(function(p){return[p.sourceNode,p.targetNode]}).fillStyle(null).lineWidth(function(d,p){return p.linkValue*1.5}).strokeStyle("rgba(0,0,0,.2)");this.link.add=function(type){return that.add(pv.Panel).data(function(){return that.links()}).add(type).extend(this)};(this.label=new pv.Mark().extend(this.node).textMargin(7).textBaseline("middle").text(function(n){return n.nodeName||n.nodeValue}).textAngle(function(n){var a=n.midAngle;return pv.Wedge.upright(a)?a:(a+Math.PI)}).textAlign(function(n){return pv.Wedge.upright(n.midAngle)?"left":"right"})).parent=this};pv.Layout.Network.prototype=pv.extend(pv.Layout).property("nodes",function(v){return v.map(function(d,i){if(typeof d!="object")d={nodeValue:d};d.index=i;return d})}).property("links",function(v){return v.map(function(d){if(isNaN(d.linkValue))d.linkValue=isNaN(d.value)?1:d.value;return d})});pv.Layout.Network.prototype.reset=function(){this.$id=pv.id();return this};pv.Layout.Network.prototype.buildProperties=function(s,properties){if((s.$id||0)<this.$id){pv.Layout.prototype.buildProperties.call(this,s,properties)}};pv.Layout.Network.prototype.buildImplied=function(s){pv.Layout.prototype.buildImplied.call(this,s);if(s.$id>=this.$id)return true;s.$id=this.$id;s.nodes.forEach(function(d){d.linkDegree=0});s.links.forEach(function(d){var v=d.linkValue;(d.sourceNode||(d.sourceNode=s.nodes[d.source])).linkDegree+=v;(d.targetNode||(d.targetNode=s.nodes[d.target])).linkDegree+=v})};pv.Layout.Hierarchy=function(){pv.Layout.Network.call(this);this.link.strokeStyle("#ccc")};pv.Layout.Hierarchy.prototype=pv.extend(pv.Layout.Network);pv.Layout.Hierarchy.prototype.buildImplied=function(s){if(!s.links)s.links=pv.Layout.Hierarchy.links.call(this);pv.Layout.Network.prototype.buildImplied.call(this,s)};pv.Layout.Hierarchy.links=function(){return this.nodes().filter(function(n){return n.parentNode}).map(function(n){return{sourceNode:n,targetNode:n.parentNode,linkValue:1}})};pv.Layout.Hierarchy.NodeLink={buildImplied:function(s){var nodes=s.nodes,orient=s.orient,horizontal=/^(top|bottom)$/.test(orient),w=s.width,h=s.height;if(orient=="radial"){var ir=s.innerRadius,or=s.outerRadius;if(ir==null)ir=0;if(or==null)or=Math.min(w,h)/2}function radius(n){return n.parentNode?(n.depth*(or-ir)+ir):0}function midAngle(n){return(n.parentNode?(n.breadth-.25)*2*Math.PI:0)}function x(n){switch(orient){case"left":return n.depth*w;case"right":return w-n.depth*w;case"top":return n.breadth*w;case"bottom":return w-n.breadth*w;case"radial":return w/2+radius(n)*Math.cos(n.midAngle)}}function y(n){switch(orient){case"left":return n.breadth*h;case"right":return h-n.breadth*h;case"top":return n.depth*h;case"bottom":return h-n.depth*h;case"radial":return h/2+radius(n)*Math.sin(n.midAngle)}}for(var i=0;i<nodes.length;i++){var n=nodes[i];n.midAngle=orient=="radial"?midAngle(n):horizontal?Math.PI/2:0;n.x=x(n);n.y=y(n);if(n.firstChild)n.midAngle+=Math.PI}}};pv.Layout.Hierarchy.Fill={constructor:function(){this.node.strokeStyle("#fff").fillStyle("#ccc").width(function(n){return n.dx}).height(function(n){return n.dy}).innerRadius(function(n){return n.innerRadius}).outerRadius(function(n){return n.outerRadius}).startAngle(function(n){return n.startAngle}).angle(function(n){return n.angle});this.label.textAlign("center").left(function(n){return n.x+(n.dx/2)}).top(function(n){return n.y+(n.dy/2)});delete this.link},buildImplied:function(s){var nodes=s.nodes,orient=s.orient,horizontal=/^(top|bottom)$/.test(orient),w=s.width,h=s.height,depth=-nodes[0].minDepth;if(orient=="radial"){var ir=s.innerRadius,or=s.outerRadius;if(ir==null)ir=0;if(ir)depth*=2;if(or==null)or=Math.min(w,h)/2}function scale(d,depth){return(d+depth)/(1+depth)}function x(n){switch(orient){case"left":return scale(n.minDepth,depth)*w;case"right":return(1-scale(n.maxDepth,depth))*w;case"top":return n.minBreadth*w;case"bottom":return(1-n.maxBreadth)*w;case"radial":return w/2}}function y(n){switch(orient){case"left":return n.minBreadth*h;case"right":return(1-n.maxBreadth)*h;case"top":return scale(n.minDepth,depth)*h;case"bottom":return(1-scale(n.maxDepth,depth))*h;case"radial":return h/2}}function dx(n){switch(orient){case"left":case"right":return(n.maxDepth-n.minDepth)/(1+depth)*w;case"top":case"bottom":return(n.maxBreadth-n.minBreadth)*w;case"radial":return n.parentNode?(n.innerRadius+n.outerRadius)*Math.cos(n.midAngle):0}}function dy(n){switch(orient){case"left":case"right":return(n.maxBreadth-n.minBreadth)*h;case"top":case"bottom":return(n.maxDepth-n.minDepth)/(1+depth)*h;case"radial":return n.parentNode?(n.innerRadius+n.outerRadius)*Math.sin(n.midAngle):0}}function innerRadius(n){return Math.max(0,scale(n.minDepth,depth/2))*(or-ir)+ir}function outerRadius(n){return scale(n.maxDepth,depth/2)*(or-ir)+ir}function startAngle(n){return(n.parentNode?n.minBreadth-.25:0)*2*Math.PI}function angle(n){return(n.parentNode?n.maxBreadth-n.minBreadth:1)*2*Math.PI}for(var i=0;i<nodes.length;i++){var n=nodes[i];n.x=x(n);n.y=y(n);if(orient=="radial"){n.innerRadius=innerRadius(n);n.outerRadius=outerRadius(n);n.startAngle=startAngle(n);n.angle=angle(n);n.midAngle=n.startAngle+n.angle/2}else{n.midAngle=horizontal?-Math.PI/2:0}n.dx=dx(n);n.dy=dy(n)}}};pv.Layout.Grid=function(){pv.Layout.call(this);var that=this;(this.cell=new pv.Mark().data(function(){return that.scene[that.index].$grid}).width(function(){return that.width()/that.cols()}).height(function(){return that.height()/that.rows()}).left(function(){return this.width()*(this.index%that.cols())}).top(function(){return this.height()*Math.floor(this.index/that.cols())})).parent=this};pv.Layout.Grid.prototype=pv.extend(pv.Layout).property("rows").property("cols");pv.Layout.Grid.prototype.defaults=new pv.Layout.Grid().extend(pv.Layout.prototype.defaults).rows(1).cols(1);pv.Layout.Grid.prototype.buildImplied=function(s){pv.Layout.prototype.buildImplied.call(this,s);var r=s.rows,c=s.cols;if(typeof c=="object")r=pv.transpose(c);if(typeof r=="object"){s.$grid=pv.blend(r);s.rows=r.length;s.cols=r[0]?r[0].length:0}else{s.$grid=pv.repeat([s.data],r*c)}};pv.Layout.Stack=function(){pv.Layout.call(this);var that=this,none=function(){return null},prop={t:none,l:none,r:none,b:none,w:none,h:none},values,buildImplied=that.buildImplied;function proxy(name){return function(){return prop[name](this.parent.index,this.index)}}this.buildImplied=function(s){buildImplied.call(this,s);var data=s.layers,n=data.length,m,orient=s.orient,horizontal=/^(top|bottom)\/.test(orient),h=this.parent[horizontal?"height":"width"](),x=[],y=[],dy=[];var stack=pv.Mark.stack,o={parent:{parent:this}};stack.unshift(null);values=[];for(var i=0;i<n;i++){dy[i]=[];y[i]=[];o.parent.index=i;stack[0]=data[i];values[i]=this.$values.apply(o.parent,stack);if(!i)m=values[i].length;stack.unshift(null);for(var j=0;j<m;j++){stack[0]=values[i][j];o.index=j;if(!i)x[j]=this.$x.apply(o,stack);dy[i][j]=this.$y.apply(o,stack)}stack.shift()}stack.shift();var index;switch(s.order){case"inside-out":{var max=dy.map(function(v){return pv.max.index(v)}),map=pv.range(n).sort(function(a,b){return max[a]-max[b]}),sums=dy.map(function(v){return pv.sum(v)}),top=0,bottom=0,tops=[],bottoms=[];for(var i=0;i<n;i++){var j=map[i];if(top<bottom){top+=sums[j];tops.push(j)}else{bottom+=sums[j];bottoms.push(j)}}index=bottoms.reverse().concat(tops);break}case"reverse":index=pv.range(n-1,-1,-1);break;default:index=pv.range(n);break}switch(s.offset){case"silohouette":{for(var j=0;j<m;j++){var o=0;for(var i=0;i<n;i++)o+=dy[i][j];y[index[0]][j]=(h-o)/2}break}case"wiggle":{var o=0;for(var i=0;i<n;i++)o+=dy[i][0];y[index[0]][0]=o=(h-o)/2;for(var j=1;j<m;j++){var s1=0,s2=0,dx=x[j]-x[j-1];for(var i=0;i<n;i++)s1+=dy[i][j];for(var i=0;i<n;i++){var s3=(dy[index[i]][j]-dy[index[i]][j-1])/(2*dx);for(var k=0;k<i;k++){s3+=(dy[index[k]][j]-dy[index[k]][j-1])/dx}s2+=s3*dy[index[i]][j]}y[index[0]][j]=o-=s1?s2/s1*dx:0}break}case"expand":{for(var j=0;j<m;j++){y[index[0]][j]=0;var k=0;for(var i=0;i<n;i++)k+=dy[i][j];if(k){k=h/k;for(var i=0;i<n;i++)dy[i][j]*=k}else{k=h/n;for(var i=0;i<n;i++)dy[i][j]=k}}break}default:{for(var j=0;j<m;j++)y[index[0]][j]=0;break}}for(var j=0;j<m;j++){var o=y[index[0]][j];for(var i=1;i<n;i++){o+=dy[index[i-1]][j];y[index[i]][j]=o}}var i=orient.indexOf("-"),pdy=horizontal?"h":"w",px=i<0?(horizontal?"l":"b"):orient.charAt(i+1),py=orient.charAt(0);for(var p in prop)prop[p]=none;prop[px]=function(i,j){return x[j]};prop[py]=function(i,j){return y[i][j]};prop[pdy]=function(i,j){return dy[i][j]}};this.layer=new pv.Mark().data(function(){return values[this.parent.index]}).top(proxy("t")).left(proxy("l")).right(proxy("r")).bottom(proxy("b")).width(proxy("w")).height(proxy("h"));this.layer.add=function(type){return that.add(pv.Panel).data(function(){return that.layers()}).add(type).extend(this)}};pv.Layout.Stack.prototype=pv.extend(pv.Layout).property("orient",String).property("offset",String).property("order",String).property("layers");pv.Layout.Stack.prototype.defaults=new pv.Layout.Stack().extend(pv.Layout.prototype.defaults).orient("bottom-left").offset("zero").layers([[]]);pv.Layout.Stack.prototype.$x=pv.Layout.Stack.prototype.$y=function(){return 0};pv.Layout.Stack.prototype.x=function(f){this.$x=pv.functor(f);return this};pv.Layout.Stack.prototype.y=function(f){this.$y=pv.functor(f);return this};pv.Layout.Stack.prototype.$values=pv.identity;pv.Layout.Stack.prototype.values=function(f){this.$values=pv.functor(f);return this};pv.Layout.Band=function(){pv.Layout.call(this);var that=this,buildImplied=that.buildImplied,itemProps,values;var itemProto=new pv.Mark().data(function(){return values[this.parent.index]}).top(proxy("t")).left(proxy("l")).right(proxy("r")).bottom(proxy("b")).width(proxy("w")).height(proxy("h"));function proxy(name){return function(){return itemProps[name](this.index,this.parent.index)}}this.buildImplied=function(s){buildImplied.call(this,s);itemProps=Object.create(pv.Layout.Band.$baseItemProps);values=[];var data=s.layers,L=data.length;if(L>0){var orient=s.orient,horizontal=/^(top|bottom)\/.test(orient),bh=this.parent[horizontal?"height":"width"](),bands=this._readData(data,values,s),B=bands.length;if(s.bandOrder==="reverse"){bands.reverse()}if(s.order==="reverse"){values.reverse();for(var b=0;b<B;b++){bands[b].items.reverse()}}switch(s.layout){case"grouped":this._calcGrouped(bands,L,s);break;case"stacked":this._calcStacked(bands,L,bh,s);break}this._bindItemProps(bands,itemProps,orient,horizontal)}};var itemAccessor=this.item={end:this,add:function(type){return that.add(pv.Panel).data(function(){return that.layers()}).add(type).extend(itemProto)},order:function(value){that.order(value);return this},w:function(f){that.$iw=pv.functor(f);return this},h:function(f){that.$ih=pv.functor(f);return this},horizontalRatio:function(f){that.$ihorizRatio=pv.functor(f);return this},verticalMargin:function(f){that.$ivertiMargin=pv.functor(f);return this}};var bandAccessor=this.band={end:this,w:function(f){that.$bw=pv.functor(f);return this},x:function(f){that.$bx=pv.functor(f);return this},order:function(value){that.bandOrder(value);return this},differentialControl:function(f){that.$bDiffControl=pv.functor(f);return this}};this.band.item=itemAccessor;this.item.band=bandAccessor};pv.Layout.Band.$baseItemProps=(function(){var none=function(){return null};return{t:none,l:none,r:none,b:none,w:none,h:none}}());pv.Layout.Band.prototype=pv.extend(pv.Layout).property("orient",String).property("layout",String).property("layers").property("yZero",Number).property("verticalMode",String).property("horizontalMode",String).property("order",String).property("bandOrder",String);pv.Layout.Band.prototype.defaults=new pv.Layout.Band().extend(pv.Layout.prototype.defaults).orient("bottom-left").layout("grouped").yZero(0).layers([[]]);pv.Layout.Band.prototype.$bx=pv.Layout.Band.prototype.$bw=pv.Layout.Band.prototype.$bDiffControl=pv.Layout.Band.prototype.$iw=pv.Layout.Band.prototype.$ih=pv.Layout.Band.prototype.$ivertiMargin=pv.functor(0);pv.Layout.Band.prototype.$ihorizRatio=pv.functor(0.9);pv.Layout.Band.prototype.$values=pv.identity;pv.Layout.Band.prototype.values=function(f){this.$values=pv.functor(f);return this};pv.Layout.prototype._readData=function(data,layersValues,scene){var L=data.length,bands=[],B;var stack=pv.Mark.stack,o={parent:{parent:this}};stack.unshift(null);for(var l=0;l<L;l++){o.parent.index=l;stack[0]=data[l];var layerValues=layersValues[l]=this.$values.apply(o.parent,stack);if(!l){B=layerValues.length}stack.unshift(null);for(var b=0;b<B;b++){stack[0]=layerValues[b];o.index=b;var band=bands[b];if(!band){band=bands[b]={horizRatio:this.$ihorizRatio.apply(o,stack),vertiMargin:this.$ivertiMargin.apply(o,stack),w:this.$bw.apply(o,stack),x:this.$bx.apply(o,stack),diffControl:this.$bDiffControl?this.$bDiffControl.apply(o,stack):0,items:[]}}var ih=this.$ih.apply(o,stack);band.items[l]={y:(scene.yZero||0),x:0,w:this.$iw.apply(o,stack),h:ih!=null?Math.abs(ih):ih,dir:ih<0?-1:1}}stack.shift()}stack.shift();return bands};pv.Layout.Band.prototype._calcGrouped=function(bands,L,scene){for(var b=0,B=bands.length;b<B;b++){var band=bands[b],items=band.items,w=band.w,horizRatio=band.horizRatio,wItems=0;for(var l=0;l<L;l++){wItems+=items[l].w}if(L===1){horizRatio=1}else if(!(horizRatio>0&&horizRatio<=1)){horizRatio=1}if(w==null){w=band.w=wItems/horizRatio}else if(scene.horizontalMode==='expand'){var wItems2=horizRatio*w;if(wItems){var wScale=wItems2/wItems;for(var l=0;l<L;l++){items[l].w*=wScale}}else{var wiavg=wItems2/L;for(var l=0;l<L;l++){items[l].w=wiavg}}wItems=wItems2}var wItemsWithMargin=wItems/horizRatio,ix=band.x-(wItemsWithMargin/2),margin=L>1?((wItemsWithMargin-wItems)/(L-1)):0;for(var l=0;l<L;l++){var item=items[l];item.x=ix;ix+=item.w+margin;if(item.dir<0){item.y-=item.h}}}};pv.Layout.Band.prototype._calcStacked=function(bands,L,bh,scene){var B=bands.length,items;if(scene.verticalMode==="expand"){for(var b=0;b<B;b++){items=bands[b].items;var hSum=null,nonNullCount=0;for(var l=0;l<L;l++){var item=items[l];item.dir=1;var h=item.h;if(h!=null){nonNullCount++;hSum+=h}}if(nonNullCount){if(hSum){var hScale=bh/hSum;for(var l=0;l<L;l++){var h=items[l].h;if(h!=null){items[l].h=h*hScale}}}else{var hAvg=bh/nonNullCount;for(var l=0;l<L;l++){var h=items[l].h;if(h!=null){items[l].h=hAvg}}}}}}var yZero=scene.yZero,yOffset=yZero;for(var b=0;b<B;b++){var band=bands[b],bx=band.x,bDiffControl=band.diffControl,invertDir=(bDiffControl<0),vertiMargin=band.vertiMargin>0?band.vertiMargin:0;items=band.items;var resultPos=this._layoutItemsOfDir(+1,invertDir,items,vertiMargin,bx,yOffset),resultNeg;if(resultPos.existsOtherDir){resultNeg=this._layoutItemsOfDir(-1,invertDir,items,vertiMargin,bx,yOffset)}if(bDiffControl){if(Math.abs(bDiffControl)===1){var yOffset0=yOffset;yOffset=resultPos.yOffset;if(resultNeg){yOffset-=(yOffset0-resultNeg.yOffset)}}}else{yOffset=yZero}}};pv.Layout.Band.prototype._layoutItemsOfDir=function(stackDir,invertDir,items,vertiMargin,bx,yOffset){var existsOtherDir=false,vertiMargin2=vertiMargin/2,efDir=(invertDir?-stackDir:stackDir),reverseLayers=invertDir;for(var l=0,L=items.length;l<L;l+=1){var item=items[reverseLayers?(L-l-1):l];if(item.dir===stackDir){var h=item.h||0;if(efDir>0){item.y=yOffset+vertiMargin2;yOffset+=h}else{item.y=yOffset-(h-vertiMargin2);yOffset-=h}var h2=item.h-vertiMargin;item.h=h2>0?h2:0;item.x=bx-item.w/2}else{existsOtherDir=true}}return{existsOtherDir:existsOtherDir,yOffset:yOffset}};pv.Layout.Band.prototype._bindItemProps=function(bands,itemProps,orient,horizontal){var index=orient.indexOf("-"),ph=horizontal?"h":"w",pw=horizontal?"w":"h",px=index<0?(horizontal?"l":"b"):orient.charAt(index+1),py=orient.charAt(0);itemProps[px]=function(b,l){return bands[b].items[l].x};itemProps[py]=function(b,l){return bands[b].items[l].y};itemProps[pw]=function(b,l){return bands[b].items[l].w};itemProps[ph]=function(b,l){return bands[b].items[l].h||0}};pv.Layout.Treemap=function(){pv.Layout.Hierarchy.call(this);this.node.strokeStyle("#fff").fillStyle("rgba(31, 119, 180, .25)").width(function(n){return n.dx}).height(function(n){return n.dy});this.label.visible(function(n){return!n.firstChild}).left(function(n){return n.x+(n.dx/2)}).top(function(n){return n.y+(n.dy/2)}).textAlign("center").textAngle(function(n){return n.dx>n.dy?0:-Math.PI/2});(this.leaf=new pv.Mark().extend(this.node).fillStyle(null).strokeStyle(null).visible(function(n){return!n.firstChild})).parent=this;delete this.link};pv.Layout.Treemap.prototype=pv.extend(pv.Layout.Hierarchy).property("round",Boolean).property("paddingLeft",Number).property("paddingRight",Number).property("paddingTop",Number).property("paddingBottom",Number).property("mode",String).property("order",String);pv.Layout.Treemap.prototype.defaults=new pv.Layout.Treemap().extend(pv.Layout.Hierarchy.prototype.defaults).mode("squarify").order("ascending");pv.Layout.Treemap.prototype.padding=function(n){return this.paddingLeft(n).paddingRight(n).paddingTop(n).paddingBottom(n)};pv.Layout.Treemap.prototype.$size=function(d){return Number(d.nodeValue)};pv.Layout.Treemap.prototype.size=function(f){this.$size=pv.functor(f);return this};pv.Layout.Treemap.prototype.buildImplied=function(s){if(pv.Layout.Hierarchy.prototype.buildImplied.call(this,s))return;var that=this,nodes=s.nodes,root=nodes[0],stack=pv.Mark.stack,left=s.paddingLeft,right=s.paddingRight,top=s.paddingTop,bottom=s.paddingBottom,size=function(n){return n.size},round=s.round?Math.round:Number,mode=s.mode;function slice(row,sum,horizontal,x,y,w,h){for(var i=0,d=0;i<row.length;i++){var n=row[i];if(horizontal){n.x=x+d;n.y=y;d+=n.dx=round(w*n.size/sum);n.dy=h}else{n.x=x;n.y=y+d;n.dx=w;d+=n.dy=round(h*n.size/sum)}}if(n){if(horizontal){n.dx+=w-d}else{n.dy+=h-d}}}function ratio(row,l){var rmax=-Infinity,rmin=Infinity,s=0;for(var i=0;i<row.length;i++){var r=row[i].size;if(r<rmin)rmin=r;if(r>rmax)rmax=r;s+=r}s=s*s;l=l*l;return Math.max(l*rmax/s,s/(l*rmin))}function layout(n,i){var x=n.x+left,y=n.y+top,w=n.dx-left-right,h=n.dy-top-bottom;if(mode!="squarify"){slice(n.childNodes,n.size,mode=="slice"?true:mode=="dice"?false:i&1,x,y,w,h);return}var row=[],mink=Infinity,l=Math.min(w,h),k=w*h/n.size;if(n.size<=0)return;n.visitBefore(function(n){n.size*=k});function position(row){var horizontal=w==l,sum=pv.sum(row,size),r=l?round(sum/l):0;slice(row,sum,horizontal,x,y,horizontal?w:r,horizontal?r:h);if(horizontal){y+=r;h-=r}else{x+=r;w-=r}l=Math.min(w,h);return horizontal}var children=n.childNodes.slice();while(children.length){var child=children[children.length-1];if(!child.size){children.pop();continue}row.push(child);var k=ratio(row,l);if(k<=mink){children.pop();mink=k}else{row.pop();position(row);row.length=0;mink=Infinity}}if(position(row))for(var i=0;i<row.length;i++){row[i].dy+=h}else for(var i=0;i<row.length;i++){row[i].dx+=w}}stack.unshift(null);root.visitAfter(function(n,i){n.depth=i;n.x=n.y=n.dx=n.dy=0;n.size=n.firstChild?pv.sum(n.childNodes,function(n){return n.size}):that.$size.apply(that,(stack[0]=n,stack))});stack.shift();switch(s.order){case"ascending":{root.sort(function(a,b){return a.size-b.size});break}case"descending":{root.sort(function(a,b){return b.size-a.size});break}case"reverse":root.reverse();break}root.x=0;root.y=0;root.dx=s.width;root.dy=s.height;root.visitBefore(layout)};pv.Layout.Tree=function(){pv.Layout.Hierarchy.call(this)};pv.Layout.Tree.prototype=pv.extend(pv.Layout.Hierarchy).property("group",Number).property("breadth",Number).property("depth",Number).property("orient",String);pv.Layout.Tree.prototype.defaults=new pv.Layout.Tree().extend(pv.Layout.Hierarchy.prototype.defaults).group(1).breadth(15).depth(60).orient("top");pv.Layout.Tree.prototype.buildImplied=function(s){if(pv.Layout.Hierarchy.prototype.buildImplied.call(this,s))return;var nodes=s.nodes,orient=s.orient,depth=s.depth,breadth=s.breadth,group=s.group,w=s.width,h=s.height;function firstWalk(v){var l,r,a;if(!v.firstChild){if(l=v.previousSibling){v.prelim=l.prelim+distance(v.depth,true)}}else{l=v.firstChild;r=v.lastChild;a=l;for(var c=l;c;c=c.nextSibling){firstWalk(c);a=apportion(c,a)}executeShifts(v);var midpoint=.5*(l.prelim+r.prelim);if(l=v.previousSibling){v.prelim=l.prelim+distance(v.depth,true);v.mod=v.prelim-midpoint}else{v.prelim=midpoint}}}function secondWalk(v,m,depth){v.breadth=v.prelim+m;m+=v.mod;for(var c=v.firstChild;c;c=c.nextSibling){secondWalk(c,m,depth)}}function apportion(v,a){var w=v.previousSibling;if(w){var vip=v,vop=v,vim=w,vom=v.parentNode.firstChild,sip=vip.mod,sop=vop.mod,sim=vim.mod,som=vom.mod,nr=nextRight(vim),nl=nextLeft(vip);while(nr&&nl){vim=nr;vip=nl;vom=nextLeft(vom);vop=nextRight(vop);vop.ancestor=v;var shift=(vim.prelim+sim)-(vip.prelim+sip)+distance(vim.depth,false);if(shift>0){moveSubtree(ancestor(vim,v,a),v,shift);sip+=shift;sop+=shift}sim+=vim.mod;sip+=vip.mod;som+=vom.mod;sop+=vop.mod;nr=nextRight(vim);nl=nextLeft(vip)}if(nr&&!nextRight(vop)){vop.thread=nr;vop.mod+=sim-sop}if(nl&&!nextLeft(vom)){vom.thread=nl;vom.mod+=sip-som;a=v}}return a}function nextLeft(v){return v.firstChild||v.thread}function nextRight(v){return v.lastChild||v.thread}function moveSubtree(wm,wp,shift){var subtrees=wp.number-wm.number;wp.change-=shift/subtrees;wp.shift+=shift;wm.change+=shift/subtrees;wp.prelim+=shift;wp.mod+=shift}function executeShifts(v){var shift=0,change=0;for(var c=v.lastChild;c;c=c.previousSibling){c.prelim+=shift;c.mod+=shift;change+=c.change;shift+=c.shift+change}}function ancestor(vim,v,a){return(vim.ancestor.parentNode==v.parentNode)?vim.ancestor:a}function distance(depth,siblings){return(siblings?1:(group+1))/((orient=="radial")?depth:1)}var root=nodes[0];root.visitAfter(function(v,i){v.ancestor=v;v.prelim=0;v.mod=0;v.change=0;v.shift=0;v.number=v.previousSibling?(v.previousSibling.number+1):0;v.depth=i});firstWalk(root);secondWalk(root,-root.prelim,0);function midAngle(n){return(orient=="radial")?n.breadth/depth:0}function x(n){switch(orient){case"left":return n.depth;case"right":return w-n.depth;case"top":case"bottom":return n.breadth+w/2;case"radial":return w/2+n.depth*Math.cos(midAngle(n))}}function y(n){switch(orient){case"left":case"right":return n.breadth+h/2;case"top":return n.depth;case"bottom":return h-n.depth;case"radial":return h/2+n.depth*Math.sin(midAngle(n))}}root.visitAfter(function(v){v.breadth*=breadth;v.depth*=depth;v.midAngle=midAngle(v);v.x=x(v);v.y=y(v);if(v.firstChild)v.midAngle+=Math.PI;delete v.breadth;delete v.depth;delete v.ancestor;delete v.prelim;delete v.mod;delete v.change;delete v.shift;delete v.number;delete v.thread})};pv.Layout.Indent=function(){pv.Layout.Hierarchy.call(this);this.link.interpolate("step-after")};pv.Layout.Indent.prototype=pv.extend(pv.Layout.Hierarchy).property("depth",Number).property("breadth",Number);pv.Layout.Indent.prototype.defaults=new pv.Layout.Indent().extend(pv.Layout.Hierarchy.prototype.defaults).depth(15).breadth(15);pv.Layout.Indent.prototype.buildImplied=function(s){if(pv.Layout.Hierarchy.prototype.buildImplied.call(this,s))return;var nodes=s.nodes,bspace=s.breadth,dspace=s.depth,ax=0,ay=0;function position(n,breadth,depth){n.x=ax+depth++*dspace;n.y=ay+breadth++*bspace;n.midAngle=0;for(var c=n.firstChild;c;c=c.nextSibling){breadth=position(c,breadth,depth)}return breadth}position(nodes[0],1,1)};pv.Layout.Pack=function(){pv.Layout.Hierarchy.call(this);this.node.shapeRadius(function(n){return n.radius}).strokeStyle("rgb(31, 119, 180)").fillStyle("rgba(31, 119, 180, .25)");this.label.textAlign("center");delete this.link};pv.Layout.Pack.prototype=pv.extend(pv.Layout.Hierarchy).property("spacing",Number).property("order",String);pv.Layout.Pack.prototype.defaults=new pv.Layout.Pack().extend(pv.Layout.Hierarchy.prototype.defaults).spacing(1).order("ascending");pv.Layout.Pack.prototype.$radius=function(){return 1};pv.Layout.Pack.prototype.size=function(f){this.$radius=typeof f=="function"?function(){return Math.sqrt(f.apply(this,arguments))}:(f=Math.sqrt(f),function(){return f});return this};pv.Layout.Pack.prototype.buildImplied=function(s){if(pv.Layout.Hierarchy.prototype.buildImplied.call(this,s))return;var that=this,nodes=s.nodes,root=nodes[0];function radii(nodes){var stack=pv.Mark.stack;stack.unshift(null);for(var i=0,n=nodes.length;i<n;i++){var c=nodes[i];if(!c.firstChild){c.radius=that.$radius.apply(that,(stack[0]=c,stack))}}stack.shift()}function packTree(n){var nodes=[];for(var c=n.firstChild;c;c=c.nextSibling){if(c.firstChild)c.radius=packTree(c);c.n=c.p=c;nodes.push(c)}switch(s.order){case"ascending":{nodes.sort(function(a,b){return a.radius-b.radius});break}case"descending":{nodes.sort(function(a,b){return b.radius-a.radius});break}case"reverse":nodes.reverse();break}return packCircle(nodes)}function packCircle(nodes){var xMin=Infinity,xMax=-Infinity,yMin=Infinity,yMax=-Infinity,a,b,c,j,k;function bound(n){xMin=Math.min(n.x-n.radius,xMin);xMax=Math.max(n.x+n.radius,xMax);yMin=Math.min(n.y-n.radius,yMin);yMax=Math.max(n.y+n.radius,yMax)}function insert(a,b){var c=a.n;a.n=b;b.p=a;b.n=c;c.p=b}function splice(a,b){a.n=b;b.p=a}function intersects(a,b){var dx=b.x-a.x,dy=b.y-a.y,dr=a.radius+b.radius;return(dr*dr-dx*dx-dy*dy)>.001}a=nodes[0];a.x=-a.radius;a.y=0;bound(a);if(nodes.length>1){b=nodes[1];b.x=b.radius;b.y=0;bound(b);if(nodes.length>2){c=nodes[2];place(a,b,c);bound(c);insert(a,c);a.p=c;insert(c,b);b=a.n;for(var i=3;i<nodes.length;i++){place(a,b,c=nodes[i]);var isect=0,s1=1,s2=1;for(j=b.n;j!=b;j=j.n,s1++){if(intersects(j,c)){isect=1;break}}if(isect==1){for(k=a.p;k!=j.p;k=k.p,s2++){if(intersects(k,c)){if(s2<s1){isect=-1;j=k}break}}}if(isect==0){insert(a,c);b=c;bound(c)}else if(isect>0){splice(a,j);b=j;i--}else if(isect<0){splice(j,b);a=j;i--}}}}var cx=(xMin+xMax)/2,cy=(yMin+yMax)/2,cr=0;for(var i=0;i<nodes.length;i++){var n=nodes[i];n.x-=cx;n.y-=cy;cr=Math.max(cr,n.radius+Math.sqrt(n.x*n.x+n.y*n.y))}return cr+s.spacing}function place(a,b,c){var da=b.radius+c.radius,db=a.radius+c.radius,dx=b.x-a.x,dy=b.y-a.y,dc=Math.sqrt(dx*dx+dy*dy),cos=(db*db+dc*dc-da*da)/(2*db*dc),theta=Math.acos(cos),x=cos*db,h=Math.sin(theta)*db;dx/=dc;dy/=dc;c.x=a.x+x*dx+h*dy;c.y=a.y+x*dy-h*dx}function transform(n,x,y,k){for(var c=n.firstChild;c;c=c.nextSibling){c.x+=n.x;c.y+=n.y;transform(c,x,y,k)}n.x=x+k*n.x;n.y=y+k*n.y;n.radius*=k}radii(nodes);root.x=0;root.y=0;root.radius=packTree(root);var w=this.width(),h=this.height(),k=1/Math.max(2*root.radius/ w, 2 * root.radius /h);transform(root,w/2,h/2,k)};pv.Layout.Force=function(){pv.Layout.Network.call(this);this.link.lineWidth(function(d,p){return Math.sqrt(p.linkValue)*1.5});this.label.textAlign("center")};pv.Layout.Force.prototype=pv.extend(pv.Layout.Network).property("bound",Boolean).property("iterations",Number).property("dragConstant",Number).property("chargeConstant",Number).property("chargeMinDistance",Number).property("chargeMaxDistance",Number).property("chargeTheta",Number).property("springConstant",Number).property("springDamping",Number).property("springLength",Number);pv.Layout.Force.prototype.defaults=new pv.Layout.Force().extend(pv.Layout.Network.prototype.defaults).dragConstant(.1).chargeConstant(-40).chargeMinDistance(2).chargeMaxDistance(500).chargeTheta(.9).springConstant(.1).springDamping(.3).springLength(20);pv.Layout.Force.prototype.buildImplied=function(s){if(pv.Layout.Network.prototype.buildImplied.call(this,s)){var f=s.$force;if(f){f.next=this.binds.$force;this.binds.$force=f}return}var that=this,nodes=s.nodes,links=s.links,k=s.iterations,w=s.width,h=s.height;for(var i=0,n;i<nodes.length;i++){n=nodes[i];if(isNaN(n.x))n.x=w/2+40*Math.random()-20;if(isNaN(n.y))n.y=h/2+40*Math.random()-20}var sim=pv.simulation(nodes);sim.force(pv.Force.drag(s.dragConstant));sim.force(pv.Force.charge(s.chargeConstant).domain(s.chargeMinDistance,s.chargeMaxDistance).theta(s.chargeTheta));sim.force(pv.Force.spring(s.springConstant).damping(s.springDamping).length(s.springLength).links(links));sim.constraint(pv.Constraint.position());if(s.bound){sim.constraint(pv.Constraint.bound().x(6,w-6).y(6,h-6))}function speed(n){return n.fix?1:n.vx*n.vx+n.vy*n.vy}if(k==null){sim.step();sim.step();var force=s.$force=this.binds.$force={next:this.binds.$force,nodes:nodes,min:1e-4*(links.length+1),sim:sim};if(!this.$timer)this.$timer=setInterval(function(){var render=false;for(var f=that.binds.$force;f;f=f.next){if(pv.max(f.nodes,speed)>f.min){f.sim.step();render=true}}if(render)that.render()},42)}else for(var i=0;i<k;i++){sim.step()}};pv.Layout.Cluster=function(){pv.Layout.Hierarchy.call(this);var interpolate,buildImplied=this.buildImplied;this.buildImplied=function(s){buildImplied.call(this,s);interpolate=/^(top|bottom)$/.test(s.orient)?"step-before":/^(left|right)$/.test(s.orient)?"step-after":"linear"};this.link.interpolate(function(){return interpolate})};pv.Layout.Cluster.prototype=pv.extend(pv.Layout.Hierarchy).property("group",Number).property("orient",String).property("innerRadius",Number).property("outerRadius",Number);pv.Layout.Cluster.prototype.defaults=new pv.Layout.Cluster().extend(pv.Layout.Hierarchy.prototype.defaults).group(0).orient("top");pv.Layout.Cluster.prototype.buildImplied=function(s){if(pv.Layout.Hierarchy.prototype.buildImplied.call(this,s))return;var root=s.nodes[0],group=s.group,breadth,depth,leafCount=0,leafIndex=.5-group/2;var p=undefined;root.visitAfter(function(n){if(n.firstChild){n.depth=1+pv.max(n.childNodes,function(n){return n.depth})}else{if(group&&(p!=n.parentNode)){p=n.parentNode;leafCount+=group}leafCount++;n.depth=0}});breadth=1/leafCount;depth=1/root.depth;var p=undefined;root.visitAfter(function(n){if(n.firstChild){n.breadth=pv.mean(n.childNodes,function(n){return n.breadth})}else{if(group&&(p!=n.parentNode)){p=n.parentNode;leafIndex+=group}n.breadth=breadth*leafIndex++}n.depth=1-n.depth*depth});root.visitAfter(function(n){n.minBreadth=n.firstChild?n.firstChild.minBreadth:(n.breadth-breadth/2);n.maxBreadth=n.firstChild?n.lastChild.maxBreadth:(n.breadth+breadth/2)});root.visitBefore(function(n){n.minDepth=n.parentNode?n.parentNode.maxDepth:0;n.maxDepth=n.parentNode?(n.depth+root.depth):(n.minDepth+2*root.depth)});root.minDepth=-depth;pv.Layout.Hierarchy.NodeLink.buildImplied.call(this,s)};pv.Layout.Cluster.Fill=function(){pv.Layout.Cluster.call(this);pv.Layout.Hierarchy.Fill.constructor.call(this)};pv.Layout.Cluster.Fill.prototype=pv.extend(pv.Layout.Cluster);pv.Layout.Cluster.Fill.prototype.buildImplied=function(s){if(pv.Layout.Cluster.prototype.buildImplied.call(this,s))return;pv.Layout.Hierarchy.Fill.buildImplied.call(this,s)};pv.Layout.Partition=function(){pv.Layout.Hierarchy.call(this)};pv.Layout.Partition.prototype=pv.extend(pv.Layout.Hierarchy).property("order",String).property("orient",String).property("innerRadius",Number).property("outerRadius",Number);pv.Layout.Partition.prototype.defaults=new pv.Layout.Partition().extend(pv.Layout.Hierarchy.prototype.defaults).orient("top");pv.Layout.Partition.prototype.$size=function(){return 1};pv.Layout.Partition.prototype.size=function(f){this.$size=f;return this};pv.Layout.Partition.prototype.buildImplied=function(s){if(pv.Layout.Hierarchy.prototype.buildImplied.call(this,s))return;var that=this,root=s.nodes[0],stack=pv.Mark.stack,maxDepth=0;stack.unshift(null);root.visitAfter(function(n,depth){if(depth>maxDepth)maxDepth=depth;n.size=n.firstChild?pv.sum(n.childNodes,function(n){return n.size}):that.$size.apply(that,(stack[0]=n,stack))});stack.shift();switch(s.order){case"ascending":root.sort(function(a,b){return a.size-b.size});break;case"descending":root.sort(function(b,a){return a.size-b.size});break}root.minBreadth=0;root.breadth=.5;root.maxBreadth=1;root.visitBefore(function(n){var b=n.minBreadth,s=n.maxBreadth-b;for(var c=n.firstChild;c;c=c.nextSibling){c.minBreadth=b;b+=(c.size/n.size)*s;c.maxBreadth=b;c.breadth=(b+c.minBreadth)/2}});root.visitAfter(function(n,depth){n.minDepth=(depth-1)/maxDepth;n.maxDepth=(n.depth=depth/maxDepth)});pv.Layout.Hierarchy.NodeLink.buildImplied.call(this,s)};pv.Layout.Partition.Fill=function(){pv.Layout.Partition.call(this);pv.Layout.Hierarchy.Fill.constructor.call(this)};pv.Layout.Partition.Fill.prototype=pv.extend(pv.Layout.Partition);pv.Layout.Partition.Fill.prototype.buildImplied=function(s){if(pv.Layout.Partition.prototype.buildImplied.call(this,s))return;pv.Layout.Hierarchy.Fill.buildImplied.call(this,s)};pv.Layout.Arc=function(){pv.Layout.Network.call(this);var interpolate,directed,reverse,buildImplied=this.buildImplied;this.buildImplied=function(s){buildImplied.call(this,s);directed=s.directed;interpolate=s.orient=="radial"?"linear":"polar";reverse=s.orient=="right"||s.orient=="top"};this.link.data(function(p){var s=p.sourceNode,t=p.targetNode;return reverse!=(directed||(s.breadth<t.breadth))?[s,t]:[t,s]}).interpolate(function(){return interpolate})};pv.Layout.Arc.prototype=pv.extend(pv.Layout.Network).property("orient",String).property("directed",Boolean);pv.Layout.Arc.prototype.defaults=new pv.Layout.Arc().extend(pv.Layout.Network.prototype.defaults).orient("bottom");pv.Layout.Arc.prototype.sort=function(f){this.$sort=f;return this};pv.Layout.Arc.prototype.buildImplied=function(s){if(pv.Layout.Network.prototype.buildImplied.call(this,s))return;var nodes=s.nodes,orient=s.orient,sort=this.$sort,index=pv.range(nodes.length),w=s.width,h=s.height,r=Math.min(w,h)/2;if(sort)index.sort(function(a,b){return sort(nodes[a],nodes[b])});function midAngle(b){switch(orient){case"top":return-Math.PI/2;case"bottom":return Math.PI/2;case"left":return Math.PI;case"right":return 0;case"radial":return(b-.25)*2*Math.PI}}function x(b){switch(orient){case"top":case"bottom":return b*w;case"left":return 0;case"right":return w;case"radial":return w/2+r*Math.cos(midAngle(b))}}function y(b){switch(orient){case"top":return 0;case"bottom":return h;case"left":case"right":return b*h;case"radial":return h/2+r*Math.sin(midAngle(b))}}for(var i=0;i<nodes.length;i++){var n=nodes[index[i]],b=n.breadth=(i+.5)/nodes.length;n.x=x(b);n.y=y(b);n.midAngle=midAngle(b)}};pv.Layout.Horizon=function(){pv.Layout.call(this);var that=this,bands,mode,size,fill,red,blue,buildImplied=this.buildImplied;this.buildImplied=function(s){buildImplied.call(this,s);bands=s.bands;mode=s.mode;size=Math.round((mode=="color"?.5:1)*s.height);fill=s.backgroundStyle;red=pv.ramp(fill,s.negativeStyle).domain(0,bands);blue=pv.ramp(fill,s.positiveStyle).domain(0,bands)};var bands=new pv.Panel().data(function(){return pv.range(bands*2)}).overflow("hidden").height(function(){return size}).top(function(i){return mode=="color"?(i&1)*size:0}).fillStyle(function(i){return i?null:fill});this.band=new pv.Mark().top(function(d,i){return mode=="mirror"&&i&1?(i+1>>1)*size:null}).bottom(function(d,i){return mode=="mirror"?(i&1?null:(i+1>>1)*-size):((i&1||-1)*(i+1>>1)*size)}).fillStyle(function(d,i){return(i&1?red:blue)((i>>1)+1)});this.band.add=function(type){return that.add(pv.Panel).extend(bands).add(type).extend(this)}};pv.Layout.Horizon.prototype=pv.extend(pv.Layout).property("bands",Number).property("mode",String).property("backgroundStyle",pv.color).property("positiveStyle",pv.color).property("negativeStyle",pv.color);pv.Layout.Horizon.prototype.defaults=new pv.Layout.Horizon().extend(pv.Layout.prototype.defaults).bands(2).mode("offset").backgroundStyle("white").positiveStyle("#1f77b4").negativeStyle("#d62728");pv.Layout.Rollup=function(){pv.Layout.Network.call(this);var that=this,nodes,links,buildImplied=that.buildImplied;this.buildImplied=function(s){buildImplied.call(this,s);nodes=s.$rollup.nodes;links=s.$rollup.links};this.node.data(function(){return nodes}).shapeSize(function(d){return d.nodes.length*20});this.link.interpolate("polar").eccentricity(.8);this.link.add=function(type){return that.add(pv.Panel).data(function(){return links}).add(type).extend(this)}};pv.Layout.Rollup.prototype=pv.extend(pv.Layout.Network).property("directed",Boolean);pv.Layout.Rollup.prototype.x=function(f){this.$x=pv.functor(f);return this};pv.Layout.Rollup.prototype.y=function(f){this.$y=pv.functor(f);return this};pv.Layout.Rollup.prototype.buildImplied=function(s){if(pv.Layout.Network.prototype.buildImplied.call(this,s))return;var nodes=s.nodes,links=s.links,directed=s.directed,n=nodes.length,x=[],y=[],rnindex=0,rnodes={},rlinks={};function id(i){return x[i]+","+y[i]}var stack=pv.Mark.stack,o={parent:this};stack.unshift(null);for(var i=0;i<n;i++){o.index=i;stack[0]=nodes[i];x[i]=this.$x.apply(o,stack);y[i]=this.$y.apply(o,stack)}stack.shift();for(var i=0;i<nodes.length;i++){var nodeId=id(i),rn=rnodes[nodeId];if(!rn){rn=rnodes[nodeId]=pv.extend(nodes[i]);rn.index=rnindex++;rn.x=x[i];rn.y=y[i];rn.nodes=[]}rn.nodes.push(nodes[i])}for(var i=0;i<links.length;i++){var source=links[i].sourceNode,target=links[i].targetNode,rsource=rnodes[id(source.index)],rtarget=rnodes[id(target.index)],reverse=!directed&&rsource.index>rtarget.index,linkId=reverse?rtarget.index+","+rsource.index:rsource.index+","+rtarget.index,rl=rlinks[linkId];if(!rl){rl=rlinks[linkId]={sourceNode:rsource,targetNode:rtarget,linkValue:0,links:[]}}rl.links.push(links[i]);rl.linkValue+=links[i].linkValue}s.$rollup={nodes:pv.values(rnodes),links:pv.values(rlinks)}};pv.Layout.Matrix=function(){pv.Layout.Network.call(this);var that=this,n,dx,dy,labels,pairs,buildImplied=that.buildImplied;this.buildImplied=function(s){buildImplied.call(this,s);n=s.nodes.length;dx=s.width/n;dy=s.height/n;labels=s.$matrix.labels;pairs=s.$matrix.pairs};this.link.data(function(){return pairs}).left(function(){return dx*(this.index%n)}).top(function(){return dy*Math.floor(this.index/n)}).width(function(){return dx}).height(function(){return dy}).lineWidth(1.5).strokeStyle("#fff").fillStyle(function(l){return l.linkValue?"#555":"#eee"}).parent=this;delete this.link.add;this.label.data(function(){return labels}).left(function(){return this.index&1?dx*((this.index>>1)+.5):0}).top(function(){return this.index&1?0:dy*((this.index>>1)+.5)}).textMargin(4).textAlign(function(){return this.index&1?"left":"right"}).textAngle(function(){return this.index&1?-Math.PI/2:0});delete this.node};pv.Layout.Matrix.prototype=pv.extend(pv.Layout.Network).property("directed",Boolean);pv.Layout.Matrix.prototype.sort=function(f){this.$sort=f;return this};pv.Layout.Matrix.prototype.buildImplied=function(s){if(pv.Layout.Network.prototype.buildImplied.call(this,s))return;var nodes=s.nodes,links=s.links,sort=this.$sort,n=nodes.length,index=pv.range(n),labels=[],pairs=[],map={};s.$matrix={labels:labels,pairs:pairs};if(sort)index.sort(function(a,b){return sort(nodes[a],nodes[b])});for(var i=0;i<n;i++){for(var j=0;j<n;j++){var a=index[i],b=index[j],p={row:i,col:j,sourceNode:nodes[a],targetNode:nodes[b],linkValue:0};pairs.push(map[a+"."+b]=p)}}for(var i=0;i<n;i++){var a=index[i];labels.push(nodes[a],nodes[a])}for(var i=0;i<links.length;i++){var l=links[i],source=l.sourceNode.index,target=l.targetNode.index,value=l.linkValue;map[source+"."+target].linkValue+=value;if(!s.directed)map[target+"."+source].linkValue+=value}};pv.Layout.Bullet=function(){pv.Layout.call(this);var that=this,buildImplied=that.buildImplied,scale=that.x=pv.Scale.linear(),orient,horizontal,rangeColor,measureColor,x;this.buildImplied=function(s){buildImplied.call(this,x=s);orient=s.orient;horizontal=/^left|right$/.test(orient);rangeColor=pv.ramp("#bbb","#eee").domain(0,Math.max(1,x.ranges.length-1));measureColor=pv.ramp("steelblue","lightsteelblue").domain(0,Math.max(1,x.measures.length-1))};(this.range=new pv.Mark()).data(function(){return x.ranges}).reverse(true).left(function(){return orient=="left"?0:null}).top(function(){return orient=="top"?0:null}).right(function(){return orient=="right"?0:null}).bottom(function(){return orient=="bottom"?0:null}).width(function(d){return horizontal?scale(d):null}).height(function(d){return horizontal?null:scale(d)}).fillStyle(function(){return rangeColor(this.index)}).antialias(false).parent=that;(this.measure=new pv.Mark()).extend(this.range).data(function(){return x.measures}).left(function(){return orient=="left"?0:horizontal?null:this.parent.width()/3.25}).top(function(){return orient=="top"?0:horizontal?this.parent.height()/3.25:null}).right(function(){return orient=="right"?0:horizontal?null:this.parent.width()/3.25}).bottom(function(){return orient=="bottom"?0:horizontal?this.parent.height()/3.25:null}).fillStyle(function(){return measureColor(this.index)}).parent=that;(this.marker=new pv.Mark()).data(function(){return x.markers}).left(function(d){return orient=="left"?scale(d):horizontal?null:this.parent.width()/2}).top(function(d){return orient=="top"?scale(d):horizontal?this.parent.height()/2:null}).right(function(d){return orient=="right"?scale(d):null}).bottom(function(d){return orient=="bottom"?scale(d):null}).strokeStyle("black").shape("bar").shapeAngle(function(){return horizontal?0:Math.PI/2}).parent=that;(this.tick=new pv.Mark()).data(function(){return scale.ticks(7)}).left(function(d){return orient=="left"?scale(d):null}).top(function(d){return orient=="top"?scale(d):null}).right(function(d){return orient=="right"?scale(d):horizontal?null:-6}).bottom(function(d){return orient=="bottom"?scale(d):horizontal?-8:null}).height(function(){return horizontal?6:null}).width(function(){return horizontal?null:6}).parent=that};pv.Layout.Bullet.prototype=pv.extend(pv.Layout).property("orient",String).property("ranges").property("markers").property("measures").property("maximum",Number);pv.Layout.Bullet.prototype.defaults=new pv.Layout.Bullet().extend(pv.Layout.prototype.defaults).orient("left").ranges([]).markers([]).measures([]);pv.Layout.Bullet.prototype.buildImplied=function(s){pv.Layout.prototype.buildImplied.call(this,s);var size=this.parent[/^left|right$/.test(s.orient)?"width":"height"]();s.maximum=s.maximum||pv.max([].concat(s.ranges,s.markers,s.measures));this.x.domain(0,s.maximum).range(0,size)};pv.Behavior={};pv.Behavior.dragBase=function(shared){var events,downElem,cancelClick,inited,drag;shared.autoRender=true;shared.positionConstraint=null;shared.bound=function(v,a_p){return Math.max(drag.min[a_p],Math.min(drag.max[a_p],v))};function mousedown(d){if(!inited){inited=true;this.addEventInterceptor('click',eventInterceptor,true)}if(!events){var root=this.root.scene.$g;events=[[root,'mousemove',pv.listen(root,'mousemove',mousemove)],[root,'mouseup',pv.listen(root,'mouseup',mouseup)],[document,'mousemove',pv.listen(document,'mousemove',mousemove)],[document,'mouseup',pv.listen(document,'mouseup',mouseup)]]}var ev=arguments[arguments.length-1];downElem=ev.target;cancelClick=false;ev.stopPropagation();var m1=this.mouse();var scene=this.scene;var index=this.index;drag=scene[index].drag={phase:'start',m:m1,m1:m1,m2:null,d:d,scene:scene,index:index};ev=wrapEvent(ev,drag);shared.dragstart.call(this,ev);var m=drag.m;if(m!==m1){m1.x=m.x;m1.y=m.y}}function mousemove(ev){if(!drag){return}drag.phase='move';ev.stopPropagation();ev=wrapEvent(ev,drag);var scene=drag.scene;scene.mark.context(scene,drag.index,function(){var mprev=drag.m2||drag.m1;var m2=this.mouse();if(mprev&&m2.distance2(mprev).dist2<=2){return}drag.m=drag.m2=m2;shared.drag.call(this,ev);var m=drag.m;if(m!==m2){m2.x=m.x;m2.y=m.y}})}function mouseup(ev){if(!drag){return}drag.phase='end';var m2=drag.m2;var isDrag=m2&&drag.m1.distance2(m2).dist2>0.1;drag.canceled=!isDrag;cancelClick=isDrag&&(downElem===ev.target);if(!cancelClick){downElem=null}ev.stopPropagation();ev=wrapEvent(ev,drag);if(events){events.forEach(function(registration){pv.unlisten.apply(pv,registration)});events=null}var scene=drag.scene;var index=drag.index;try{scene.mark.context(scene,index,function(){shared.dragend.call(this,ev)})}finally{drag=null;delete scene[index].drag}}function wrapEvent(ev,drag){try{ev.drag=drag;return ev}catch(ex){}var ev2={};for(var p in ev){var v=ev[p];ev2[p]=typeof v!=='function'?v:bindEventFun(f,ev)}ev2._sourceEvent=ev;return ev2}function bindEventFun(f,ctx){return function(){return f.apply(ctx,arguments)}}function eventInterceptor(type,ev){if(cancelClick&&downElem===ev.target){cancelClick=false;downElem=null;return false}}mousedown.autoRender=function(_){if(arguments.length){shared.autoRender=!!_;return mousedown}return shared.autoRender};mousedown.positionConstraint=function(_){if(arguments.length){shared.positionConstraint=_;return mousedown}return shared.positionConstraint};return mousedown};pv.Behavior.drag=function(){var collapse=null;var kx=1;var ky=1;var v1;var shared={dragstart:function(ev){var drag=ev.drag;drag.type='drag';var p=drag.d;var fix=pv.vector(p.x,p.y);p.fix=fix;p.drag=drag;v1=fix.minus(drag.m1);var parent=this.parent;drag.max={x:parent.width()-(p.dx||0),y:parent.height()-(p.dy||0)};drag.min={x:0,y:0};if(shared.autoRender){this.render()}pv.Mark.dispatch("dragstart",drag.scene,drag.index,ev)},drag:function(ev){var drag=ev.drag;var m2=drag.m2;var p=drag.d;drag.m=v1.plus(m2);var constraint=shared.positionConstraint;if(constraint){constraint(drag)}var m=drag.m;if(kx){p.x=p.fix.x=shared.bound(m.x,'x')}if(ky){p.y=p.fix.y=shared.bound(m.y,'y')}if(shared.autoRender){this.render()}pv.Mark.dispatch("drag",drag.scene,drag.index,ev)},dragend:function(ev){var drag=ev.drag;var p=drag.d;p.fix=null;v1=null;if(shared.autoRender){this.render()}try{pv.Mark.dispatch('dragend',drag.scene,drag.index,ev)}finally{delete p.drag}}};var mousedown=pv.Behavior.dragBase(shared);mousedown.collapse=function(x){if(arguments.length){collapse=String(x);switch(collapse){case"y":kx=1;ky=0;break;case"x":kx=0;ky=1;break;default:kx=1;ky=1;break}return mousedown}return collapse};return mousedown};pv.Behavior.point=function(r){var unpoint,collapse=null,kx=1,ky=1,pointingPanel=null,r2=arguments.length?r*r:900;function search(scene,index){var s=scene[index],point={cost:Infinity};for(var i=(s.visible?s.children.length:0)-1;i>=0;i--){var child=s.children[i],mark=child.mark,p;if(mark.type=="panel"){mark.scene=child;for(var j=child.length-1;j>=0;j--){mark.index=j;p=search(child,j);if(p.cost<point.cost)point=p}delete mark.scene;delete mark.index}else if(mark.$handlers.point){var v=mark.mouse();for(var j=child.length-1;j>=0;j--){var c=child[j],dx=v.x-c.left-(c.width||0)/2,dy=v.y-c.top-(c.height||0)/2,dd=kx*dx*dx+ky*dy*dy;if(dd<point.cost){point.distance=dx*dx+dy*dy;point.cost=dd;point.scene=child;point.index=j}}}}return point}function mousemove(e){var point=search(this.scene,this.index);if((point.cost==Infinity)||(point.distance>r2))point=null;if(unpoint){if(point&&(unpoint.scene==point.scene)&&(unpoint.index==point.index))return;pv.Mark.dispatch("unpoint",unpoint.scene,unpoint.index,e)}if(unpoint=point){pv.Mark.dispatch("point",point.scene,point.index,e);if(!pointingPanel&&this.type==='panel'){pointingPanel=this;pointingPanel.event('mouseout',function(){var ev=arguments[arguments.length-1];mouseout.call(pointingPanel.scene.$g,ev)})}else{pv.listen(this.root.canvas(),"mouseout",mouseout)}}}function mouseout(e){if(unpoint&&!pv.ancestor(this,e.relatedTarget)){pv.Mark.dispatch("unpoint",unpoint.scene,unpoint.index,e);unpoint=null}}mousemove.collapse=function(x){if(arguments.length){collapse=String(x);switch(collapse){case"y":kx=1;ky=0;break;case"x":kx=0;ky=1;break;default:kx=1;ky=1;break}return mousemove}return collapse};return mousemove};pv.Behavior.select=function(){var collapse=null;var kx=1;var ky=1;var preserveLength=false;var shared={dragstart:function(ev){var drag=ev.drag;drag.type='select';var r=drag.d;r.drag=drag;drag.max={x:this.width(),y:this.height()};drag.min={x:0,y:0};var constraint=shared.positionConstraint;if(constraint){drag.m=drag.m.clone();constraint(drag)}var m=drag.m;if(kx){r.x=shared.bound(m.x,'x');if(!preserveLength){r.dx=0}}if(ky){r.y=shared.bound(m.y,'y');if(!preserveLength){r.dy=0}}pv.Mark.dispatch('selectstart',drag.scene,drag.index,ev)},drag:function(ev){var drag=ev.drag;var m1=drag.m1;var r=drag.d;drag.max.x=this.width();drag.max.y=this.height();var constraint=shared.positionConstraint;if(constraint){drag.m=drag.m.clone();constraint(drag)}var m=drag.m;if(kx){var bx=Math.min(m1.x,m.x);bx=shared.bound(bx,'x');r.x=bx;if(!preserveLength){var ex=Math.max(m.x,m1.x);ex=shared.bound(ex,'x');r.dx=ex-bx}}if(ky){var by=Math.min(m1.y,m.y);by=shared.bound(by,'y');r.y=by;if(!preserveLength){var ey=Math.max(m.y,m1.y);ey=shared.bound(ey,'y');r.dy=ey-by}}if(shared.autoRender){this.render()}pv.Mark.dispatch('select',drag.scene,drag.index,ev)},dragend:function(ev){var drag=ev.drag;try{pv.Mark.dispatch('selectend',drag.scene,drag.index,ev)}finally{var r=drag.d;delete r.drag}}};var mousedown=pv.Behavior.dragBase(shared);mousedown.collapse=function(x){if(arguments.length){collapse=String(x);switch(collapse){case"y":kx=1;ky=0;break;case"x":kx=0;ky=1;break;default:kx=1;ky=1;break}return mousedown}return collapse};mousedown.preserveLength=function(_){if(arguments.length){preserveLength=!!_;return mousedown}return preserveLength};return mousedown};pv.Behavior.resize=function(side){var preserveOrtho=false;var isLeftRight=(side==='left'||side==='right');var shared={dragstart:function(ev){var drag=ev.drag;drag.type='resize';var m1=drag.m1;var r=drag.d;r.drag=drag;switch(side){case"left":m1.x=r.x+r.dx;break;case"right":m1.x=r.x;break;case"top":m1.y=r.y+r.dy;break;case"bottom":m1.y=r.y;break}var parent=this.parent;drag.max={x:parent.width(),y:parent.height()};drag.min={x:0,y:0};pv.Mark.dispatch("resizestart",drag.scene,drag.index,ev)},drag:function(ev){var drag=ev.drag;var m1=drag.m1;var constraint=shared.positionConstraint;if(constraint){drag.m=drag.m.clone();constraint(drag)}var m=drag.m;var r=drag.d;if(!preserveOrtho||isLeftRight){var bx=Math.min(m1.x,m.x);var ex=Math.max(m.x,m1.x);bx=shared.bound(bx,'x');ex=shared.bound(ex,'x');r.x=bx;r.dx=ex-bx}if(!preserveOrtho||!isLeftRight){var by=Math.min(m1.y,m.y);var ey=Math.max(m.y,m1.y);bx=shared.bound(by,'y');ex=shared.bound(ey,'y');r.y=by;r.dy=ey-by}if(shared.autoRender){this.render()}pv.Mark.dispatch("resize",drag.scene,drag.index,ev)},dragend:function(ev){var drag=ev.drag;max=null;try{pv.Mark.dispatch('resizeend',drag.scene,drag.index,ev)}finally{var r=drag.d;delete r.drag}}};var mousedown=pv.Behavior.dragBase(shared);mousedown.preserveOrtho=function(_){if(arguments.length){preserveOrtho=!!_;return mousedown}return preserveOrtho};return mousedown};pv.Behavior.pan=function(){var scene,index,m1,v1,k,bound;function mousedown(){index=this.index;scene=this.scene;v1=pv.vector(pv.event.pageX,pv.event.pageY);m1=this.transform();k=1/(m1.k*this.scale);if(bound){bound={x:(1-m1.k)*this.width(),y:(1-m1.k)*this.height()}}}function mousemove(e){if(!scene)return;scene.mark.context(scene,index,function(){var x=(pv.event.pageX-v1.x)*k,y=(pv.event.pageY-v1.y)*k,m=m1.translate(x,y);if(bound){m.x=Math.max(bound.x,Math.min(0,m.x));m.y=Math.max(bound.y,Math.min(0,m.y))}this.transform(m).render()});pv.Mark.dispatch("pan",scene,index,e)}function mouseup(){scene=null}mousedown.bound=function(x){if(arguments.length){bound=Boolean(x);return this}return Boolean(bound)};pv.listen(window,"mousemove",mousemove);pv.listen(window,"mouseup",mouseup);return mousedown};pv.Behavior.zoom=function(speed){var bound;if(!arguments.length)speed=1/48;function mousewheel(e){var v=this.mouse(),k=pv.event.wheel*speed,m=this.transform().translate(v.x,v.y).scale((k<0)?(1e3/(1e3-k)):((1e3+k)/1e3)).translate(-v.x,-v.y);if(bound){m.k=Math.max(1,m.k);m.x=Math.max((1-m.k)*this.width(),Math.min(0,m.x));m.y=Math.max((1-m.k)*this.height(),Math.min(0,m.y))}this.transform(m).render();pv.Mark.dispatch("zoom",this.scene,this.index,e)}mousewheel.bound=function(x){if(arguments.length){bound=Boolean(x);return this}return Boolean(bound)};return mousewheel};pv.Geo=function(){};pv.Geo.projections={mercator:{project:function(latlng){return{x:latlng.lng/180,y:latlng.lat>85?1:latlng.lat<-85?-1:Math.log(Math.tan(Math.PI/4+pv.radians(latlng.lat)/2))/Math.PI}},invert:function(xy){return{lng:xy.x*180,lat:pv.degrees(2*Math.atan(Math.exp(xy.y*Math.PI))-Math.PI/2)}}},"gall-peters":{project:function(latlng){return{x:latlng.lng/180,y:Math.sin(pv.radians(latlng.lat))}},invert:function(xy){return{lng:xy.x*180,lat:pv.degrees(Math.asin(xy.y))}}},sinusoidal:{project:function(latlng){return{x:pv.radians(latlng.lng)*Math.cos(pv.radians(latlng.lat))/Math.PI,y:latlng.lat/90}},invert:function(xy){return{lng:pv.degrees((xy.x*Math.PI)/Math.cos(xy.y*Math.PI/2)),lat:xy.y*90}}},aitoff:{project:function(latlng){var l=pv.radians(latlng.lng),f=pv.radians(latlng.lat),a=Math.acos(Math.cos(f)*Math.cos(l/2));return{x:2*(a?(Math.cos(f)*Math.sin(l/2)*a/ Math.sin(a)) : 0) /Math.PI,y:2*(a?(Math.sin(f)*a/Math.sin(a)):0)/Math.PI}},invert:function(xy){var x=xy.x*Math.PI/2,y=xy.y*Math.PI/2;return{lng:pv.degrees(x/Math.cos(y)),lat:pv.degrees(y)}}},hammer:{project:function(latlng){var l=pv.radians(latlng.lng),f=pv.radians(latlng.lat),c=Math.sqrt(1+Math.cos(f)*Math.cos(l/2));return{x:2*Math.SQRT2*Math.cos(f)*Math.sin(l/2)/ c /3,y:Math.SQRT2*Math.sin(f)/c/1.5}},invert:function(xy){var x=xy.x*3,y=xy.y*1.5,z=Math.sqrt(1-x*x/16-y*y/4);return{lng:pv.degrees(2*Math.atan2(z*x,2*(2*z*z-1))),lat:pv.degrees(Math.asin(z*y))}}},identity:{project:function(latlng){return{x:latlng.lng/180,y:latlng.lat/90}},invert:function(xy){return{lng:xy.x*180,lat:xy.y*90}}}};pv.Geo.scale=function(p){var rmin={x:0,y:0},rmax={x:1,y:1},d=[],j=pv.Geo.projections.identity,x=pv.Scale.linear(-1,1).range(0,1),y=pv.Scale.linear(-1,1).range(1,0),c={lng:0,lat:0},lastLatLng,lastPoint;function scale(latlng){if(!lastLatLng||(latlng.lng!=lastLatLng.lng)||(latlng.lat!=lastLatLng.lat)){lastLatLng=latlng;var p=project(latlng);lastPoint={x:x(p.x),y:y(p.y)}}return lastPoint}function project(latlng){var offset={lng:latlng.lng-c.lng,lat:latlng.lat};return j.project(offset)}function invert(xy){var latlng=j.invert(xy);latlng.lng+=c.lng;return latlng}scale.x=function(latlng){return scale(latlng).x};scale.y=function(latlng){return scale(latlng).y};scale.ticks={lng:function(m){var lat,lng;if(d.length>1){var s=pv.Scale.linear();if(m==undefined)m=10;lat=s.domain(d,function(d){return d.lat}).ticks(m);lng=s.domain(d,function(d){return d.lng}).ticks(m)}else{lat=pv.range(-80,81,10);lng=pv.range(-180,181,10)}return lng.map(function(lng){return lat.map(function(lat){return{lat:lat,lng:lng}})})},lat:function(m){return pv.transpose(scale.ticks.lng(m))}};scale.invert=function(p){return invert({x:x.invert(p.x),y:y.invert(p.y)})};scale.domain=function(array,f){if(arguments.length){d=(array instanceof Array)?((arguments.length>1)?pv.map(array,f):array):Array.prototype.slice.call(arguments);if(d.length>1){var lngs=d.map(function(c){return c.lng});var lats=d.map(function(c){return c.lat});c={lng:(pv.max(lngs)+pv.min(lngs))/2,lat:(pv.max(lats)+pv.min(lats))/2};var n=d.map(project);x.domain(n,function(p){return p.x});y.domain(n,function(p){return p.y})}else{c={lng:0,lat:0};x.domain(-1,1);y.domain(-1,1)}lastLatLng=null;return this}return d};scale.range=function(min,max){if(arguments.length){if(typeof min=="object"){rmin={x:Number(min.x),y:Number(min.y)};rmax={x:Number(max.x),y:Number(max.y)}}else{rmin={x:0,y:0};rmax={x:Number(min),y:Number(max)}}x.range(rmin.x,rmax.x);y.range(rmax.y,rmin.y);lastLatLng=null;return this}return[rmin,rmax]};scale.projection=function(p){if(arguments.length){j=typeof p=="string"?pv.Geo.projections[p]||pv.Geo.projections.identity:p;return this.domain(d)}return p};pv.copyOwn(scale,pv.Scale.common);if(arguments.length)scale.projection(p);return scale};