(function(){var _nextTipsyId=0;pv.Behavior.tipsy=function(opts){var _tipsyId=_nextTipsyId++;if(!opts){opts={}}else{opts=Object.create(opts)}opts.trigger='manual';var _userGravity=opts.gravity||$.fn.tipsy.defaults.gravity;var _userGravityFun;if(typeof _userGravity==='function'){_userGravityFun=_userGravity;_userGravity=null}opts.gravity=calculateGravity;var $fakeTipTarget,$targetElem,nextOperationId=0,prevMouseX,prevMouseY,_renderId,_mark,delayOut=opts.delayOut,id,usesPoint=opts.usesPoint,$canvas,isEnabled=opts.isEnabled,sharedTipsyInfo;opts.delayOut=0;function getTooltipText(){var instance=_mark.instance();var title=(instance&&instance.tooltip)||(!_mark.properties.tooltip&&typeof _mark.tooltip=='function'&&_mark.tooltip())||instance.title||instance.text;if(typeof title==='function'){title=title()}return title||""}function getInstanceBounds(){var instance=_mark.instance();var left,top,width,height;if(_mark.properties.width){var bounds=getVisibleScreenBounds(_mark);left=bounds.left;top=bounds.top;width=bounds.width;height=bounds.height}else{var t=_mark.toScreenTransform();var radius;if(_mark.properties.outerRadius){var midAngle=instance.startAngle+instance.angle/2;radius=instance.outerRadius;left=t.x+instance.left+radius*Math.cos(midAngle);top=t.y+instance.top+radius*Math.sin(midAngle)}else if(_mark.properties.shapeRadius){radius=Math.max(2,instance.shapeRadius);var cx=instance.left;var cy=instance.top;switch(instance.shape){case'diamond':radius*=Math.SQRT2;break;case'circle':radius/=Math.SQRT2;break}left=(cx-radius)*t.k+t.x;top=(cy-radius)*t.k+t.y;height=width=2*radius*t.k}else{left=instance.left*t.k+t.x;top=instance.top*t.k+t.y}}var left2=Math.ceil(left);var top2=Math.ceil(top);var leftE=left2-left;var topE=top2-top;width=Math.max(1,Math.floor((width||0)-leftE));height=Math.max(1,Math.floor((height||0)-topE));return{left:left2,top:top2,width:width,height:height}}var _gravities=['nw','n','ne','e','se','s','sw','w'];function updateUserGravity(){if(_userGravityFun){_userGravity=_userGravityFun.call(_mark)||$.fn.tipsy.defaults.gravity}return _userGravity}function calculateGravity(tipSize,calcPosition){(this===$fakeTipTarget[0])||def.assert();var $win=$(window);var scrollOffset={width:$win.scrollLeft(),height:$win.scrollTop()};var pageSize={width:$win.width(),height:$win.height()};var gravity=_userGravity;if(gravity==='c'){gravity='w'}var bestScore=scoreGravity(gravity);if(!bestScore.isTotal){var g=_gravities.indexOf(gravity);for(var n=1,L=_gravities.length;n<L;n++){var i=(g+n)%L;bestScore=chooseScores(bestScore,scoreGravity(_gravities[i]))}if(_tip.debug>=6&&gravity!==bestScore.gravity){_tip.log("[TIPSY] #"+_tipsyId+" Choosing gravity '"+bestScore.gravity+"' over '"+gravity+"'")}gravity=bestScore.gravity}if(_tip.debug>=6){_tip.log("[TIPSY] #"+_tipsyId+" Gravity '"+gravity+"'")}return gravity;function scoreGravity(gravity){var tp=calcPosition(gravity);return scorePosition(gravity,tp)}function scorePosition(gravity,tp){var wScore=calcPosScore(tp.left,'width');var hScore=calcPosScore(tp.top,'height');var isTotal=wScore.fits&&hScore.fits;return{gravity:gravity,width:wScore,height:hScore,value:wScore.value+hScore.value+(2-gravity.length),isTotal:isTotal,isPartial:!isTotal&&(wScore.fits||hScore.fits)}}function calcPosScore(absPos,a_len){var maxLen=pageSize[a_len];var len=tipSize[a_len];var pos=absPos-scrollOffset[a_len];var opos=maxLen-(pos+len);var fits=pos>=0&&opos>=0;var value=(pos>=0?pos:(4*pos))+(opos>=0?opos:(4*opos));return{fits:fits,value:value}}}function chooseScores(score1,score2){if(score1.isTotal){if(!score2.isTotal){return score1}}else if(score2.isTotal){if(!score1.isTotal){return score2}}else if(score1.isPartial){if(!score2.isPartial){return score1}}else if(score2.isPartial){if(!score1.isPartial){return score2}}return score2.value>score1.value?score2:score1}function setFakeTipTargetBounds(bounds){$fakeTipTarget.css({left:bounds.left+parseFloat($canvas.css("padding-left")),top:bounds.top+parseFloat($canvas.css("padding-top")),width:bounds.width,height:bounds.height})}function createTipsy(mark){var c=mark.root.canvas();$canvas=$(c);c.style.position="relative";$canvas.mouseleave(hideTipsy);initTipsyCanvasSharedInfo();if(!id){id="tipsyPvBehavior_"+new Date().getTime()}var fakeTipTarget=document.getElementById(id);if(!fakeTipTarget){fakeTipTarget=document.createElement("div");fakeTipTarget.id=id;c.appendChild(fakeTipTarget)}var fakeStyle=fakeTipTarget.style;fakeStyle.padding='0px';fakeStyle.margin='0px';fakeStyle.position='absolute';fakeStyle.pointerEvents='none';fakeStyle.display='block';fakeStyle.zIndex=-10;$fakeTipTarget=$(fakeTipTarget);updateTipDebug();$fakeTipTarget.data('tipsy',null);$fakeTipTarget.tipsy(opts)}function initTipsyCanvasSharedInfo(){sharedTipsyInfo=$canvas.data('tipsy-pv-shared-info');if(sharedTipsyInfo){var createId=($canvas[0].$pvCreateId||0);if(sharedTipsyInfo.createId===createId){sharedTipsyInfo.behaviors.push(hideTipsyOther);return}sharedTipsyInfo.behaviors.forEach(function(aHideTipsy){aHideTipsy()})}sharedTipsyInfo={createId:($canvas[0].$pvCreateId||0),behaviors:[hideTipsyOther]};$canvas.data('tipsy-pv-shared-info',sharedTipsyInfo)}function updateTipDebug(){if($fakeTipTarget){if(_tip.debug>=16){$fakeTipTarget.css({borderColor:'red',borderWidth:'1px',borderStyle:'solid',zIndex:1000})}else{$fakeTipTarget.css({borderWidth:'0px',zIndex:-10})}}}function getMouseBounds(ev){if(!ev){ev=pv.event}var delta=5;var offset=$canvas.offset();return{left:ev.pageX-offset.left-delta,top:ev.pageY-offset.top-delta,width:10+2*delta,height:20}}function setTarget(targetElem,mark){if((!$targetElem&&targetElem)||($targetElem&&$targetElem[0]!==targetElem)){if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Changing target element.")}if($targetElem){$targetElem.unbind('mousemove',updateTipsy);if(!usesPoint){$targetElem.unbind('mouseleave',hideTipsy)}}$targetElem=targetElem?$(targetElem):null;_mark=targetElem?mark:null;prevMouseX=prevMouseY=_renderId=null;if($targetElem){$targetElem.mousemove(updateTipsy);if(!usesPoint){$targetElem.mouseleave(hideTipsy)}}}}function getNewOperationId(){return nextOperationId++}function checkCanOperate(opId){return opId===nextOperationId-1}function hideTipsy(){var opId=getNewOperationId();if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Delayed Hide Begin opId="+opId)}if(delayOut>0){window.setTimeout(function(){if(checkCanOperate(opId)){if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Hiding opId="+opId+" nextOperationId="+nextOperationId)}hideTipsyCore(opId)}else{if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Delayed Hide Cancelled opId="+opId)}}},delayOut);return}if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Hiding Immediately opId="+opId)}hideTipsyCore(opId)}function hideTipsyOther(){var opId=getNewOperationId();if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Hiding as Other opId="+opId)}hideTipsyCore(opId)}function hideTipsyCore(opId){setTarget(null,null);if($fakeTipTarget){$fakeTipTarget.tipsy("leave")}}function hideOtherTipsies(){var hideTipsies=sharedTipsyInfo&&sharedTipsyInfo.behaviors;if(hideTipsies&&hideTipsies.length>1){hideTipsies.forEach(function(aHideTipsy){if(aHideTipsy!==hideTipsyOther){aHideTipsy()}})}}function updateTipsy(ev){if(!$fakeTipTarget){return}if(prevMouseX!=null&&Math.abs(ev.clientX-prevMouseX)<3&&Math.abs(ev.clientY-prevMouseY)<3){return}var tag=this.$scene;var scenes;if(!tag||!(scenes=tag.scenes)||!scenes.mark||(scenes.mark!==_mark)){return}var renderId=_mark.renderId();var renderIdChanged=(renderId!==_renderId);var followMouse=opts.followMouse;if(!followMouse&&!renderIdChanged){return}var opId=getNewOperationId();if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Updating opId="+opId)}prevMouseX=ev.clientX;prevMouseY=ev.clientY;var bounds;if(followMouse){bounds=getMouseBounds(ev)}if(renderIdChanged){_renderId=renderId;_mark.context(scenes,tag.index,function(){if(!followMouse){bounds=getInstanceBounds()}var text=getTooltipText();if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Update text. Was hidden. Text: "+text)}$fakeTipTarget.tipsy('setTitle',text);updateUserGravity()})}setFakeTipTargetBounds(bounds);hideOtherTipsies();$fakeTipTarget.tipsy("update")}function initBehavior(mark){if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Creating")}createTipsy(mark);if(usesPoint){mark.event('unpoint',hideTipsy)}}function showTipsy(mark){var opId=getNewOperationId();if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Show IN opId="+opId)}if(!$canvas){initBehavior(mark)}var isHidden=!$targetElem;setTarget(pv.event.target,mark);var text=getTooltipText();if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Text: "+text)}$fakeTipTarget.tipsy('setTitle',text);setFakeTipTargetBounds(opts.followMouse?getMouseBounds():getInstanceBounds());updateUserGravity();hideOtherTipsies();if(isHidden){$fakeTipTarget.tipsy('enter')}else{$fakeTipTarget.tipsy('update')}if(_tip.debug>=4){_tip.log("[TIPSY] #"+_tipsyId+" Show OUT")}}function tipsyBehavior(){var mark=this;if(!isEnabled||isEnabled(tipsyBehavior,mark)){showTipsy(mark)}}return tipsyBehavior};var _tip=pv.Behavior.tipsy;_tip.debug=0;_tip.setDebug=function(level){_tip.debug=level};_tip.log=function(m){if(typeof console!=="undefined"){console.log(''+m)}};function toParentTransform(parentPanel){return pv.Transform.identity.translate(parentPanel.left(),parentPanel.top()).times(parentPanel.transform())}function getVisibleScreenBounds(mark){var instance=mark.instance(),left=instance.left,top=instance.top,width=instance.width,height=instance.height,right,bottom,parent;while((parent=mark.parent)){if(left<0){width+=left;left=0}if(top<0){height+=top;top=0}right=instance.right;if(right<0){width+=right}bottom=instance.bottom;if(bottom<0){height+=bottom}var t=toParentTransform(parent),s=t.k;left=t.x+(s*left);top=t.y+(s*top);width=s*width;height=s*height;mark=parent;instance=mark.instance()}return{left:left,top:top,width:width,height:height}}}());